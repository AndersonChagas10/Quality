@using PlanoAcaoCore
<div class="form-content" style="display:none;">
    <form class="form" role="form">
        <div class="form-group">
            <label>@Resources.Resource.user</label>
            <input type="text" class="form-control" id="Name" name="Name" placeholder="@Resources.Resource.type_user" value="">
        </div>
        <div class="form-group">
            <label>@Resources.Resource.password</label>
            <input type="password" class="form-control" id="Password" name="Password" placeholder="@Resources.Resource.type_password">
        </div>
        <label class="alert-warning" id="resultado"></label>
        <br />
        <label class="alert-warning" id="resultado1"></label>
        @*<div class="checkbox">
                <label>
                    <input type="checkbox"> Check me out
                </label>
            </div>*@
    </form>
</div>
@{
    var path = @Url.Content("~/Imagens/Logo.png");

}
<script>

    /*Aux*/
    var interval = 3000;
    var intervalLabels = 4000;
    var checkSessionControl;
    var identy = {};
    /*Aux END*/

    /*Config Modal*/
    var modalLogin = bootbox.dialog({
        message: $(".form-content").html(),
        title: "<div class='' style='display:inline-block; padding:2px;'><img src='@path' style='height:45px;' /> @Resources.Resource.plan_action_authentication </div> ",
        size: 'small',
        buttons: [
          {
              label: "@Resources.Resource.send",
              className: "btn btn-primary pull-left",
              //callback: function () {

              //    var user = $('#formLogin form').serializeObject();
              //    if (!user.Name.length) {
              //        $('#formLogin #resultado').text('O campo nome é obrigatório.').fadeIn().fadeOut(2000, "swing");
              //    }
              //    if (!user.Password.length) {
              //        $('#formLogin #resultado1').text('O senha nome é obrigatório.').fadeIn().fadeOut(2000, "swing");
              //    }
              //    if (user.Name.length && user.Password.length) {
              //        loginPaSgq(user);
              //    }
              //    return false;

              //}
          },
        ],
        show: false,
        onEscape: function () {
            //modalLogin.modal("hide");
        },
        closeButton: false,
    });
    modalLogin.attr("id", "formLogin");
    modalLogin.find('.modal-content').css("margin-top", "15%")
    modalLogin.find('.bootbox-body').css("height", "190px");
    /*Config Modal END*/

    /*Trigger*/
    function checkSession() {
        if (!getCookie('webControlCookie')) {
            modalLogin.modal("show");
            blurNele($('#RederBodyContainer'));
            $('#formLogin .modal-footer button').show();
            atribuiClickBtnModal();
        }
        //else
        //    console.log('LoginPA puro')
        //console.log("checkSession: " + Date().toString())
    }
    /*Trigger END*/

    /*PA*/
    var urlCookie = '@Url.Action("GetUserCookie", "api/Pa_User")';
    var urlMaster = '@Html.Raw(Conn.SgqHost)';
    var isSgqIntegrado = '@Html.Raw(Conn.isSgqIntegrado)';

    function loginPaSgq(user) {
        $.LoadingOverlay('show');
        user['IsWeb'] = true;
        if (isSgqIntegrado) {
            //$.ajax({
            //    url: urlMaster,
            //    type: 'POST',
            //    data: user,
            //    success: function (r) {
            //        $.LoadingOverlay('hide')
            //        if (r.length == 0) {
            //            //console.log(r);
            //            removeBlur();
            //            clearInterval(checkSessionControl);//DESLIGA VERIFICAÇÃO ATÉ QUE RECEBA O COOKIE DEVOLTA
            //            modalLogin.modal("hide");
            //            createUpdateCookie(r.Retorno);
            //            identy = user;
            //        }
            //        else {
            //            $('#formLogin #resultado').text('Usuário ou Senha inválidos.').fadeIn().fadeOut(intervalLabels, "swing");
            //            console.log(r);
            //        }
            //        removeBlur();
            //        clearInterval(checkSessionControl);//DESLIGA VERIFICAÇÃO ATÉ QUE RECEBA O COOKIE DEVOLTA
            //        modalLogin.modal("hide");
            //        createUpdateCookie(r.Retorno);
            //        identy = user;
            //    },
            //    error: function (jqXHR, exception) {
            //        var msg = '';
            //        if (jqXHR.status === 0) {
            //            msg = 'Not connect.\n Verify Network.';
            //        } else if (jqXHR.status == 404) {
            //            msg = 'Requested page not found. [404]';
            //        } else if (jqXHR.status == 500) {
            //            msg = 'Internal Server Error [500].';
            //        } else if (exception === 'parsererror') {
            //            msg = 'Requested JSON parse failed.';
            //        } else if (exception === 'timeout') {
            //            msg = 'Time out error.';
            //        } else if (exception === 'abort') {
            //            msg = 'Ajax request aborted.';
            //        } else {
            //            msg = 'Uncaught Error.\n' + jqXHR.responseText;
            //        }
            //        toastr.info(msg)
            //    },
            //});

            $.post(urlMaster, user, function (r) {
                $.LoadingOverlay('hide')
                if (r.MensagemExcecao) {
                    $('#formLogin #resultado').text('@Resources.Resource.username_password_invalid').fadeIn().fadeOut(intervalLabels, "swing");
                }
                else if (r.errors) {
                    //console.log(r);
                    $('#formLogin #resultado').text('@Resources.Resource.username_password_invalid').fadeIn().fadeOut(intervalLabels, "swing");
                    console.log(r);
                } else {
                    removeBlur();
                    clearInterval(checkSessionControl);//DESLIGA VERIFICAÇÃO ATÉ QUE RECEBA O COOKIE DEVOLTA
                    modalLogin.modal("hide");
                    createUpdateCookie(r.Retorno);
                    //window.location.href = '/';
                    identy = r.user;
                    if ($('#sasenhora:visible').length > 0)
                        setTimeout(function () {
                            GetDataTable();
                            console.log('geraTable');
                        }, 500)
                }
            });
            //} else {
            //    //LOGIN PA PURO
            //}
        }
    }

    function createUpdateCookie(dto) {
        $.post(urlCookie, dto, function (r, a, xhr) {
            xhr.getResponseHeader('Set-Cookie');
            atribuiInterval();
		if(!(window.location.href.indexOf('FTA') > 0))
	            window.location = '@Url.Action("","")'
            //GetDataTable(); //Gambiarra do renan
        });
    }

    function atribuiInterval() {
        checkSession();
        clearInterval(checkSessionControl);
        checkSessionControl = setInterval(checkSession, interval);
    }

    function atribuiClickBtnModal() {

        $('#formLogin').children().attr('style', 'width: 350px !important');

        $('#formLogin  > div > div > div.modal-footer > button').off('click').on('click', function () {

            var user = $('#formLogin form').serializeObject();
            if (!user.Name.length) {
                $('#formLogin #resultado').text('@Resources.Resource.name_field_required').fadeIn().fadeOut(intervalLabels, "swing");
            }
            if (!user.Password.length) {
                $('#formLogin #resultado1').text('@Resources.Resource.password_field_required').fadeIn().fadeOut(intervalLabels, "swing");
            }
            if (user.Name.length && user.Password.length) {
                loginPaSgq(user);
            }
            return false;
        });
    }

    function blurNele(element){
        element.blurjs({
            customClass: 'blurjs',
            radius: 5,
            persist: false
        });
    }

    function removeBlur() {
        $.blurjs('reset')
    }

    $(function () {
        atribuiClickBtnModal();
        atribuiInterval();
    })

</script>
