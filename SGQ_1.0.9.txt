
Insert into MigrationHistory (Name, AddDate) VALUES ('20190120_CriacaoDepartamento',GetDate())

IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='ParLevel3XParDepartment' AND xtype='U')
CREATE TABLE ParLevel3XParDepartment(
	[Id] [int] IDENTITY(1,1) NOT NULL primary key,
	[ParDepartment_Id] [int] NOT NULL FOREIGN KEY REFERENCES ParDepartment(Id),
	[ParLevel1_Id] [int] NULL FOREIGN KEY REFERENCES ParLevel1(Id),
	[ParLevel2_Id] [int] NULL FOREIGN KEY REFERENCES ParLevel2(Id),
	[ParLevel3_Id] [int] NULL FOREIGN KEY REFERENCES ParLevel3(Id),
	[ParCompany_Id] [int] NULL FOREIGN KEY REFERENCES ParCompany(Id),
	[AddDate] [datetime] NOT NULL,
	[AlterDate] [datetime] NULL,
	[IsActive] [bit] NOT NULL DEFAULT ((1))
)

GO
 
 IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='CollectionLevel2XParDepartment' AND xtype='U')
 create table CollectionLevel2XParDepartment (
	Id int primary key identity not null,
	AddDate datetime not null,
	AlterDate datetime,
	CollectionLevel2_Id int foreign key references CollectionLevel2(Id),
	ParDepartment_Id int not null foreign key references ParDepartment(Id)
)

GO

 IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='ConsolidationLevel2XParDepartment' AND xtype='U')
 create table ConsolidationLevel2XParDepartment (
	Id int primary key identity not null,
	AddDate datetime not null,
	AlterDate datetime,
	ConsolidationLevel2_Id int foreign key references ConsolidationLevel2(Id),
	ParDepartment_Id int not null foreign key references ParDepartment(Id)
)

GO

 IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='ConsolidationLevel1XParDepartment' AND xtype='U')
 create table ConsolidationLevel1XParDepartment (
	Id int primary key identity not null,
	AddDate datetime not null,
	AlterDate datetime,
	ConsolidationLevel1_Id int foreign key references ConsolidationLevel1(Id),
	ParDepartment_Id int not null foreign key references ParDepartment(Id)
)


GO

Insert into MigrationHistory (Name, AddDate) VALUES ('20190301_CriarRotinaIntegracao',GetDate())

GO

 IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='RotinaIntegracao' AND xtype='U')
CREATE TABLE RotinaIntegracao (
    ID int NOT NULL Identity,
    DataSource varchar(100) NOT NULL,
    InitialCatalog  varchar(100),
	AddDate datetime not null,
	AlterDate datetime,
	[User]  varchar(50),
	[Password] varchar(50),
	IsActive bit not null default 1,
	query varchar(MAX),
	Parametro  varchar(900),
	Nome  varchar(255),
    PRIMARY KEY (ID)
);

GO

 IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='ParLevel1XRotinaIntegracao' AND xtype='U')
CREATE TABLE ParLevel1XRotinaIntegracao (
  ID int NOT NULL Identity,
  Nome  varchar(100),
  ParLevel1_Id  int,
  AddDate datetime not null,
  AlterDate datetime,
  RotinaIntegracao_Id int,
  IsActive bit not null default 1,
  FOREIGN KEY (RotinaIntegracao_Id) REFERENCES RotinaIntegracao(ID),
  FOREIGN KEY (ParLevel1_Id) REFERENCES ParLevel1(ID),
  PRIMARY KEY (ID)
);

GO

IF NOT EXISTS (SELECT * FROM ParFieldType  WHERE Name = 'Parâmetro')
insert into ParFieldType(Id,Name, description, addDate, IsActive) values (9,'Parâmetro', 'Parâmetro', GetDate(), 1)

GO

IF NOT EXISTS (SELECT * FROM ParFieldType  WHERE Name = 'Dinâmico')
insert into ParFieldType(Id,Name, description, addDate, IsActive) values (10,'Dinâmico ', 'Dinâmico ', GetDate(), 1)

GO

IF COL_LENGTH('RotinaIntegracao','Retornos') IS NULL
    BEGIN	
		ALTER TABLE RotinaIntegracao ADD Retornos varchar(250);
    END

GO

IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='IntegracaoSistemica' AND xtype='U')
create table IntegracaoSistemica(
	Id int not null identity primary key,
	Name varchar(20) NOT NULL,
	Configuration varchar(255) NOT NULL,
	Script text NOT NULL,
	TableName varchar(50) NOT NULL,
	Intervalo int NOT NULL,
	AddDate datetime not null,
	AlterDate datetime null,
	IsActive bit not null default 1
)

GO

IF EXISTS (
SELECT  schema_name
FROM    information_schema.schemata
WHERE   schema_name = 'INTEG' ) 
 
	BEGIN
	
		IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='CollectionData' AND xtype='U')
		CREATE TABLE INTEG.CollectionData
		(
			Table_Id			INT NULL,
			Key_Integ			VARCHAR(500),
			ParLevel1_id		INT NULL,
			ParLevel2_id		INT NULL,
			ParLevel3_id		INT NULL,
			ParCompany_id		INT NULL,
			[Weight]			DECIMAL(38,10) NULL,
			Value				DECIMAL(38,10) NULL,
			ValueText			VARCHAR(500)   NULL,
			MinInterval			DECIMAL(38,10) NULL,
			MaxInterval			DECIMAL(38,10) NULL,
			IsConform			BIT NULL,
			IsNotEvaluate		BIT NULL,
			Evaluation			DECIMAL(38,10) NULL,
			[Sample]			INT NULL,
			WeiEvaluation		DECIMAL(38,10) NULL,
			Defects				DECIMAL(38,10) NULL,
			WeiDefects			DECIMAL(38,10) NULL,
			Coletado			INT NULL
		)

		IF COL_LENGTH('Integ.CollectionData','CollectionDate') IS NULL
			alter table Integ.CollectionData
			add CollectionDate Datetime null

	END
GO
