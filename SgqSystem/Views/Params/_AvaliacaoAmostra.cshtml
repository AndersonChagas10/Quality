@model SgqSystem.ViewModels.ParamsViewModel
@using SgqSystem.Helpers

@{
    var level = Model.levelControl;
    var id = "level" + Model.levelControl + "_AvAmostra_accordion";
    var id2 = "#level" + Model.levelControl + "__AvAmostra_accordion";
    var id3 = "#level" + Model.levelControl + "__AvAmostra_collapse";
    var id4 = "level" + Model.levelControl + "__AvAmostra_collapse";
    var click = "AvAm" + Model.levelControl + ".adiciona($(this))";
    //var click = "alert();";
}

<style>

    #tabelaAgendamento td {
        white-space: nowrap;
    }

    #tabelaAgendamento input {
        width: 140px;
    }
</style>

<div class="panel-group accordion" id="@id">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="@id2" href="@id3" aria-expanded="false"> @Resources.Resource.evaluation_and_sample</a>
            </h4>
        </div>
        <div id="@id4" class="panel-collapse collapse" aria-expanded="false" style="height: 0px;">
            <div class="panel-body">

                <table class="table-erp" id="">

                    <tbody>

                        <tr>

                            @Table.GerarColuna(@Html.DropDownList("avAmCompany", Model.paramsDdl.DdlParCompany, htmlAttributes: new { @class = "form-control input-sm", @id = "avAmCompany" })
                                , @Html.Label(Resources.Resource.company)
                                , Table.PosicaoLabel.top)

                            <td class="td-erp col-sm-4">
                                <label for="paramsDto.parLevel1Selected">@Resources.Resource.level1</label>
                                <div>
                                    @Html.DropDownList("paramsDto.parLevel1Selected", new List<SelectListItem> { }, htmlAttributes: new { @class = "form-control select2", @id = "parLevel1Select2AmostraLevel", style = "width: 100%" })
                                </div>
                            </td>
                            <td class="td-erp col-sm-4">
                                <label for="paramsDto.parClusterSelected">@Resources.Resource.cluster</label>
                                <div>
                                    @Html.DropDownList("paramsDto.parClusterSelected", Model.paramsDdl.DdlparCluster, htmlAttributes: new { @class = "form-control select2", @id = "parClusterSelect2AmostraLevel", style = "width: 100%" })
                                </div>
                            </td>
                        </tr>
                        <tr>

                            @Html.HiddenFor(r => r.paramsDto.parEvaluationDto.Id)
                            @Table.GerarColuna(@Html.TextBox("avaliacao", 0, htmlAttributes: new { @id = "avaliacao", @class = "form-control input-sm", type = "number", min = "0" })
                                , @Html.Label(Resources.Resource.evaluation)
                                , Table.PosicaoLabel.top)

                            @Html.HiddenFor(r => r.paramsDto.parSampleDto.Id)
                            @Table.GerarColunaButton(@Html.TextBox("amostra", 0, htmlAttributes: new { @id = "amostra", @class = "form-control input-sm", type = "number", min = "0" })
                                , @Html.Label(Resources.Resource.samples_per_evaluation)
                                , Table.PosicaoLabel.top
                                , button: "<button type=\"button\" class=\"btn btn-primary btn-sm\" onclick='" + @click + ";' id=\"\"><i class=\"fa fa-plus\" aria-hidden=\"true\"></i></button>")

                        </tr>
                    </tbody>
                </table>

                <table id="tableAvAm" class="table table-condensed table-responsive no-margin margin-top" nameModal="Editar Avaliação e Amostra:">
                    <thead>
                        <tr>
                            <th>@Resources.Resource.company</th>
                            <th>@Resources.Resource.level1</th>
                            <th>@Resources.Resource.cluster</th>
                            <th>@Resources.Resource.evaluation</th>
                            <th>@Resources.Resource.samples / @Resources.Resource.evaluation</th>
                            <th>@Resources.Resource.scheduling</th>
                            <th class="options"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <div class="modal fade" id="modalAgendamento" role="dialog">
                    <div class="modal-dialog modal-lg vertical-align-center">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Agendamento</h4>
                            </div>
                            <div class="modal-body">
                                <input class="hidden" data-column="inpAvaliacaoId" />
                                <div style="overflow:auto;">
                                    <table id="tabelaAgendamento" style="display:block !important;max-width: 100%;" class="table table-condensed no-margin margin-top">
                                        <thead>
                                            <tr>
                                                <th>Tipo de Frequência</th>
                                                <th>Inicio</th>
                                                <th>Fim</th>
                                                <th>Avaliação</th>
                                                <th>Turno</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                @*<button type="button" data-dismiss="modal" id="btnSalvarAgendamento" class="btn btn-success">Salvar</button>*@
                                <button type="button" data-dismiss="modal" onclick="LimpaCampos()" class="btn btn-default">Fechar</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>

    var botaoAgendamento = '';
    //function changeCompanyAvAm() {

    var levelControl = @Html.Raw(Json.Encode(@Model.levelControl))

    function atribuiLevelDivAvAm (){

        var paramsDto = @Html.Raw(Json.Encode(@Model.paramsDto))
        var levelDomain;
        var listSalvo;

        if(levelControl == 2){
            levelDomain = "newLevel2Modal";
            listSalvo = paramsDto.parLevel2Dto.listParLevel2SampleEvaluationDTO;//
            AvAm2 = getCounterObject(levelDomain, listSalvo);//
            AvAm2.carregaDadosDoDb();//
        }

    }

    atribuiLevelDivAvAm();

    function getCounterObject (levelDomain, listSalvo) {
        return {
            /*Setup*/
            levelControl: levelControl,
            level: levelDomain,
            listObjSalvo: listSalvo,
            idTable: 'tableAvAm',//
            tdsNames: ['companyName', 'ParLevel1_Name', 'ParCluster_Name','evaluationNumber', 'sampleNumber', 'agendamento','btn'],
            getObjAdd: function (isEdit, obj) {
                debugger
                if(isEdit != undefined){
                    var compId = $('#' + isEdit + ' #avAmCompany :selected').val();
                    var compName = $('#' + isEdit + ' #avAmCompany :selected').text();
                    if(compId == "-1"){
                        compName = "@Resources.Resource.all"
                    }
                    obj.companyId = compId;
                    obj.companyName = compName;
                    obj.sampleNumber = $('#' + isEdit + ' #amostra').val();
                    obj.evaluationNumber = $('#' + isEdit + ' #avaliacao').val();
                    return obj;
                }else{
                    var compId = $('#' + this.level + ' #avAmCompany :selected').val();
                    var compName = $('#' + this.level + ' #avAmCompany :selected').text();
                    if(compId == "-1"){
                        compName = "@Resources.Resource.all"
                    }

                    var ParLevel1_Id = $(' #parLevel1Select2AmostraLevel :selected').val();
                    var ParLevel1_Name = $(' #parLevel1Select2AmostraLevel :selected').text();
                    if(ParLevel1_Id == "-1"){
                        ParLevel1_Name = "@Resources.Resource.all"
                    }

                    var ParCluster_Id = $(' #parClusterSelect2AmostraLevel :selected').val();
                    var ParCluster_Name = $(' #parClusterSelect2AmostraLevel :selected').text();
                    if(ParCluster_Id == "-1"){
                        ParCluster_Name = "@Resources.Resource.all"
                    }

                    return {/*Objeto*/
                        sampleNumber     :  $('#' + this.level + ' #amostra').val(),
                        evaluationNumber    : $('#' + this.level + ' #avaliacao').val(),
                        companyId  :  compId,
                        companyName  : compName,
                        ParLevel1_Id : ParLevel1_Id,
                        ParLevel1_Name : ParLevel1_Name,
                        ParCluster_Id : ParCluster_Id,
                        ParCluster_Name : ParCluster_Name,
                        IsActive: true
                    }
                }
            },
            veifyAdd: function(isEdit) {
                var seletorTato = !!isEdit ? isEdit : this.level;

                /*Valida se pode criar o objeto*/
                if($('#' + seletorTato + ' #amostra').val().length == 0){
                    openMessageModal('@Resources.Resource.invalid_samples_number');
                    return false;
                }
                if($('#' + seletorTato + ' #avaliacao').val().length == 0){
                    openMessageModal('@Resources.Resource.invalid_evaluations_number');
                    return false;
                }

                function verify(data){
                    return (data == 0 || data == -1 || data == null) ? 1 : 0;
                }
                /*Verifica Unidade*/
                var companySelected = $('#' + seletorTato + ' #avAmCompany :selected').val();//
                var display = $('#' + seletorTato + ' #avAmCompany :selected').text();//
                var parLevel1Selected = $('#' + seletorTato + ' #parLevel1Select2AmostraLevel :selected').val();
                var parClusterSelected = $('#' + seletorTato + ' #parClusterSelect2AmostraLevel :selected').val();
                var exist = $.grep($('#tableAvAm  tbody  tr  td:nth-child(1)'), function(o, c){//
                    var count = 0;
                    if(companySelected == -1){
                        count += verify($(o).parent().data().companyId);
                    }else{
                        count += $(o).parent().data().companyId == companySelected ? 1 : 0;
                    }

                    if(parLevel1Selected == -1){
                        count += verify($(o).parent().data().ParLevel1_Id);
                    }else{
                        count += $(o).parent().data().ParLevel1_Id == parLevel1Selected ? 1 : 0;
                    }

                    if(parClusterSelected == -1){
                        count += verify($(o).parent().data().ParCluster_Id);
                    }else{
                        count += $(o).parent().data().ParCluster_Id == parClusterSelected ? 1 : 0;
                    }

                    if(count == 3)
                        return true;
                    return false;
                });

                if(!!isEdit){/*Edição*/

                } else {/*Inclusão*/
                    if(exist.length){

                        if(companySelected == -1)
                            display= "@Resources.Resource.all";

                        openMessageModal("@Resources.Resource.data_already_register_on_company"+" " + display + ".", "")
                        return false;

                    }
                }

                return true;
            },
            incluiNoObjetoParaSubmit: function(dados){

                var level = this.levelControl;
                $('#' + this.level + ' #' + this.idTable + ' > tbody > tr ').each(function(c, obj){

                    var o = $(obj).data();
                    //#edit
                    if((o.Id != null || o.Id != undefined) && o.Id > 0){
                        dados["paramsDto.parLevel" + level + "Dto.listParLevel2SampleEvaluationDTO[" + c + "].Id"] = o.Id;
                    }

                    if((o.sampleId != null || o.sampleId != undefined) && o.sampleId > 0){
                        dados["paramsDto.parLevel" + level + "Dto.listParLevel2SampleEvaluationDTO[" + c + "].sampleId"] = o.sampleId;
                    }

                    if((o.evaluationId != null || o.evaluationId != undefined) && o.evaluationId > 0){
                        dados["paramsDto.parLevel" + level + "Dto.listParLevel2SampleEvaluationDTO[" + c + "].evaluationId"] = o.evaluationId;
                    }

                    dados["paramsDto.parLevel" + level + "Dto.listParLevel2SampleEvaluationDTO[" + c + "].ParLevel1_Id"] = o.ParLevel1_Id;
                    dados["paramsDto.parLevel" + level + "Dto.listParLevel2SampleEvaluationDTO[" + c + "].ParCluster_Id"] = o.ParCluster_Id;
                    dados["paramsDto.parLevel" + level + "Dto.listParLevel2SampleEvaluationDTO[" + c + "].sampleNumber"] = o.sampleNumber;
                    dados["paramsDto.parLevel" + level + "Dto.listParLevel2SampleEvaluationDTO[" + c + "].evaluationNumber"] = o.evaluationNumber;
                    dados["paramsDto.parLevel" + level + "Dto.listParLevel2SampleEvaluationDTO[" + c + "].companyId"] = o.companyId;
                    dados["paramsDto.parLevel" + level + "Dto.listParLevel2SampleEvaluationDTO[" + c + "].IsActive"] = o.IsActive;

                });

            },
            carregaDadosDoDb: function () {
                debugger
                var id = this.level + ' #' + this.idTable;
                var tdNamess = this.tdsNames;

                if( this.listObjSalvo != null){ /*Carrega regras de NC*/
                    this.listObjSalvo.forEach(function(o, c){
                        if(o.companyId != null && o.companyId != "-1"){
                                o['companyName'] = $('#avAmCompany option[value=' + o.companyId + ']').text();
                        }else{
                            o['companyName'] = "@Resources.Resource.all";
                        }

                        if(o.ParCluster_Id != null && o.ParCluster_Id != "-1"){
                                o['ParCluster_Name'] = $('#parClusterSelect2AmostraLevel option[value=' + o.ParCluster_Id + ']').text();
                        }else{
                            o['ParCluster_Name'] = "@Resources.Resource.all";
                        }

                        if(o.ParLevel1_Id != null && o.ParLevel1_Id != "-1"){
                                o['ParLevel1_Name'] = $('#parLevel1Select2 option[value=' + o.ParLevel1_Id + ']').text();
                        }else{
                            o['ParLevel1_Name'] = "@Resources.Resource.all";
                        }
                        if (o.TemAgendamento) {
                            o['agendamento'] = '<button type="button" class="btn btn-success btn-xs popovers" onclick="abrirModalAgendamento($(this))">Agendamento</button>';
                        } else {
                            o['agendamento'] = '<button type="button" class="btn btn-default btn-xs popovers" onclick="abrirModalAgendamento($(this))">Agendamento</button>';
                        }
                       
                        crudNxN.adiciona(o,  id, tdNamess);
                    });
                }

                $('#parLevel1Select2AmostraLevel').prepend($("<option></option>")
                        .attr("value",$('#parLevel1Select2 :selected').val())
                        .text($('#parLevel1Select2 :selected').text()));
                $('#parLevel1Select2AmostraLevel').val($('#parLevel1Select2 :selected').val());

                //$('#parClusterSelect2AmostraLevel option[value=-1]').text("@Resources.Resource.all");
                $('#parClusterSelect2AmostraLevel option[value=-1]').remove();

            },
            /*Fim Setup*/
            adiciona: function(e) {
                if (this.veifyAdd()) {
                    var object = this.getObjAdd();
                    object.agendamento = "";
                    crudNxN.adiciona(object, this.level + ' #' + this.idTable, this.tdsNames);

                    $("#parClusterSelect2AmostraLevel").val($("#parClusterSelect2AmostraLevel option:first").val());
                    $("#parLevel1Select2AmostraLevel").val($("#parLevel1Select2AmostraLevel option:first").val());

                }
            },
        };
    }

    function abrirModalAgendamento(linha) {
        debugger
       
        $("#tabelaAgendamento").attr('style', '');
        var obj = $(linha).parents('tr').data();
        botaoAgendamento = linha;
        $('#modalAgendamento').modal('show');
        var id = parseInt(obj.evaluationId);

        $.get('@Url.Action("Get", "api/Shift")', function (r) {
            let shifts = r;
            avaliacaAmostraSelectShifts = '<td> <select class="input-sm" data-column="slAgendamento"> <option value="" >Todos</option>';
            shifts.forEach(function (item) {
                avaliacaAmostraSelectShifts += '<option value="' + item.Id + '">' + item.Description +'</option>';
            })
            avaliacaAmostraSelectShifts += '</select ></td>'; 

            $.ajax({
                url: '@Url.Content("~")' + 'api/AgendamentoApi/Get/' + id,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    MontaNovaLinha(null);
                    data.forEach(function (item) {
                        MontaNovaLinha(item, false);
                    });
                    console.log(data);
                },
                error: function (request, error) {
                    alert("Request: " + JSON.stringify(request));
                }
            });
        });

        $("[data-column=inpTipoAgendamento").val($("#paramsDto_parLevel2Dto_ParFrequency_Id [selected]").text());
        $("[data-column=inpAvaliacaoId]").val(obj.evaluationId);
        $("#tabelaAgendamento tbody").html("");
    }

    function LimpaCampos() {
        $("[data-column=inpInicio]").val("");
        $("[data-column=inpTermino]").val("");
    }

    function DeletaLinha(data, linha) {
        $(linha).html('tr').remove();
    }

    function ContadorLinhas(botaoAgendamento) {
        debugger
        var tamanho = $("#tabelaAgendamento tbody").find('tr').length;

        if (tamanho <= 1) {
            $(botaoAgendamento).removeClass('btn-success').addClass('btn-default');
        } else {
            $(botaoAgendamento).removeClass('btn-default').addClass('btn-success');
        }
       
    }

    function MontaNovaLinha(data) {
        debugger
            $("#tabelaAgendamento tbody").append("<tr>"
                + '<td><input data-column="inpTipoAgendamento" class="inpTipoAgendamento input-sm" disabled="disabled" /></td>'
                + '<td><input type="number" class="input-sm" data-column="inpInicio" /></td>'
                + '<td><input type="number" class="input-sm" data-column="inpTermino" /></td>'
                + '<td><input type="number" class="input-sm" data-column="inpAvaliacao" /></td>'
                + avaliacaAmostraSelectShifts
                + '<td class="hidden"> <input data-column="inpId" class="hidden" /></td>'
                + '<td>  <button type="button" class="btn btn-primary btn-sm"  id="btnSalvarAgendamento">Salvar</button> <button type="button" onclick="deletarRegistro(this)" class="btn btn-danger btn-sm hidden btnDeletarAgendamento">Deletar</button></td>'
                + "</tr>");

            $("[data-column=inpTipoAgendamento]").val($("#paramsDto_parLevel2Dto_ParFrequency_Id [selected]").text());

            if (!!data && data.Id > 0) {
                $("#tabelaAgendamento tbody tr:last").data(data);
                $("#tabelaAgendamento tbody tr:last").find('[data-column=inpInicio]').val(data.Inicio);
                $("#tabelaAgendamento tbody tr:last").find('[data-column=inpTermino]').val(data.Fim);
                $("#tabelaAgendamento tbody tr:last").find('[data-column=inpAvaliacao]').val(data.Av);
                $("#tabelaAgendamento tbody tr:last").find('[data-column=inpId]').val(data.Id);
                $("#tabelaAgendamento tbody tr:last").find("#btnSalvarAgendamento").removeClass('btn-primary').addClass('btn-success').text('Editar');
                $("#tabelaAgendamento tbody tr:last").find(".btnDeletarAgendamento").removeClass('hidden');
                $("#tabelaAgendamento tbody tr:last").find("[data-column=slAgendamento]").val(data.Shift_Id);
            }

    }

    function EditaLinha(data, linha) {

        if (!!data && data.Id > 0) {
            $(linha).data(data);
            $(linha).find('[data-column=inpInicio]').val(data.Inicio);
            $(linha).find('[data-column=inpTermino]').val(data.Fim);
            $(linha).find('[data-column=inpAvaliacao]').val(data.Av);
            $(linha).find('[data-column=inpId]').val(data.Id);
            $(linha).find("#btnSalvarAgendamento").removeClass('btn-primary').addClass('btn-success').text('Editar');
            $(linha).find(".btnDeletarAgendamento").removeClass('hidden');
            $(linha).find("[data-column=slAgendamento]").val(data.Shift_Id);
        }

    }

    function deletarRegistro(data) {
        console.log(data);
        var linha = $(data).parents('tr');
        var form = {
            Inicio: $(linha).data()['Inicio'], //$("#inpInicio").val(),
            Fim: $(linha).data()['Fim'], //$("#inpTermino").val(),
            Av: $(linha).data()['Av'], //$(".inpAvaliacao").val(),
            Shift_Id: $(linha).data()['Shift_Id'], //$("#slAgendamento").val(),
            ParEvaluation_Id: $(linha).data()['ParEvaluation_Id'], //$("#inpAvaliacaoId").val()
            Id: $(linha).data()['Id']
        };

        $.ajax({
            url: '@Url.Content("~")' + 'api/AgendamentoApi/Delete',
            type: 'DELETE',
            data: form,
            dataType: 'json',
            success: function (data) {
                DeletaLinha(data, linha);
                ContadorLinhas(botaoAgendamento);
            },
            error: function (request, error) {
                alert("Request: " + JSON.stringify(request));
            }
        });
    }

    $("#modalAgendamento").on('click', "#btnSalvarAgendamento", function () {

        var inicio = parseInt($("[data-column=inpInicio]").val());
        var termino = parseInt($("[data-column=inpTermino]").val());
        var linha = $(this).parent().parent();

        var formato = $("#paramsDto_parLevel2Dto_ParFrequency_Id [selected]").text();

        if (!frequenciaIsValid(formato, inicio, termino)) {
            openMessageModal("Intervalo de frequencia inválido", null);
            return false;
        }
        debugger
        var form = {
            Inicio: $(linha).find("[data-column=inpInicio]").val(),
            Fim: $(linha).find("[data-column=inpTermino]").val(),
            Av: $(linha).find("[data-column=inpAvaliacao]").val(),
            Shift_Id: $(linha).find("[data-column=slAgendamento]").val(),
            ParEvaluation_Id: $("[data-column=inpAvaliacaoId]").val(),
            Id: $(linha).find("[data-column=inpId]").val(),
            //Id: $(this).parents('tr').data()['Id']
        };

        var isEdit = !!$(this).parents('tr').data()['Id'];

        $.ajax({
            url: '@Url.Content("~")' + 'api/AgendamentoApi/Post',
            type: 'POST',
            data: form,
            dataType: 'json',
            success: function (data) {
                if (form.Id > 0) {
                    EditaLinha(data, linha);
                } else {
                    MontaNovaLinha(data, isEdit);
                    $(linha).find('input:enabled').val('');
                    $(linha).find('select').val(-1);
                }
                ContadorLinhas(botaoAgendamento);
            },
            error: function (request, error) {
                alert("Request: " + JSON.stringify(request));
            }
        });

    });

    function frequenciaIsValid(formato, inicio, fim) {

        switch (formato) {
            case "Diario":
                if (fim < 1 || inicio < 1 || fim > 23 || inicio > 23 || inicio > fim)
                    return false;
                else
                    return true;
                break;
            case "Semanal":
                debugger
                if (fim < 1 || inicio < 1 || fim > 7 || inicio > 7 || inicio > fim)
                    return false;
                else
                    return true;
                break;
            case "Quinzenal":
                if (fim < 1 || inicio < 1 || fim > 15 || inicio > 15 || inicio > fim)
                    return false;
                else
                    return true;
                break;
            case "Mensal":
                if (fim < 1 || inicio < 1 || fim > 31 || inicio > 31 || inicio > fim)
                    return false;
                else
                    return true;
                break;
            case "Turno":
                break;
            default:
        }
    }

</script>