@model SgqSystem.ViewModels.ParamsViewModel
@using SgqSystem.Helpers

@*Contadores*@
<div class="panel-group accordion" id="level1_counter_accordion">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a id="changeCounterCollapse" class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#level1_counter_accordion" href="#level1_counter_collapse" aria-expanded="false"> @Resources.Resource.counters </a>
            </h4>
        </div>
        <div id="level1_counter_collapse" class="panel-collapse collapse" aria-expanded="false" style="height: 0px;">
            <div class="panel-body">
                <table id="camposContador" class="table-erp">
                    <tbody>
                        <tr class="row">
                            @Table.GerarColuna(@Html.DropDownList("parCounter", Model.paramsDdl.DdlParCounter_Level1, new { @class = "form-control input-erp input-sm" }), @Html.Label(Resources.Resource.counter), Table.PosicaoLabel.top, null, null)
                            @Table.GerarColunaButton(@Html.DropDownList("parLocal", Model.paramsDdl.DdlParLocal_Level1, new { @class = "form-control input-erp input-sm" }), @Html.Label(Resources.Resource.local), Table.PosicaoLabel.top, button: "<button type=\"button\" id=\"btnSaveCounter\" onclick=\"ContadoresL1.adiciona(); \" class=\"btn btn-primary btn-sm\"><i class=\"fa fa-plus\" aria-hidden=\"true\"></i></button>")
                        </tr>
                    </tbody>
                </table>

                <table id="tableContadores" class="table table-condensed table-responsive no-margin margin-top" nameModal="Editar Contador:">
                    <thead>
                        <tr>
                            <th>Nome do contador</th>
                            <th>Level</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

            </div>
        </div>
    </div>
</div>

<script>

    var levelControl = @Html.Raw(Json.Encode(@Model.levelControl));

    function atribuiLevelDivCounter (){

        var levelDomain;
        var listSalvo;

        if(levelControl == 1){
            levelDomain = "newLevel1Modal";
            listSalvo = @Html.Raw(Json.Encode(@Model.paramsDto.parLevel1Dto.listParCounterXLocal));
            ContadoresL1 = getCounterObject(levelDomain, listSalvo);
            ContadoresL1.carregaDadosDoDb();
        }
        if(levelControl == 2){
            levelDomain = "newLevel2Modal";
            listSalvo = @Html.Raw(Json.Encode(@Model.paramsDto.parLevel2Dto.listParCounterXLocal));
            ContadoresL2 = getCounterObject(levelDomain, listSalvo);
            ContadoresL2.carregaDadosDoDb();
        }
        if(levelControl == 3){
            levelDomain = "newLevel3Modal";
            ContadoresL3 = getCounterObject(levelDomain, listSalvo);
        }

        $('#' + levelDomain + ' #changeCounterCollapse').prop('data-parent', '#level' + levelDomain + '_counter_accordion');
        $('#' + levelDomain + '#level1_counter_collapse').attr('id', $('#changeCounterCollapse').prop('data-parent'))

    }

    function getCounterObject (levelDomain, listSalvo) {
        return {
            /*Setup*/
            idTable: 'tableContadores',
            level: levelDomain,
            listObjSalvo: listSalvo,
            tdsNames: ['ParCounterName', 'ParLocalName', 'btn'],
            getObjAdd: function(){
                return {/*Objeto*/
                    ParLocal_Id: $('#' + this.level + ' #parLocal :selected').val(),
                    ParLocalName: $('#' + this.level + ' #parLocal :selected').text(),
                    ParCounter_Id: $('#' + this.level + ' #parCounter :selected').val(),
                    ParCounterName: $('#' + this.level + ' #parCounter :selected').text(),
                    IsActive: true,
                };
            },
            veifyAdd: function() {
                /*Valida se pode criar o objeto*/
                if($('#' + this.level + ' #parCounter :selected').val() <= 0){
                    alert("Por favor selecione o contador.");
                    return;
                }

                if($('#' + this.level + ' #parLocal').val() <= 0){
                    alert("Por favor selecione o local.");
                    return;
                }
            },
            incluiNoObjetoParaSubmit: function(dados){

                $('#' + this.level + ' #' + this.idTable + ' > tbody > tr ').each(function(c, obj){

                    var o = $(obj).data();

                    if((o.Id != null || o.Id != undefined) && o.Id > 0){
                        dados["paramsDto.parLevel1Dto.listParCounterXLocal[" + c + "].Id"] = o.Id;
                    }

                    dados["paramsDto.parLevel1Dto.listParCounterXLocal[" + c + "].ParLocal_Id"] = o.ParLocal_Id;
                    dados["paramsDto.parLevel1Dto.listParCounterXLocal[" + c + "].ParCounter_Id"] = o.ParCounter_Id;
                    dados["paramsDto.parLevel1Dto.listParCounterXLocal[" + c + "].IsActive"] = o.IsActive;

                });

            },
            carregaDadosDoDb: function(){
                if( this.listObjSalvo != null){ /*Carrega regras de NC*/
                    this.listObjSalvo.forEach(function(o, c){
                        o["ParLocalName"] = o.ParLocal.Name;
                        o["ParCounterName"] = o.ParCounter.Name;
                        crudNxN.adiciona(o, this.level + ' #' + this.idTable, this.tdsNames);
                    });
                }
            },
            /*Fim Setup*/
            adiciona: function() {
                this.veifyAdd();
                var object = this.getObjAdd();
                crudNxN.adiciona(object, this.level + ' #' + this.idTable, this.tdsNames);
            },
        };
    }

    $(document).ready(function () {
        atribuiLevelDivCounter();
    });

</script>