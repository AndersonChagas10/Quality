<div class="modal fade" id="modalAgendamento" role="dialog">
    <div class="modal-dialog modal-lg vertical-align-center">
        <div class="modal-content">
            <div class="modal-header modal-header-gray">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Agendamento</h4>
            </div>
            <div class="modal-body">
                <div id="cadastroIntervalos" class="hidden">
                    <div class="form-group">
                        @Html.Label(Resources.Resource.frequency_type, htmlAttributes: new { @class = "control-label col-md-4" })
                        <div class="col-md-4">
                            <select id="tipoFrequencia" name="tipoFrequencia" class="form-control valid">
                                <option value="Diario com Intervalo" id="diarioFrequencia">@Resources.Resource.daily_with_interval</option>
                                <option value="Diario" id="diario">@Resources.Resource.diary</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="divIntervalo">
                        @Html.Label("Intervalo", htmlAttributes: new { @class = "control-label col-md-4" })
                        <div class="col-md-4">
                            <input id="intervalo" type="time" min="0" class=" form-control notAllowNegative" />
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-12">
                            <table id="tabelaAgendamento" style="max-width: 100%" hidden="hidden" class="table table-condensed no-margin margin-top">
                                <thead>
                                    <tr>
                                        <th id="headAvaliacao">Avaliação</th>
                                        <th id="headInicio">Início</th>
                                        <th id="headFim">Fim</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnSalvar" onclick="preencheAgendamento(event)" class="btn btn-success">Salvar</button>
                <button type="button" data-dismiss="modal" class="btn btn-default">Fechar</button>
            </div>
        </div>

    </div>
</div>

<script>
    var listaAvaliacaoInicioFim = [];
    var perfilUsuario = getCookie('webControlCookie')[6].split("=")[1].split(",");

    $("#ParCompany_id, #HorasTrabalhadasPorDia").on('input', function () {
        debugger
        if ($('#HorasTrabalhadasPorDia').val() !== "" && perfilUsuario.indexOf("Admin") >= 0) {
            //$("#btnModalAgendamento").removeClass('hidden');
            $("#divbotaoAgendamento").removeClass('hidden');
            MontarTabelaVolume();
        } else {
            //$("#btnModalAgendamento").addClass('hidden');
            $("#divbotaoAgendamento").addClass('hidden');
        }
    });

    $(document).ready(function () {
        debugger
        setTimeout(function () {
            if (perfilUsuario.indexOf("Admin") >= 0) {
                if ($("#Agendamento").val() !== "") {

                    var tipoFrequencia = $("#Agendamento").val();
                    $("#divbotaoAgendamento").removeClass('hidden');
                    if (tipoFrequencia.indexOf("-") < 0) {

                        $("#cadastroIntervalos").removeClass('hidden');
                        $("#tabelaAgendamento").attr('hidden', 'hidden');
                        $("#divIntervalo").removeAttr('hidden');
                        $("#tabelaAgendamento tbody").html("");

                        $("#tipoFrequencia").val("Diario com Intervalo");
                        $("#intervalo").val($("#Agendamento").val());

                    } else {
                        $("#cadastroIntervalos").removeClass('hidden');
                        $("#divIntervalo").attr('hidden', 'hidden');
                        $("#tabelaAgendamento").removeAttr('hidden');
                        $("#tipoFrequencia").val("Diario");
                        MontarTabelaVolume();

                    }
                }

                $("#tipoFrequencia").on('change', function () {
                    debugger
                    if ($("#tipoFrequencia :selected").text() === "Diário com Intervalo") {
                        $("#tabelaAgendamento").attr('hidden', 'hidden');
                        $("#divIntervalo").removeAttr('hidden');
                        $("#tabelaAgendamento tbody").html("");
                    } else {
                        $("#divIntervalo").attr('hidden', 'hidden');
                        MontarTabelaVolume();
                        $("#tabelaAgendamento").removeAttr('hidden');
                    }
                });
            } else {
                $("#divbotaoAgendamento").addClass('hidden');
            }
        }, 0);
        
    });

    function AbrirModal() {
        debugger
        if ($("#ParCompany_id :selected").text() !== "" && $("#HorasTrabalhadasPorDia").val() !== "") {
            $("#cadastroIntervalos").removeClass('hidden');
            if ($("#tipoFrequencia :selected").text() === "Diário")
                MontarTabelaVolume();
        } else {
            $("#cadastroIntervalos").addClass('hidden');
        }
        $('#modalAgendamento').modal('show');
    }

    function MontarTabelaVolume() {
        debugger
        var agendamentosCarregados = $("#Agendamento").val();
        var listaAgendamentoSeparados = [];
        $("#tabelaAgendamento tbody").html("");
        var quantidadeAvaliacoes = $("#Avaliacoes").val();
        var listaAgendamentosCarregados = agendamentosCarregados.split("|");
        for (var i = 1; i <= quantidadeAvaliacoes; i++) {
            $("#tabelaAgendamento tbody").append("<tr>"
                + '<td><input data-column="inpValorAvaliacao" class="inpTipoAgendamento input-sm" disabled="disabled" /></td>'
                + '<td><input type="time" min="0" class="input-sm notAllowNegative" data-column="inpInicio" /></td>'
                + '<td><input type="time" min="0" class="input-sm notAllowNegative" data-column="inpFim" /></td>'
                + '<td class="hidden"> <input data-column="inpId" class="hidden" /></td>'
                + "</tr>");

            $("#tabelaAgendamento tbody tr:last").find('[data-column=inpValorAvaliacao]').val(i);

        }
        debugger
        if (agendamentosCarregados !== "" && agendamentosCarregados.indexOf('|') > 0 || agendamentosCarregados.length === 5) {

            for (var j = 0; j < listaAgendamentosCarregados.length; j++) {
                listaAgendamentoSeparados.push(listaAgendamentosCarregados[j].split('-'));
            }
            for (var x = 0; x < listaAgendamentoSeparados.length; x++) {
                if (x === 0 && $("#tabelaAgendamento tbody tr:nth(" + x + ")").find('[data-column=inpValorAvaliacao]').val() !== "1") {
                    $("#tabelaAgendamento tbody tr:nth(" + x + ")").find('[data-column=inpValorAvaliacao]').val(listaAgendamentoSeparados[x][0]);
                    $("#tabelaAgendamento tbody tr:nth(" + x + ")").find('[data-column=inpInicio]').val(listaAgendamentoSeparados[x][1]);
                    $("#tabelaAgendamento tbody tr:nth(" + x + ")").find('[data-column=inpFim]').val(listaAgendamentoSeparados[x][2]);
                } else {
                    $("#tabelaAgendamento tbody tr:nth(" + x + ")").find('[data-column=inpInicio]').val(listaAgendamentoSeparados[x][1]);
                    $("#tabelaAgendamento tbody tr:nth(" + x + ")").find('[data-column=inpFim]').val(listaAgendamentoSeparados[x][2]);
                }
            }
        }
    }


    function preencheAgendamento(e) {
        debugger
        if ($("#tipoFrequencia :selected").text() === "Diário com Intervalo") {
            $("#Agendamento").val($("#intervalo").val());
        } else {
            var listaTabelaAgendamento = $("#tabelaAgendamento tbody tr");
            var listaAvaliacaoInicioFim = [];
            var contadorErros = [];
            var contadorErrosInicioFim = [];
            var contador = 0;

            listaTabelaAgendamento.each(function (index, item) {
                var form = [];
                //campo agendamento é montado da seguinte forma: [AVALIACAO,INICIO,FIM | AVALIACAO,INICIO,FIM]
                form.push($(item).find("[data-column=inpValorAvaliacao]").val()
                    , $(item).find("[data-column=inpInicio]").val()
                    , $(item).find("[data-column=inpFim]").val());
                contador++;
                if (!validaAgendamento(item)) {
                    contadorErros.push(contador);
                }
                if (!validaInicioFim(item)) {
                    contadorErrosInicioFim.push(contador);
                }
                listaAvaliacaoInicioFim.push(form.join('-'));
            });

            if (contadorErros.length === 0 && contadorErrosInicioFim.length === 0)
                $("#Agendamento").val(listaAvaliacaoInicioFim.join('|'));
            else if (contadorErrosInicioFim.length > 0) {
                e.preventDefault();
                openMessageModal('O campo Início é maior que o campo Fim das Avaliações:' + ' ' + contadorErrosInicioFim, null);
                return false;
            }else {
                e.preventDefault();
                openMessageModal('@Resources.Resource.invalid_rating_values' + ' ' + contadorErros, null);
                return false;
            }
        }
        $('#modalAgendamento').modal('hide');
    }

    function validaAgendamento(item) {
        if (parseInt($(item).find("[data-column=inpInicio]").val()) < 0 || parseInt($(item).find("[data-column=inpFim]").val()) < 0) {
            return false;
        }

        if ($(item).find("[data-column=inpInicio]").val() !== "" && $(item).find("[data-column=inpFim]").val() === "") {
            return false;
        }

        if ($(item).find("[data-column=inpInicio]").val() === "" && $(item).find("[data-column=inpFim]").val() !== "") {
            return false;
        }

        if (parseInt($(item).find("[data-column=inpInicio]").val()) > 24 || parseInt($(item).find("[data-column=inpFim]").val()) > 24) {
            return false;
        }

        return true;
    }

    function validaInicioFim(item) {

        if (parseInt($(item).find("[data-column=inpInicio]").val()) > parseInt($(item).find("[data-column=inpFim]").val())) {
            return false;
        }

        return true;
    }


    $("#cadastroIntervalos").on('input', '[data-column="inpInicio"] , [data-column="inpFim"]', function () {
        if (parseInt($(this).val()) > 24) {
            $(this).addClass('alert-danger');
            return false;
        } else {
            $(this).removeClass('alert-danger');
        }
    });

</script>
