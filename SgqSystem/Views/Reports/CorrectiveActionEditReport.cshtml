@{
    ViewBag.Title = Resources.Resource.corrective_action_reports;
    var url = Url.Action("Index", "Home");
    var urlTabelaRelatorio = Url.Action("GetCorrectiveAction", "api/CorrectiveAction");
    var urlGetCa = Url.Action("GetCorrectiveActionById", "api/CorrectiveAction");
}

<div class="page-content-wrapper">
    <div class="page-content">
        @Html.Partial("~/Views/Shared/_FormToQueryFullScreen.cshtml","")
        <div id="formBodyContent">
            @Html.Partial("~/Views/Shared/_mensagemObrigatorio.cshtml")
            @Html.Partial("~/Views/Shared/_CorrectiveActionReportEdit.cshtml", new DTO.DTO.CorrectiveActionDTO())
            <div>
                <table id="results" class="display" cellspacing="0" style="width:100%"></table>
                <div class="modifyMeTable"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <script type="text/javascript">
        $('#simpleCallendar').hide().attr('disabled', true);

        $('button').button({ loadingText: '@Resources.Resource.loading...' });

        var url1 = '@Html.Raw(@urlTabelaRelatorio)';
        var url2 = '@Html.Raw(@urlGetCa)';
        var $btn = $('#btnSend');

        var $wrapper = $($('style')[1]);
        var $placeholder = $('<span style="display: none;" />').insertAfter($wrapper);

        $(document).ready(function () {
            $("#btnSend").click(function (e) {
                Send();
            });
        });

        function Send(toggle) {
            $btn.button('loading');
            $('#results').empty();

            if (!ValidaDadosParaEnvio()) {
                $btn.button('reset');
                return;
            }

            $('#divTable').hide();
            EasyAjax(url1, enviar, GerarTabela, "load", toggle);
        }

        function GerarTabela(retornoArray) {
            
            var table = datatableGRT.Inicializar({
                idTabela: "results",
                listaDeDados: retornoArray,
                colunaDosDados: [
                    {
                        title: "@Resources.Resource.view", mData: null, defaultContent:
                        '<button type="button" class="btn btn-link custom-button" data-action="read" data-toggle="modal" data-target="#myModal">@Resources.Resource.view</button>'
                    },
                    {
                        title: "@Resources.Resource.edit", mData: null, defaultContent: 
                        '<button type="button" class="btn btn-link custom-button" data-action="edit" data-toggle="modal" data-target="#editCorrectiveActionModal">@Resources.Resource.edit</button>'
                    },
                   { title: "@Resources.Resource.auditor", mData: "AuditorName" },
                   { title: "@Resources.Resource.date", mData: "DateCorrectiveActionFormatadoShort" },
                   { title: "@Resources.Resource.start_time", mData: "StartTimeFormatado" },
                   { title: "@Resources.Resource.slaughter", mData: "NameSlaugtherAndDate" },
                   { title: "@Resources.Resource.technical", mData: "NameTechinicalAndDate" },
                   { title: "@Resources.Resource.level1", mData: "level01Name" },
                   { title: "@Resources.Resource.level2", mData: "level02Name" },
                   { title: "@Resources.Resource.audit_start_time", mData: "StartTimeFormatado" },
                   { title: "@Resources.Resource.description_failure", mData: "DescriptionFailure" },
                   { title: "@Resources.Resource.immediate_corrective_action", mData: "ImmediateCorrectiveAction" },
                   { title: "@Resources.Resource.preventative_measure", mData: "PreventativeMeasure" },
                   { title: "@Resources.Resource.product_disposition", mData: "ProductDisposition" },
                ],
                "columnDefs": [
                   { "className": "dt-center", "targets": "_all" }
                ],
                scrollX: true,
                tamanhosDoMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                numeroLinhasNaTabela: 10,
                loadingRecords: true,
                destroy: true,
                info: true,
                aplicarResponsividade: true,
                initComplete: function () {
                    $('#loading').hide();
                    $('#results tbody').on('click', 'button[data-action="read"]', function () {
                        var data = table.row($(this).parents('tr')).data();
                        $.post(url2, { "": data.Id }, function (r, x, e) {

                            if (!!r) {

                                $('#correctiveActionModal  #estName').html(r.Unit.Name); // ok
                                $('#correctiveActionModal  #estCode').html(r.Unit.Code);
                                $('#correctiveActionModal  #datetime').html(r.DateCorrectiveActionFormatado); // ok
                                $('#correctiveActionModal  #auditor').html(r.AuditorName); //ok
                                $('#correctiveActionModal  #auditText').html(r.level01Name); //ok
                                $('#correctiveActionModal  #shift').html(r.ShiftName); //ok
                                $('#correctiveActionModal  #starttime').html(r.StartTimeFormatado); //ok
                                $('#correctiveActionModal  #correctivePeriod').html(r.PeriodName); //ok

                                $('#correctiveActionModal  #DescriptionFailure').html(r.DescriptionFailure); //ok
                                $('#correctiveActionModal  #ImmediateCorrectiveAction').html(r.ImmediateCorrectiveAction); //ok
                                $('#correctiveActionModal  #ProductDisposition').html(r.ProductDisposition); //ok
                                $('#correctiveActionModal  #PreventativeMeasure').html(r.PreventativeMeasure); //ok

                                $('#correctiveActionModal  #Slaugther .name').html(r.NameSlaughter); //ok
                                $('#correctiveActionModal  #Slaugther .date').html(r.DateTimeSlaughterFarmatado); //ok

                                $('#correctiveActionModal  #Technical .name').html(r.NameTechinical); //ok
                                $('#correctiveActionModal  #Technical .date').html(r.DateTimeTechinicalFarmatado); //OK


                                var date = new Date();
                                var year = date.getFullYear();
                                var month = date.getMonth() + 1;
                                var day = date.getDate();
                                var hour = date.getHours();
                                var minute = date.getMinutes();
                                var seconds = date.getSeconds();
                                var mileseconds = date.getMilliseconds();
                                var mmddyyyyhhmm = ("0" + month).slice(-2) + "/" + ("0" + day).slice(-2) + "/" + year + " " + ("0" + hour).slice(-2) + ":" + ("0" + minute).slice(-2);

                                $('.printedDate').html(mmddyyyyhhmm);
                            } else {

                                GuardJs.exibirMensagemAlerta(e);
                            }

                            $('#correctiveActionModal').show();
                        });
                    });
                    $('#results tbody').on('click', 'button[data-action="edit"]', function () {
                        var data = table.row($(this).parents('tr')).data();
                        $.post(url2, { "": data.Id }, function (r, x, e) {

                            if (!!r) {

                                $('#editCorrectiveActionModal  #Id').val(r.Id); //ok
                                $('#editCorrectiveActionModal  #estName').html(r.Unit.Name); // ok
                                $('#editCorrectiveActionModal  #estCode').html(r.Unit.Code);
                                $('#editCorrectiveActionModal  #datetime').val(r.DateCorrectiveActionFormatado); // ok
                                $('#editCorrectiveActionModal  #auditor').val(r.AuditorName); //ok
                                $('#editCorrectiveActionModal  #auditText').val(r.level01Name); //ok
                                $('#editCorrectiveActionModal  #shift').val(r.ShiftName); //ok
                                $('#editCorrectiveActionModal  #starttime').val(r.StartTimeFormatado); //ok
                                $('#editCorrectiveActionModal  #correctivePeriod').val(r.PeriodName); //ok

                                $('#editCorrectiveActionModal  #DescriptionFailure').html(r.DescriptionFailure); //ok
                                $('#editCorrectiveActionModal  #ImmediateCorrectiveAction').html(r.ImmediateCorrectiveAction); //ok
                                $('#editCorrectiveActionModal  #ProductDisposition').html(r.ProductDisposition); //ok
                                $('#editCorrectiveActionModal  #PreventativeMeasure').html(r.PreventativeMeasure); //ok

                                $('#editCorrectiveActionModal  #Slaugther .name').val(r.NameSlaughter); //ok
                                $('#editCorrectiveActionModal  #Slaugther .date').val(r.DateTimeSlaughterFarmatado); //ok

                                $('#editCorrectiveActionModal  #Technical .name').val(r.NameTechinical); //ok
                                $('#editCorrectiveActionModal  #Technical .date').val(r.DateTimeTechinicalFarmatado); //OK


                                var date = new Date();
                                var year = date.getFullYear();
                                var month = date.getMonth() + 1;
                                var day = date.getDate();
                                var hour = date.getHours();
                                var minute = date.getMinutes();
                                var seconds = date.getSeconds();
                                var mileseconds = date.getMilliseconds();
                                var mmddyyyyhhmm = ("0" + month).slice(-2) + "/" + ("0" + day).slice(-2) + "/" + year + " " + ("0" + hour).slice(-2) + ":" + ("0" + minute).slice(-2);

                                $('.printedDate').html(mmddyyyyhhmm);
                            } else {

                                GuardJs.exibirMensagemAlerta(e);
                            }

                            $('#correctiveActionModal').show();
                        });
                    });
                }
            });
            table.f;
            if (!$('.dataTables_empty').length) {
                $('#menu-toggle').click();
            }
            new $.fn.dataTable.Buttons(table, {
                buttons: [
                ]
            });

            table.buttons(0, null).container().prependTo(
                table.table().container()
            );

        }

        document.getElementById("btnPrint").onclick = function () {
            $wrapper.insertBefore($placeholder);
            printElement(document.getElementById("printThis"));
            var modThis = document.querySelector("#printSection .modifyMe");
            modThis.appendChild(document.createTextNode(" "));

            window.print();
            $('#printSection').remove();

        };

        function printElement(elem, append, delimiter) {
            var domClone = elem.cloneNode(true);

            var $printSection = document.getElementById("printSection");

            if (!$printSection) {
                $printSection = document.createElement("div");
                $printSection.id = "printSection";
                document.body.appendChild($printSection);
            }

            if (append !== true) {
                $printSection.innerHTML = "";
            }

            else if (append === true) {
                if (typeof (delimiter) === "string") {
                    $printSection.innerHTML += delimiter;
                }
                else if (typeof (delimiter) === "object") {
                    $printSection.appendChlid(delimiter);
                }
            }

            $printSection.appendChild(domClone);
        }

        $(document).ready(function () {

            closeLeftSidebar();
            $(".sidebar-toggler").removeClass("hide");
            $(".page-sidebar-wrapper").removeClass("hide");

            formControl.ShowAllFielsAndFullCallendar();
        });

        function ValidaDadosParaEnvio() {
            GuardJs.resetForValidation();
            GuardJs.CheckRangeDateTime(enviar.endDate, enviar.startDate, "Initial date", "End date");

            if (!GuardJs.isValid)
                return !GuardJs.isValid;
            GuardJs.esconderMensagem();

            return true;
        }

    </script>
}
