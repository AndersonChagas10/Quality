@model SgqSystem.ViewModels.FormularioParaRelatorioViewModel
@{
    ViewBag.Title = "Corrective Action Reports";
    var url = Url.Action("Index", "Home");
    var urlTabelaRelatorio = Url.Action("GetCorrectiveAction", "api/CorrectiveAction");
    var urlGetCa = Url.Action("GetCorrectiveActionById", "api/CorrectiveAction");
}

@*@Styles.Render("~/Content/Tables")*@
<link href="@Url.Content("~/Content/DataTables/css/jquery.dataTables.min.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/DataTables/css/buttons.dataTables.min.css")" rel="stylesheet" />

@Html.Partial("~/Views/Shared/_FormToQueryFullScreen.cshtml")

<div id="formBodyContent">
    @Html.Partial("~/Views/Shared/_mensagemObrigatorio.cshtml")
    @Html.Partial("~/Views/Shared/_CorrectiveActionReportEdit.cshtml", new DTO.DTO.CorrectiveActionDTO())
    <div>
        <table id="results" class="display" cellspacing="0" style="width:100%"></table>
        <div class="modifyMeTable"></div>
    </div>
</div>


@section Scripts {

    @Scripts.Render("~/Scripts/GuardJs.js")
    @Scripts.Render("~/bundles/ScriptTables")

    <script type="text/javascript">

        var url1 = '@Html.Raw(@urlTabelaRelatorio)';
        var url2 = '@Html.Raw(@urlGetCa)';
        var $btn = $('#btnSend');

        var $wrapper = $($('style')[1]);
        var $placeholder = $('<span style="display: none;" />').insertAfter($wrapper)
        $wrapper.detach();
        //$wrapper.insertBefore($placeholder);

        $(document).ready(function () {
            $("#btnSend").click(function (e) {
                Send();
            });
        });

        formControl.ShowAllFielsAndFullCallendar();

        function Send() {

            try {
                $btn.button('loading');
                $('#results').empty();
                GuardJs.resetForValidation();
                GuardJs.CheckRangeDateTime(enviar.endDate, enviar.startDate, "Initial date", "End date");
                if (!GuardJs.isValid) { return; }
                GuardJs.esconderMensagem();
                $.post(url1, enviar, function (r) {

                    CriaTable(r.Retorno);

                    $btn.button('reset');
                });
            } catch (err) {
                console.log(e);
                $btn.button('reset');
            }
        };

        function CriaTable(retornoArray) {

            var table = $('#results').empty().DataTable({
                data: retornoArray,
                columns: [{ title: "View", mData: null, defaultContent: '<button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#myModal">View</button>' },
                   { title: "Auditor", mData: "AuditorName" },
                   { title: "Date", mData: "DateCorrectiveActionFormatadoShort" },
                   { title: "Start Time", mData: "StartTimeFormatado" },
                   { title: "Slaughter", mData: "NameSlaugtherAndDate" },
                   //{ title: "Date Slaughter", mData: "DateTimeSlaughterFarmatado" },
                   { title: "Techinical", mData: "NameTechinicalAndDate" },
                   //{ title: "Date Techinical", mData: "DateTimeTechinicalFarmatado" },
                   { title: "level01", mData: "level01Name" },
                   { title: "level02", mData: "level02Name" },
                   { title: "Audit Start Time", mData: "StartTimeFormatado" },
                   { title: "Description Failure", mData: "DescriptionFailure" },
                   { title: "Immediate Corrective Action", mData: "ImmediateCorrectiveAction" },
                   { title: "Preventative Measure", mData: "PreventativeMeasure" },
                   { title: "Product Disposition", mData: "ProductDisposition" },
                   //{ title: "Auditor", mData: "Id" }
                ],
                //dom: 'Bfrtip',
                //buttons: [
                //   'copy', 'excel', 'pdf'
                //],
                //columnDefs: config.columnDefs,
                //bSort: true,
                //bAutoWidth: true,
                //bFilter: true,
                scrollX: true,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                pageLength: 10,
                //processing: true,
                loadingRecords: true,
                destroy: true,
                //paginate: true,
                //paging: true,
                info: true,
                //searching: true,
                //createdRow: config.createdRow,
                //fnDrawCallback: config.fnDrawCallback,
                initComplete: function () {
                    $('#loading').hide();
                    $('#results tbody').on('click', 'button', function (data, a, b) {
                        var data = table.row($(this).parents('tr')).data();
                        //alert(data.Id + "Id is: " + data.Id);
                        $.post(url2, { "": data.Id }, function (r, x, e) {
                            if (!!r.Retorno) {
                                //console.log(r.Retorno);
                                $('#correctiveActionModal  #datetime').html(r.Retorno.DateCorrectiveActionFormatado); // ?
                                $('#correctiveActionModal  #auditor').html(r.Retorno.AuditorName);
                                $('#correctiveActionModal  #auditText').html(r.Retorno.level01Name);
                                $('#correctiveActionModal  #shift').html(r.Retorno.ShiftName);
                                $('#correctiveActionModal  #starttime').html(r.Retorno.StartTimeFormatado);
                                $('#correctiveActionModal  #correctivePeriod').html(r.Retorno.PeriodName);

                                $('#correctiveActionModal  #DescriptionFailure').html(r.Retorno.DescriptionFailure);
                                $('#correctiveActionModal  #ImmediateCorrectiveAction').html(r.Retorno.ImmediateCorrectiveAction);
                                $('#correctiveActionModal  #ProductDisposition').html(r.Retorno.ProductDisposition);
                                $('#correctiveActionModal  #PreventativeMeasure').html(r.Retorno.PreventativeMeasure);

                                $('#correctiveActionModal  #Slaugther .name').html(r.Retorno.NameSlaughter);
                                $('#correctiveActionModal  #Slaugther .date').html(r.Retorno.DateTimeSlaughterFarmatado);

                                $('#correctiveActionModal  #Technical .name').html(r.Retorno.NameTechinical);
                                $('#correctiveActionModal  #Technical .date').html(r.Retorno.DateTimeTechinicalFarmatado);
                            } else {
                                GuardJs.exibirMensagemAlerta(r.Mensagem);
                            }

                            $('#correctiveActionModal').show();
                        });
                    });
                },
                //order: config.order || [[0, 'asc']],
                //serverSide: !config.serverSide == undefined || config.serverSide,
                //sPaginationType: 'full_numbers',
            });

            new $.fn.dataTable.Buttons(table, {
                buttons: [
                    {
                        extend: 'print',
                        customize: function (win) {
                            //$(win.document.body)
                            //    .css( 'font-size', '10pt' )
                            //    .prepend(
                            //        '<img src="http://datatables.net/media/images/logo-fade.png" style="position:absolute; top:0; left:0;" />'
                            //    );

                            $(win.document.body).find('table')
                                .addClass('compact').addClass('printable!important')
                                .css('font-size', 'inherit');
                        },
                        exportOptions: {
                            columns: ':visible'
                        }
                    },
                    {
                        extend: 'excelHtml5',
                        exportOptions: {
                            columns: ':visible'
                        }
                    },
                    'pdf',
                    'colvis',

                ]
            });

            table.buttons(0, null).container().prependTo(
                table.table().container()
            );

        }

        document.getElementById("btnPrint").onclick = function () {
            $wrapper.insertBefore($placeholder);
            printElement(document.getElementById("printThis"));
            var modThis = document.querySelector("#printSection .modifyMe");
            modThis.appendChild(document.createTextNode(" "));

            //var w = window.open();
            //var html = $("#toNewWindow").html();

            //$(w.document.body).html(html);
            //w.print();

            window.print();
            $wrapper.detach();
        }

        function printElement(elem, append, delimiter) {
            var domClone = elem.cloneNode(true);

            var $printSection = document.getElementById("printSection");

            if (!$printSection) {
                $printSection = document.createElement("div");
                $printSection.id = "printSection";
                document.body.appendChild($printSection);
            }

            if (append !== true) {
                $printSection.innerHTML = "";
            }

            else if (append === true) {
                if (typeof (delimiter) === "string") {
                    $printSection.innerHTML += delimiter;
                }
                else if (typeof (delimiter) === "object") {
                    $printSection.appendChlid(delimiter);
                }
            }

            $printSection.appendChild(domClone);
        }

    </script>
}
