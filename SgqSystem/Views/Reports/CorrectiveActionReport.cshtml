@*@model SgqSystem.ViewModels.FormularioParaRelatorioViewModel*@
@{
    ViewBag.Title = "Corrective Action Reports";
    var url = Url.Action("Index", "Home");
    var urlTabelaRelatorio = Url.Action("GetCorrectiveAction", "api/CorrectiveAction");
    //var urlTabelaRelatorio = Url.Action("Teste", "api/CorrectiveAction");
    var urlGetCa = Url.Action("GetCorrectiveActionById", "api/CorrectiveAction");
}

@*@Styles.Render("~/Content/Tables")*@
@*<link href="@Url.Content("~/Content/DataTables/css/jquery.dataTables.min.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/DataTables/css/buttons.dataTables.min.css")" rel="stylesheet" />*@

<div class="page-content" style="min-height: 600px;">
    @Html.Partial("~/Views/Shared/_FormToQueryFullScreen.cshtml")
    <div id="formBodyContent">
        @Html.Partial("~/Views/Shared/_mensagemObrigatorio.cshtml")
        @Html.Partial("~/Views/Shared/_CorrectiveActionReportEdit.cshtml", new DTO.DTO.CorrectiveActionDTO())
        <div>
            <table id="results" class="display" cellspacing="0" style="width:100%"></table>
            <div class="modifyMeTable"></div>
        </div>
    </div>
</div>

@section Scripts {

    @*@Scripts.Render("~/Scripts/GuardJs.js")
        @Scripts.Render("~/bundles/ScriptTables")*@

    <script type="text/javascript">

        $(".sidebar-toggler").removeClass("hide");
        $(".page-sidebar-wrapper").removeClass("hide");
        $('#simpleCallendar').hide().attr('disabled', true);

        var url1 = '@Html.Raw(@urlTabelaRelatorio)';
        var url2 = '@Html.Raw(@urlGetCa)';
        var $btn = $('#btnSend');

        var $wrapper = $($('style')[1]);
        var $placeholder = $('<span style="display: none;" />').insertAfter($wrapper)
        $wrapper.detach();

        $(document).ready(function () {
            $("#btnSend").click(function (e) {
                Send();
            });
        });

        function Send(toggle) {
            $btn.button('loading');
            $('#results').empty();

            if (!ValidaDadosParaEnvio()) {
                $btn.button('reset');
                return;
            }

            $('#divTable').hide();
            EasyAjax(url1, enviar, GerarTabela, "load", toggle);
        };

        //function Send() {
        //    try {
        //        $btn.button('loading');
        //        $('#results').empty();
        //        GuardJs.resetForValidation();
        //        GuardJs.CheckRangeDateTime(enviar.endDate, enviar.startDate, "Initial date", "End date");
        //        if (!GuardJs.isValid) { return; }
        //        GuardJs.esconderMensagem();
        //        $.post(url1, enviar, function (r) {
        //            CriaTable(r.Retorno);
        //        });
        //    } catch (err) {
        //        console.log(e);
        //    } finally {
        //        $btn.button('reset');
        //        //setTimeout(function (e) {
        //        //    var oTable = $('#results').dataTable();
        //        //    if (oTable.length > 0) {
        //        //        oTable.fnAdjustColumnSizing();
        //        //    }
        //        //}, 500);
        //    }
        //};

        function GerarTabela(retornoArray) {

            var table = $('#results').empty().DataTable({
                data: retornoArray,
                columns: [{ title: "View", mData: null, defaultContent: '<button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#myModal">View</button>' },
                   { title: "Auditor", mData: "AuditorName" },
                   { title: "Date", mData: "DateCorrectiveActionFormatadoShort" },
                   { title: "Start Time", mData: "StartTimeFormatado" },
                   { title: "Slaughter", mData: "NameSlaugtherAndDate" },
                   //{ title: "Date Slaughter", mData: "DateTimeSlaughterFarmatado" },
                   { title: "Techinical", mData: "NameTechinicalAndDate" },
                   //{ title: "Date Techinical", mData: "DateTimeTechinicalFarmatado" },
                   { title: "level01", mData: "level01Name" },
                   { title: "level02", mData: "level02Name" },
                   { title: "Audit Start Time", mData: "StartTimeFormatado" },
                   { title: "Description Failure", mData: "DescriptionFailure" },
                   { title: "Immediate Corrective Action", mData: "ImmediateCorrectiveAction" },
                   { title: "Preventative Measure", mData: "PreventativeMeasure" },
                   { title: "Product Disposition", mData: "ProductDisposition" },
                   //{ title: "Auditor", mData: "Id" }
                ],
                "columnDefs": [
                   { "className": "dt-center", "targets": "_all" }
                ],
                scrollX: true,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                pageLength: 10,
                loadingRecords: true,
                destroy: true,
                info: true,
                responsive: true,
                initComplete: function () {
                    $('#loading').hide();
                    $('#results tbody').on('click', 'button', function (data, a, b) {
                        var data = table.row($(this).parents('tr')).data();
                        $.post(url2, { "": data.Id }, function (r, x, e) {

                            if (!!r) {

                                $('#correctiveActionModal  #estName').html(r.Unit.Name); // ok
                                $('#correctiveActionModal  #estCode').html(r.Unit.Code);
                                $('#correctiveActionModal  #datetime').html(r.DateCorrectiveActionFormatado); // ok
                                $('#correctiveActionModal  #auditor').html(r.AuditorName); //ok
                                $('#correctiveActionModal  #auditText').html(r.level01Name); //ok
                                $('#correctiveActionModal  #shift').html(r.ShiftName); //ok
                                $('#correctiveActionModal  #starttime').html(r.StartTimeFormatado); //ok
                                $('#correctiveActionModal  #correctivePeriod').html(r.PeriodName); //ok

                                $('#correctiveActionModal  #DescriptionFailure').html(r.DescriptionFailure); //ok
                                $('#correctiveActionModal  #ImmediateCorrectiveAction').html(r.ImmediateCorrectiveAction); //ok
                                $('#correctiveActionModal  #ProductDisposition').html(r.ProductDisposition); //ok
                                $('#correctiveActionModal  #PreventativeMeasure').html(r.PreventativeMeasure); //ok

                                $('#correctiveActionModal  #Slaugther .name').html(r.NameSlaughter); //ok
                                $('#correctiveActionModal  #Slaugther .date').html(r.DateTimeSlaughterFarmatado); //ok

                                $('#correctiveActionModal  #Technical .name').html(r.NameTechinical); //ok
                                $('#correctiveActionModal  #Technical .date').html(r.DateTimeTechinicalFarmatado); //OK


                                var date = new Date();
                                var year = date.getFullYear();
                                var month = date.getMonth() + 1;
                                var day = date.getDate();
                                var hour = date.getHours();
                                var minute = date.getMinutes();
                                var seconds = date.getSeconds();
                                var mileseconds = date.getMilliseconds();
                                var mmddyyyyhhmm = ("0" + month).slice(-2) + "/" + ("0" + day).slice(-2) + "/" + year + " " + ("0" + hour).slice(-2) + ":" + ("0" + minute).slice(-2);

                                $('.printedDate').html(mmddyyyyhhmm);
                            } else {

                                GuardJs.exibirMensagemAlerta(e);
                            }

                            $('#correctiveActionModal').show();
                        });
                    });
                },
            });
            table.f
            if (!$('.dataTables_empty').length) {
                $('#menu-toggle').click();
            }
            new $.fn.dataTable.Buttons(table, {
                buttons: [
                    {
                        extend: 'print',
                        customize: function (win) {
                            $(win.document.body).find('table')
                                .addClass('compact').addClass('printable!important')
                                .css('font-size', 'inherit');
                        },
                        exportOptions: {
                            columns: ':visible'
                        }
                    },
                    {
                        extend: 'excelHtml5',
                        exportOptions: {
                            columns: ':visible'
                        }
                    },
                    'pdf',
                    'colvis',

                ]
            });

            table.buttons(0, null).container().prependTo(
                table.table().container()
            );

        }

        //document.getElementById("btnPrint").onclick = function () {
        //    $wrapper.insertBefore($placeholder);
        //    printElement(document.getElementById("printThis"));
        //    var modThis = document.querySelector("#printSection .modifyMe");
        //    modThis.appendChild(document.createTextNode(" "));

        //    //var w = window.open();
        //    //var html = $("#toNewWindow").html();

        //    //$(w.document.body).html(html);
        //    //w.print();

        //    window.print();
        //    $wrapper.detach();
        //    $('#printSection').remove();

        //}

        function printElement(elem, append, delimiter) {
            var domClone = elem.cloneNode(true);

            var $printSection = document.getElementById("printSection");

            if (!$printSection) {
                $printSection = document.createElement("div");
                $printSection.id = "printSection";
                document.body.appendChild($printSection);
            }

            if (append !== true) {
                $printSection.innerHTML = "";
            }

            else if (append === true) {
                if (typeof (delimiter) === "string") {
                    $printSection.innerHTML += delimiter;
                }
                else if (typeof (delimiter) === "object") {
                    $printSection.appendChlid(delimiter);
                }
            }

            $printSection.appendChild(domClone);
        }

        $(document).ready(function () {
            closeLeftSidebar();
            formControl.ShowAllFielsAndFullCallendar();
        });

        function ValidaDadosParaEnvio() {
            GuardJs.resetForValidation();
            GuardJs.CheckRangeDateTime(enviar.endDate, enviar.startDate, "Initial date", "End date");
            /*Especifico*/
            @*if (!($('#unitId :selected').val() > 0)) {
                GuardJs.exibirMensagemAlerta("@Resources.Resource.select_the_unit_first");
                return false;
            }*@
            if (!GuardJs.isValid)
                return !GuardJs.isValid;
            GuardJs.esconderMensagem();

            return true;
        }

    </script>
}
