@model SgqSystem.ViewModels.FormularioParaRelatorioViewModel
@{
    ViewBag.Title = "Relatório de coleta";
    var url = Url.Action("Index", "Home");
    var urlTabelaRelatorio = Url.Action("GetEntryByDate", "api/RelatorioColeta");
}

<link href="@Url.Content("~/Content/DataTables/css/jquery.dataTables.min.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/DataTables/css/buttons.dataTables.min.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/DataTables/css/responsive.dataTables.min.css")" rel="stylesheet" />

<div class="page-content-wrapper">
    <div class="page-content">
        @Html.Partial("~/Views/Shared/_FormToQueryFullScreen.cshtml")

        <div id="formBodyContent">
            @Html.Partial("~/Views/Shared/_mensagemObrigatorio.cshtml")
            <table id="results" class="display" cellspacing="0" style="width:100%"></table>
        </div>
    </div>
</div>

@section Scripts {

    @Scripts.Render("~/Scripts/GuardJs.js")
    @Scripts.Render("~/bundles/ScriptTables")

    <script type="text/javascript">

        var url1 = '@Html.Raw(@urlTabelaRelatorio)';
        var $btn = $('#btnSend');
        $('#simpleCallendar').hide().attr('disabled', true);

        $('button').button({ loadingText: '@Resources.Resource.loading...' });

        $(document).ready(function () {
            $("#btnSend").click(function (e) {
                Send();
            });

            closeLeftSidebar();
            $(".sidebar-toggler").removeClass("hide");
            $(".page-sidebar-wrapper").removeClass("hide");
        });

        function Send() {
            $btn.button('loading');
            $('#results').empty();
            ValidaDadosParaEnvio();

            $.post(url1, enviar, function (r) {
                try {
                    var retornoArray = [];
                    var arrayItarator = r.Retorno;
                    GerarTabela(r.Retorno.ConsolidationLevel01);
                } catch (e) {
                    console.log(e);
                } finally {
                    $btn.button('reset');
                }
            });
        };
        function GerarTabela(retornoArray) {

            var table = $('#results').empty().DataTable({
                data: retornoArray,
                columns: [{ title: "Unit", mData: "Unit" },
                    { title: "Department", mData: "Departamento" },
                    { title: "Auditor", mData: "Auditor" },
                    { title: "Level01", mData: "Level01" },
                    { title: "Level02", mData: "Level02name" },
                    { title: "Evaluated", mData: "avaliado" },
                    { title: "Phase", mData: "Phase" },
                    { title: "Shift", mData: "Shift" },
                    { title: "Sample", mData: "Sample" },
                    { title: "Date", mData: "AddDate" },
                    { title: "NotEvaluated", mData: "NotEvaluatedIs" },
                    { title: "Level03", mData: "Level03Name" },
                    { title: "Is Conformed", mData: "ConformedIs" },
                    { title: "Value", mData: "Value" },
                    { title: "ValueText", mData: "ValueText" },
                ],
                "columnDefs": [
                    { "className": "dt-center", "targets": "_all" }
                ],
                scrollX: true,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                pageLength: 10,
                loadingRecords: true,
                destroy: true,
                info: true,
                responsive: true,
                initComplete: function () {
                    $('#loading').hide();
                    setTimeout(function (e) {
                        var oTable = $('#results').dataTable();
                        if (oTable.length > 0) {
                            oTable.fnAdjustColumnSizing();
                        }
                    }, 100);
                }
            });

            new $.fn.dataTable.Buttons(table, {
                buttons: [
                    {
                        extend: 'print',
                        customize: function (win) {
                            $(win.document.body).find('table')
                                .addClass('compact')
                                .css('font-size', 'inherit');
                        },
                        exportOptions: {
                            columns: ':visible'
                        }
                    },
                    {
                        extend: 'excelHtml5',
                        exportOptions: {
                            columns: ':visible'
                        }
                    },
                    'pdf',
                    'colvis'
                ]
            });

            table.buttons(0, null).container().prependTo(
                table.table().container()
            );

        }
        function ValidaDadosParaEnvio() {
            GuardJs.resetForValidation();
            GuardJs.CheckRangeDateTime(enviar.endDate, enviar.startDate, "Initial date", "End date");
            if (!GuardJs.isValid)
                return;
            GuardJs.esconderMensagem();
        }
        formControl.ShowAllFielsAndFullCallendar();

    </script>

}
