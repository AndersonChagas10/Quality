@model IEnumerable<Dominio.ParModule>

@{
    ViewBag.Title = "Relatório SIF";
}

<style>

    #contentBody .table thead tr th {
        font-size: 10px;
    }

    #contentBody .table > tbody > tr > th {
        font-size: 10px;
    }
</style>

<div class="page-content-wrapper">
    <div class="page-content">

        @Html.Partial("~/Views/Shared/_FormToQueryFullScreen.cshtml")

        <div id="formBodyContent">

            @Html.Partial("~/Views/Shared/_mensagemObrigatorio.cshtml")

            <div class="col-xs-12">

                <div id="loader"></div>

                <div class="portlet light bordered" hidden>
                    @*<div class="portlet-title tabbable-line">
                            <div class="caption">
                                <i class="icon-share font-dark"></i>
                                <span class="caption-subject font-dark bold uppercase">@Resources.Resource.module</span>
                            </div>
                        </div>*@
                    <div class="portlet-body">
                        <div class="tab-content">
                            <div class="tab-pane active" id="setup_tab">

                            </div>
                        </div>
                        <button class="btn btn-primary" id="btnPrint">@Resources.Resource.print</button>
                        <br />
                        <br />
                        <div style="display:none">
                            <div id="contentHeader">
                                <table border="1" cellspacing="0" cellpadding="1" style="width:100%;font-family: 'Century Gothic', CenturyGothic, AppleGothic, sans-serif; font-size:12px;">
                                    <tbody>
                                        <tr>
                                            <td rowspan="3" width="120px" align="center"><img id="printImagemCabecalhoLeft" src="../Imagens/logo-jbs.png" width="80px"></td>
                                            <td id="printTitulo" align="center" style="font-family: 'Century Gothic', CenturyGothic, AppleGothic, sans-serif; font-size:20px;"></td>
                                            <td rowspan="3" width="120px" align="center"><img id="printImagemCabecalhoRight" src="../Imagens/logo-gq.png" width="80px"></td>
                                        </tr>
                                        <tr>
                                            <td><b>Elaborador:</b> <span id="printElaborador"></span></td>
                                        </tr>
                                        <tr>
                                            <td><b>Aprovador:</b> <span id="printAprovador"></span></td>
                                        </tr>
                                    </tbody>
                                </table>

                            </div>
                        </div>

                        <div id="contentFooter" style="display:none">
                            <div>
                                <strong id="printCodigoRodape"></strong>
                            </div>
                        </div>

                        <div id="contentBody">
                            <div style="width:100%;" id="data"></div>

                            <br />

                            <div style="width:100%;" id="horaInicioMonitoramento"></div>
                            <br />

                            <div style="width:100%;">
                                <div style="width:50%;float:left;">Visto: _____________</div>
                                <div style="width:50%;float:right;font-weight:bold;" id="dianteiroOuTraseiro"></div>
                            </div>

                            <br />
                            <br />

                            <table id="tabela1" border="1" class="table table-striped" style="width:11%;float:left"></table>

                            <table id="tabela2" border="1" class="table table-striped" style="width:11%;float:left"></table>

                            <table id="tabela3" border="1" class="table table-striped" style="width:11%;float:left"></table>

                            <table id="tabela4" border="1" class="table table-striped" style="width:11%;float:left"></table>

                            <table id="tabela5" border="1" class="table table-striped" style="width:11%;float:left"></table>

                            <table id="tabela6" border="1" class="table table-striped" style="width:11%;float:left"></table>

                            <table id="tabela7" border="1" class="table table-striped" style="width:11%;float:left"></table>

                            <table id="tabela8" border="1" class="table table-striped" style="width:11%;float:left"></table>

                            <table id="tabela9" border="1" class="table table-striped" style="width:11%;float:left"></table>

                            <div style="clear:both"></div>

                            <div style="display: table; border: 2px solid; font-size:10px; width:100%; height: 60px;">
                                <div style="background-color: #a2a2a2;width: 60%;float: left;padding: 10px; border-right: 2px solid; height:100%;">
                                    OBS: O registro deve conter o horário e as assinaturas ou vistos dos funcionários responsáveis tanto no início quanto no término das atividades de monitoramento efetuadas.
                                </div>
                                <div style="width:40%;float:right;padding: 10px; height:100%;">
                                    <div id="horaFimMonitoramento"></div>
                                    <div id="">Visto: _____________</div>
                                </div>
                            </div>
                            <br />
                            <div style="font-size:10px;">
                                Legenda:
                                <ul>
                                    <li>E - Banda esquerda ; D - Banda direita</li>
                                    <li>0 - Ausência (zero) de contaminal fecal e/ou ingesta</li>
                                    <li>1 - Presença de contaminação fecal e/ou ingesta</li>
                                    <li><span style="font-size: 25px;"> &#8718;</span> Carcaças desviadas para a câmara de seqüestro e reinspecionadas quanto à contaminação no D.I.F ou destinadas a graxaria</li>
                                </ul>

                                <hr />

                                <div>
                                    Número das carcaças enviadas para a câmara de seqüestro: <strong id="nSequestro"></strong>
                                </div>

                                <hr />

                                <div>
                                    Número das carcaças destinadas para a graxaria:____________________________________________________________________________________
                                </div>
                            </div>

                            <hr />
                            <br />
                            <table style="font-size:10px;" border="2">
                                <thead>
                                    <tr>
                                        <th style="width: 30%;text-align:center"><strong>Limite crítico:</strong></th>
                                        <th style="width: 70%;text-align:center"><strong>Ações corretivas:</strong></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="text-align: center;"> - Ausência (zero) de contaminação fecal e/ou ingesta.</td>
                                        <td style="text-align: justify; padding: 10px;">
                                            <strong>Ações corretivas adotadas conforme CRF 9 Part 417.3 </strong><br>
                                            <strong>1. Identificar o desvio e eliminá-lo: </strong> parando a nórea, identificando a localização da contaminação na carcaça e solicitando a remoção da porção contaminada pelo operador;<br>
                                            <strong>2. Assegurar que o PCC estará sob controle após a ação corretiva: </strong> verificar a eficácia da ação corretiva adotada e definindo liberação ou necessidade de nova ação corretiva;<br>
                                            <strong>3. Estabelecer medidas para prevenir recorrência: </strong> informando o desvio ao responsável pelo processo;<br>
                                            <strong>4. Assegurar que qualquer carcaça eventualmente contaminada como resultado do desvio não seja liberada para a etapa seguinte: </strong> Realizar novo monitoramento no quarto (dianteiro ou traseiro) após retirada da contaminação, antes de fazer a sua liberação.<br>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <table border="2" style="width:100%" class="avoid-break-page">
                                <tr><th style="text-align: center;"><strong>Observações:</strong></th></tr>
                                <tr><td>&nbsp;</td></tr>
                                <tr><td>&nbsp;</td></tr>
                                <tr><td>&nbsp;</td></tr>
                                <tr><td>&nbsp;</td></tr>
                                <tr><td>&nbsp;</td></tr>
                                <tr><td>&nbsp;</td></tr>
                            </table>

                            <div style="font-size:10px;">
                                OBS - UTILIZAR PLANILHA AVULSA DE TRATAMENTO DE NÃO CONFORMIDADE (RGQ-00-GQC-126), QUANDO APLICÁVEL.
                            </div>
                            <div class="">
                                <table border="0" cellspacing="0" cellpadding="1" style="width:100%;font-family: 'Century Gothic', CenturyGothic, AppleGothic, sans-serif; font-size:10px;">
                                    <tbody>
                                        <tr>
                                            <td><strong>Assinatura dos responsáveis pela avaliação deste relatório.</strong></td>
                                        </tr>
                                        <tr><td height="30px;"></td></tr>
                                        <tr>
                                            <td height="20px;">
                                                <table width="100%" border="0" cellspacing="0" cellpadding="1" style="font-size:10px;">
                                                    <tbody>
                                                        <tr>
                                                            <td height="20px" width="5%" align="center"></td>
                                                            <td width="20%" align="center" style="border-bottom:1px solid black"></td>
                                                            <td width="5%" align="center"></td>
                                                            <td width="20%" align="center" style="border-bottom:1px solid black"></td>
                                                            <td width="5%" align="center"></td>
                                                            <td width="20%" align="center" style="border-bottom:1px solid black"></td>
                                                            <td width="5%" align="center"></td>
                                                        </tr>
                                                        <tr>
                                                            <td height="20px" width="5%" align="center"></td>
                                                            <td width="20%" align="center">Monitor GQ</td>
                                                            <td width="5%" align="center"></td>
                                                            <td width="20%" align="center">Supevisor do Setor<br>&nbsp;</td>
                                                            <td width="5%" align="center"></td>
                                                            <td width="20%" align="center">Garantia da Qualidade<br>&nbsp;</td>
                                                            <td width="5%" align="center"></td>
                                                        </tr>

                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                        <tr><td><div id="divRodape"><table width="100%" border="0" cellspacing="0" cellpadding="1" style="font-size:10px;"></table></div></td></tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END CONTENT BODY -->
    </div>
</div>

@section Scripts{

    <script src="~/Scripts/Print/printGRT.js"></script>

    <script>

        var $btn = $('#btnSend');
        $('button').button({ loadingText: '@Resources.Resource.loading...' });
        var urlGet = '@Html.Raw(Url.Action("Get", "api/SIFReports"))';
        var siglaUnidade = "";
        exibeTodosLevels = false; //Variavel global para não exibir os monitoramentos sem que selecione o indicador

        $(document).ready(function () {

            closeLeftSidebar();

            $(".sidebar-toggler").removeClass("hide");
            $(".page-sidebar-wrapper").removeClass("hide");

            $('#simpleCallendar input[type="text"]').val(start.format());

            $('#unitId').children('option:first').remove();
            $('#level1Id').children('option:first').remove();
            $('#level2Id').children('option:first').remove();

            formControl.showSimpleDate();
            formControl.showLevel1();
            //formControl.showShift();
            formControl.showUnit();
            formControl.showTipoVisao();

            //$('#showLevel1 > div:nth-child(2)').hide();
            $('#showLevel1 > div:nth-child(3)').hide();

            $("#btnSend").click(function (e) {

                Send(true);

            });

            $('.portlet').hide();

            $('#tipoVisao').trigger('change');

            $('select').select2();

        });


        function Send(toggle) {

            if (formIsValid()) {

                $btn.button('loading');

                $('.portlet').hide();

                EasyAjax(urlGet, enviar, GeraRelatorio, "loader", toggle);
            }

        };

        function GeraRelatorio(obj) {

            $('.portlet').hide();

            if (obj.Dados === null || obj.Dados.length <= 0) {

                GuardJs.exibirMensagemAlerta(Resources("no_data_to_show"));

            } else {

                $('.portlet').show();

                cleanData();

                setData(obj);

                siglaUnidade = obj.Dados[0].Initials;

                var table = "";

                var nSequestro = 0;

                var fontSize = 'style="font-size: 8px !important;"';

                var dividir = Math.ceil(obj.Dados.length / 9);

                for (var i = 0; i < 9; i++) {

                    table = `<thead>"
                            <tr>
                                <th `+ fontSize +`><strong>Nº</strong></th>
                                <th `+ fontSize +`><strong>E</strong></th>
                                <th `+ fontSize +`><strong>D</strong></th>
                            </tr>;
                        "<thead>`

                    table += "<tfoot>";
                    table += "</tfoot>";

                    arr2 = JSON.parse(JSON.stringify(obj.Dados));

                    arr2.splice(dividir, obj.Dados.length);

                    arr2.forEach(function (item) {

                        if (item.Sequestro == 1) {

                            nSequestro++;

                            table += `<tbody>";
                               <tr>
                                    <th `+ fontSize + `>` + item.Numero + `</th>
                                    <th style="background-color:black !important"></th>
                                    <th style="background-color:black !important"></th>
                                </tr>
                              </tbody>`;

                        } else {

                            if (item.Esquerdo != null && item.Direito != null)
                            {

                                table += `<tbody>";
                                   <tr>
                                        <th `+ fontSize + `>` + item.Numero + `</th>
                                        <th `+ fontSize + `>` + item.Esquerdo + `</th>
                                        <th `+ fontSize + `>` + item.Direito + `</th>
                                    </tr>
                                  </tbody>`;

                            } else {

                                table += `<tbody>";
                                   <tr>
                                        <th `+ fontSize + `>` + item.Numero + `</th>
                                        <th `+ fontSize + `></th>
                                        <th `+ fontSize + `></th>
                                    </tr>
                                  </tbody>`;

                            }

                        }

                    });

                    obj.Dados.splice(0, dividir);

                    $('#tabela' + (i + 1)).append(table);

                }

                $("#nSequestro").append(nSequestro);
            }
        }

        function formIsValid() {

            GuardJs.esconderMensagem();

            if (enviar['endDate'] == null || enviar['endDate'] == undefined || enviar['endDate'] == "") {
                GuardJs.exibirMensagemAlerta(Resources("select_the_period_first"));
                return false;

            } else if (enviar['level1Id'] == null || enviar['level1Id'] == undefined || enviar['level1Id'] == "" || enviar['level1Id'] <= 0 || isNaN(enviar['level1Id'])) {
                GuardJs.exibirMensagemAlerta(Resources("select_the_level1"));
                return false;

            } else if (enviar['level2Id'] == null || enviar['level2Id'] == undefined || enviar['level2Id'] == "" || enviar['level2Id'] <= 0 || isNaN(enviar['level2Id'])) {
                GuardJs.exibirMensagemAlerta(Resources("select_the_level2"));
                return false;

            } else if (enviar['unitId'] == null || enviar['unitId'] == undefined || enviar['unitId'] == "" || enviar['unitId'] <= 0) {
                GuardJs.exibirMensagemAlerta(Resources("select_the_unit_first"));
                return false;

            }else {
                return true;
            }

        }

        $('body').on('click', '#btnPrint', function () {
            PrepararImpressao(
                'PCC 1B - MONITORAMENTO DE CONTAMINAÇÃO FECAL E/OU INDIGESTA',
                "Leonardo Matheus Trench" + " - " + "GQU/" + siglaUnidade,
                "Gabriel Nunes" + " - " + "GQU/" + siglaUnidade,
                "RGQ-504-GQU-001/05 Aprov. Em 02/05/2018",
                'contentBody',
                "../Imagens/logo-jbs.png",
                "../Imagens/logo-gq.png");
        });

        function PrepararImpressao(titulo, elaborador, aprovador, codigoRodape, idBody, imagemCabecalhoLeft, imagemCabecalhoRight) {
            $('#printTitulo').html(titulo);
            $("#printElaborador").html(elaborador);
            $("#printAprovador").html(aprovador);
            $("#printCodigoRodape").html(codigoRodape);
            $("#printImagemCabecalhoLeft").attr('src', imagemCabecalhoLeft);
            $("#printImagemCabecalhoRight").attr('src', imagemCabecalhoRight);
            printGRT.Inicializar(
                {
                    headerHtml: document.getElementById('contentHeader').innerHTML,
                    bodyHtml: document.getElementById(idBody).innerHTML,
                    footerHtml: document.getElementById('contentFooter').innerHTML,
                    numberMarginRight: 25,
                    numberMarginBottom: 25,
                    renderTableMargin: 0,
                    pageMarginHeader: "25px 25px 10px 25px",
                    pageMarginFooter: "10px 25px 25px 25px",
                    pageMarginBody: "0 25px 0 25px"
                }
            );

            printGRT.Imprimir();

            $('#divRenderPrint').remove();
        }

        function cleanData() {
            $('#data').empty();
            $('#horaInicioMonitoramento').empty();
            $('#dianteiroOuTraseiro').empty();
            $('#horaFimMonitoramento').empty();
            $("#nSequestro").empty();
            $('#tabela1').empty();
            $('#tabela2').empty();
            $('#tabela3').empty();
            $('#tabela4').empty();
            $('#tabela5').empty();
            $('#tabela6').empty();
            $('#tabela7').empty();
            $('#tabela8').empty();
            $('#tabela9').empty();
        }

        function setData(item) {

            $('#data').append("Data: " + enviar.startDate);

            $('#horaInicioMonitoramento').append("Início do Monitoramento: " + new Date(item.InitialTime).toLocaleTimeString());

            $('#dianteiroOuTraseiro').append($('#level2Id :selected').text().toUpperCase());

            $('#horaFimMonitoramento').append("Horário de Fim do Monitoramento: " + new Date(item.FinalTime).toLocaleTimeString());

            horaFimMonitoramento
        }


    </script>
}
