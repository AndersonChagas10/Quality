@using DTO.DTO.Params


@{
    ViewBag.Title = Resources.Resource.update_tablet_screen;
}


<div class="page-content-wrapper">
    <!-- BEGIN CONTENT BODY -->
    <div class="page-content monitor-get-tela">

        <h2>@Resources.Resource.update_tablet</h2>

        <button class="btn btn-primary" style="color:white" id="updateTablets">@Resources.Resource.update_selected_units</button>
        @*<button class="btn btn-success" id="refreshStatus">Atualizar</button>*@
        <button class="btn btn-info" id="checkAll">@Resources.Resource.select_all</button>
        <spam id="spamLoading" style="display:block;float:right;width:30px;height:30px"></spam>
        <br />
        <br />
        @*Colocar aqui a mensagem obrigatório*@
        @Html.Partial("~/Views/Shared/_mensagemObrigatorio.cshtml")

        @if (ViewBag.UnidadesUsuario != null)
        {
            <table class="table" id="tableAllUnitTelaTablete">

                <thead>
                    <tr>
                        <th></th>
                        <th>ID</th>
                        <th>@Resources.Resource.name</th>
                        <th>@Resources.Resource.initial_date</th>
                        <th>@Resources.Resource.final_date</th>
                        <th>@Resources.Resource.status</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (ParCompanyDTO v in ViewBag.UnidadesUsuario)
                    {
                        <tr data-unit-id="@v.Id">
                            <td><input type="checkbox" value="@v.Id" name="unitId" /></td>
                            <td>@v.Id</td>
                            <td>@v.Name</td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    }
                </tbody>

            </table>
        }
    </div>
</div>


@section Scripts {

    <script>

        $(".sidebar-toggler").removeClass("hide");
        $(".page-sidebar-wrapper").removeClass("hide");
        closeLeftSidebar();
        @if (ViewBag.UpdateTelaTabletRoot == "~") {
            <text>
                const refreshStatusUrl = "@Url.Action("GetGeneratedUnits", "api/AppParams")"
                const urlUpdateTablets = '@Url.Action("UpdateGetTelaThread", "api/AppParams")'
             </text>
        }else
        {
            <text>
                const refreshStatusUrl = "@Html.Raw(ViewBag.UpdateTelaTabletRoot)/GetGeneratedUnits";
                const urlUpdateTablets = "@Html.Raw(ViewBag.UpdateTelaTabletRoot)/UpdateGetTelaThread";
            </text>
        }

        var userUnit;

        $(document).ready(function() {

            var things = { 'ListUnits':@Html.Raw(Json.Encode(ViewBag.IdUnidadesUsuario))};

            userUnit = things.ListUnits;

            var isBtnAtualizar = @Html.Raw(Json.Encode(ViewBag.IsBtnAtualizar));

            things = JSON.stringify(things);

            var refreshStatus = function () {
                $('#spamLoading').LoadingOverlay("show");
                $.ajax(
                    {
                        type: "POST",
                        url: refreshStatusUrl,
                        data: things,
                        dataType: "JSON",
                        contentType: "application/json; charset=utf-8",
                        cache: false,
                        success: function (response) {
                            getDataTable(response);
                            $('#spamLoading').LoadingOverlay("hide");


                            setTimeout(function () {
                                refreshStatus();
                            }, 6000);
                        }
                    });
            };

            var getDataTable = function (response) {

                $('#tableAllUnitTelaTablet').empty();

                var list = [];

                //Gera a lista
                $.each(response, function (index, value) {
                    var row = $('tr[data-unit-id=' + value.Key + ']').children();
                    if (value != null) {
                        list.push([value.Key, value.DataInicioStr, value.DataFimStr, value.StatusStr])
                    } else {
                        list.push([value.Key, "-", "-", "-"])
                    }
                });

                //Atualiza Html
                $.each(list, function (index, value) {
                    var row = $('tr[data-unit-id=' + value[0] + ']').children();
                    $(row[1]).html(value[0]);
                    $(row[3]).html(value[1]);
                    $(row[4]).html(value[2]);
                    $(row[5]).html(value[3]);
                });
            };

            $('#updateTablets').on('click', function () {

                var listId = [];

                $("input:checkbox[name=unitId]:checked").each(function () {
                    listId.push($(this).val());
                });

                if (listId.length <= 0) {

                    GuardJs.exibirMensagemAlerta(Resources("select_the_unit_first"));

                } else {

                    GuardJs.esconderMensagem();

                    $.LoadingOverlay("show");

                    var data = JSON.stringify({ 'ListUnits': listId });

                    $.ajax(
                        {
                            type: "POST",
                            url: urlUpdateTablets,
                            data: data,
                            dataType: "JSON",
                            contentType: "application/json; charset=utf-8",
                            success: function (response) {
                                $.LoadingOverlay("hide");
                            }
                        });

                    $('#updateTablets').LoadingOverlay("show");

                    setTimeout(function () {
                        $('#updateTablets').LoadingOverlay("hide");
                    }, 8000);

                    $('.monitor-get-tela input:checkbox').prop('checked', false);

                }

            });

            var selectedAll = false;

            $('#checkAll').on('click', function () {
                $('.monitor-get-tela input:checkbox').prop('checked', !selectedAll);
                selectedAll = !selectedAll;
            });

            refreshStatus();

            if (isBtnAtualizar)
                setCheckTrue();
        });

        function setCheckTrue() {

            if (userUnit.length == 1) {
                $('#checkAll').trigger('click');
            }
        }

    </script>
}