
@{
    ViewBag.Title = "Index";
    var urlHome = Url.Action("Index", "Home");
}
<style>
    .level3NameDestacado td:first-child {
        color: red !important;
        border: 3px solid #e43a45 !important;
        padding: 2px !important;
        font-weight: bold !important;
    }

    .modal {
        z-index: 9998 !important;
        outline: 0;
    }

    .btnFloatCircleAdd {
        font-size: 32px !important;
        position: fixed;
        z-index: 999;
        bottom: 35px;
        right: 20px;
        height: 60px;
        width: 60px;
        -webkit-border-radius: 70px !important;
        -moz-border-radius: 70px !important;
        border-radius: 70px !important;
    }

    .btnFloatCircleRenew {
        /*font-size: 32px !important;*/
        position: fixed;
        z-index: 999;
        bottom: 35px;
        right: 108px;
        height: 40px;
        width: 40px;
        -webkit-border-radius: 33px !important;
        -moz-border-radius: 33px !important;
        border-radius: 33px !important;
    }

    .btnFloatCirclePrint {
        /*font-size: 32px !important;*/
        position: fixed;
        z-index: 999;
        bottom: 35px;
        right: 180px;
        height: 40px;
        width: 40px;
        -webkit-border-radius: 33px !important;
        -moz-border-radius: 33px !important;
        border-radius: 33px !important;
    }

    .ulIndicador {
        background-color: #f28c0433;
        display: block;
        width: 100%;
    }

    .ulLinha {
        background-color: #00800017;
        display: block;
        width: 100%;
    }


    a.active {
        background-color: rgba(128, 128, 128, 0.36);
    }

    .bgRed {
        background-color: rgba(248, 2, 2, 0.29);
        ;
    }

    .bgGreen {
        background-color: rgba(0, 128, 0, 0.23);
        ;
    }

    .bgYellow {
        background-color: rgba(233, 248, 2, 0.29);
        ;
    }

    .bgWhite {
        background-color: white;
        ;
    }

    .floatinBottonButton {
        position: fixed;
        bottom: 0;
        right: 0;
        width: 100%;
        z-index: 9996;
        display: block;
        visibility: visible;
        margin-top: 70px;
    }

    td {
        position: relative;
        text-align: center;
    }

        td > span.label {
            position: absolute;
            top: 1px;
            bottom: 1px;
            left: 1px;
            right: 1px;
            color: black;
        }

            td > span.label:after {
                content: '';
                height: 100%;
                display: inline-block;
                vertical-align: middle;
                color: black;
            }

    .redDot {
        color: red;
    }
</style>

<div ng-controller="reencravationCtrl as r" class="container page-content " style="min-height: 600px;width:100%;">
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

        <ul class="nav navbar-nav ulIndicador">
            <li class="active" style="margin-left:18px;" ng-repeat="indicador in indicadores track by $index" ng-click="selectIndicador(indicador)">
                <a href="#" ng-class="{active: indicadorSelecionado.Name == indicador.Name}">
                    <span class="" aria-hidden="true"></span> {{indicador.Name}}
                </a>
            </li>
        </ul>

        <ul class="nav navbar-nav ulLinha">
            <li class="active" style="margin-left:18px;" ng-repeat="item in linhas track by $index" ng-click="getLinha($index)" ng-show="item.IsActive == 'True'">
                <a href="#" ng-class="{active: seletedLinha.Name == item.Name}">
                    <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span> {{item.Name}}
                    <span class="glyphicon glyphicon-sound-stereo" aria-hidden="true"></span>
                    <span ng-if="item.IsStoped" class="glyphicon glyphicon-time" aria-hidden="true"></span>
                    <span class="sr-only">(current)</span>
                </a>
            </li>
        </ul>

    </div>

    <br />

    <button ng-if="(seletedLinha.Id > 0)" id="btnStartStop"
            type="button"
            class="floatinBottonButton btn btn-success btn-sm"
            data-toggle="modal"
            data-target="#modalParadaDeLinha"
            ng-init="seletedLinha.ExcedidoTempoLimite = false; TimerOn(true)"
            ng-class="{'btn-success': (seletedLinha.ExcedidoTempoLimite == false), 'btn-danger': (seletedLinha.ExcedidoTempoLimite == true)}"
            title="Para / Reinicia a Linha">
        <span class="glyphicon glyphicon-time" aria-hidden="true">
            <span style="font-family:'Open Sans',sans-serif">&nbsp; Parar / Reiniciar a Linha. Linha parada a {{seletedLinha.LinhaParadaTimer}}</span>
        </span>
    </button>

    <div ng-show="seletedLinha.Id > 0" class="col-lg-12 col-md-12 col-sm-12">

        <form role="form" class="ng-pristine ng-valid">
            <div class="form-group float-label-control col-lg-6 col-md-12 col-sm-12">
                <label for="" class="">Produto</label>
                <br />
                <select ng-change="saveState(true, true); $event.stopPropagation();" ng-disabled="seletedLinha.finalizado" ng-options="item as item.Name for item in produtos track by item.Id" ng-model="seletedLinha.form.Produto" class="form-control select2" data-placeholder="Selecone..." tabindex="-1" aria-hidden="true" style="width:100%!important"></select>
            </div>
            <div class="form-group float-label-control col-lg-3 col-md-12 col-sm-12">
                <label for="">Hora do início da Produção</label>
                <br />
                <input ng-change="saveState(true, true); $event.stopPropagation();" ng-disabled="seletedLinha.finalizado" type="time" class="form-control" placeholder="Hora do início da Produção" ng-model="seletedLinha.form.HoraInicioProducao">
            </div>
            <div class="form-group float-label-control col-lg-3 col-md-12 col-sm-12">
                <label for="">Hora do final da Produção</label>
                <br />
                <input ng-change="saveState(true, true); $event.stopPropagation();" ng-disabled="seletedLinha.finalizado" type="time" class="form-control" placeholder="Hora do final da Produção" ng-model="seletedLinha.form.HoraFimProducao">
            </div>
            <div class="form-group float-label-control col-lg-6 col-md-12 col-sm-12">
                <label for="" class="">Código do produto</label>
                <br />
                <input type="text" ng-change="saveState(true, true); $event.stopPropagation();" ng-disabled="seletedLinha.finalizado" ng-model="seletedLinha.form.CodProduto" class="form-control" style="width:100%!important" />
            </div>
            <div class="form-group float-label-control col-lg-6 col-md-6 col-sm-12">
                <label for="">Data do recebimento das latas</label>
                <br />
                <input ng-change="saveState(true, true); $event.stopPropagation();" ng-disabled="seletedLinha.finalizado" type="date" class="form-control" placeholder="Data do recebimento das latas" ng-model="seletedLinha.form.DataRecebimentoLatas">
            </div>
            <div class="form-group float-label-control col-lg-6 col-md-6 col-sm-12">
                <label for="">Fornecedor da Lata</label>
                <br />
                <select ng-change="saveState(true, true); $event.stopPropagation();" ng-disabled="seletedLinha.finalizado" ng-options="item as item.Name for item in fornecedorLata track by item.Id" ng-model="seletedLinha.form.FornecedorLata" class="form-control select2" data-placeholder="Selecone..." multiple tabindex="-1" aria-hidden="true" style="width:100%!important"></select>
            </div>
            <div class="form-group float-label-control col-lg-6 col-md-6 col-sm-12">
                <label for="">Data do recebimento das tampas/fundos das latas</label>
                <br />
                <input ng-change="saveState(true, true); $event.stopPropagation();" ng-disabled="seletedLinha.finalizado" type="date" class="form-control" placeholder="Data do recebimento das tampas e fundos das latas" ng-model="seletedLinha.form.DataRecebimentoTampasFundosLatas">
            </div>
            <div class="form-group float-label-control col-lg-6 col-md-6 col-sm-12">
                <label for="">Fornecedor das tampas/fundos das latas</label>
                <br />
                <select ng-change="saveState(true, true); $event.stopPropagation();" ng-disabled="seletedLinha.finalizado" ng-options="item as item.Name for item in fornecedorTampaLata track by item.Id" ng-model="seletedLinha.form.FornecedorTampaFundoLata" class="form-control select2" data-placeholder="Selecone..." multiple tabindex="-1" aria-hidden="true" style="width:100%!important"></select>
            </div>
            <div class="form-group float-label-control col-lg-6 col-md-6 col-sm-12">
                <label for="">Tipo da Lata</label>
                <br />
                <select ng-change="saveState(true, true); $event.stopPropagation();" ng-disabled="seletedLinha.finalizado" ng-options="item as item.Name for item in tipoLataLista track by item.Id" ng-model="seletedLinha.form.TipoDeLata" class="form-control select2" data-placeholder="Selecone..." tabindex="-1" aria-hidden="true" style="width:100%!important"></select>
            </div>

            <div class="form-group float-label-control col-lg-12 col-md-12 col-sm-12">

                <div style="" class="form-group float-label-control col-lg-6 col-md-6 col-sm-6">
                    <button ng-disabled="seletedLinha.finalizado" type="button" class="btn btn-success btn-sm" data-toggle="modal" data-target="#modalAssinatura">
                        <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> Finalizar Linha
                    </button>
                    <span ng-show="seletedLinha.finalizado" class="glyphicon glyphicon-user" aria-hidden="true"></span> {{seletedLinha.userFinish.Name}}
                    &nbsp;
                    <span ng-show="seletedLinha.finalizado" class="glyphicon glyphicon-time" aria-hidden="true"></span> {{seletedLinha.dataUserFinish}}
                </div>

                <div style="" class="form-group float-label-control col-lg-6 col-md-6 col-sm-6" ng-show="seletedLinha.finalizado">
                    <button ng-disabled="seletedLinha.isValidated" type="button" class="btn btn-success btn-sm" data-toggle="modal" data-target="#modalAssinaturaValidarLinha">
                        <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> Validar Linha
                    </button>
                    <span ng-show="seletedLinha.isValidated" class="glyphicon glyphicon-user" aria-hidden="true"></span> {{seletedLinha.userValidacao.Name}}
                    &nbsp;
                    <span ng-show="seletedLinha.isValidated" class="glyphicon glyphicon-time" aria-hidden="true"></span> {{seletedLinha.dataUserValidacao}}
                </div>
            </div>
        </form>
    </div>

    <button class="floatinBottonButton btn btn-danger btn-sm"
            ng-show="(saving)">
        <span class="glyphicon glyphicon-time" aria-hidden="true"><span style="font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif">&nbsp; Salvando dados...</span></span>
    </button>

    <div class="col-lg-12 col-md-12 col-sm-12"
         ng-init="seletedLinha.IsStoped = false">
        <div ng-show="seletedLinha.Id > 0 && seletedLinha.latas.length > 0" style="" class="col-lg-6 col-md-6 col-sm-12" ng-repeat="item in seletedLinha.latas track by $index" ng-init="lataIndex = $index" tables>
            <div style="text-align: right; float:left; padding-bottom: 5px; padding-top: 5px; vertical-align: middle; font-size: 18px;">{{item.Name}} <span ng-show="item.HoraDaRetiradaDaLata"> retirada as: {{item.HoraDaRetiradaDaLata}}</span></div>

            <div style="text-align: right; padding-bottom: 5px; padding-top: 5px; float: right; ">

                <button id="correctiveActionBtn"
                        type="button" class="btn btn-danger btn-sm"
                        data-toggle="modal"
                        data-target="#modalCorrectiveAction"
                        title="Gerar Ação Corretiva para {{item.Name}}"
                        ng-show="item.showCorrectiveAction"
                        ng-click="selectLata($index, selectedLata.haveErrors);  newCorrectiveAction()">
                    <span class="glyphicon glyphicon-warning-sign" aria-hidden="true"></span>
                </button>
                <button title="Modo Somente Visualização"
                        type="button"
                        class="btn btn-info btn-sm"
                        data-toggle="modal"
                        data-target="#myModal"
                        ng-show="item.finalizado">
                    <span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>
                </button>
                @*<button type="button" class="btn btn-warning btn-sm" ng-click="cloneLata(seletedLinha, $index)">
                        <span class="glyphicon glyphicon-duplicate" aria-hidden="true"></span>
                    </button>*@
                @*<button type="button" class="btn btn-warning btn-sm" ng-click="cloneLataALot(seletedLinha, $index, 30)">
                        <span class="glyphicon glyphicon-stats" aria-hidden="true"></span>
                    </button>*@
                <button type="button"
                        class="btn btn-warning btn-sm"
                        data-toggle="modal"
                        title="Editar {{item.Name}}"
                        ng-show="!item.finalizado"
                        ng-click="executeDocReady(); selectLata($index)"
                        data-target="#editModal">
                    <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                </button>
                <button type="button" class="btn btn-danger btn-sm" title="Remover {{item.Name}}"
                        ng-show="!item.finalizado"
                        ng-click="deleteLata(seletedLinha, $index)">
                    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                </button>
                <button class="btn btn-success btn-sm"
                        data-toggle="modal"
                        data-target="#modalAssinaturaFinalizaLata"
                        title="Assinar {{item.Name}}"
                        type="button"
                        ng-show="item.liberaAssinaturaLata && !item.finalizado"
                        ng-click="selectLata($index)">
                    <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
                </button>
            </div>

            <table name="visualizacao" style="width: 100%">
                <tbody>

                    <tr>
                        <td style="border:0px solid #cccccc; padding: 2px; text-align: right; font-weight: bold; width:15%">Ponto <span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></td>
                        <td style="border:1px solid #cccccc; padding: 2px; text-align: center; font-weight: bold; background-color:#dddddd; width: 80px !important" ng-repeat="NumberOfPoints in range(seletedLinha.TipoDeLata.NumberOfPoints) track by $index">{{($index+1)}}</td>
                    </tr>

                    <tr ng-repeat="ParLevel3 in item.ListParlevel3 | orderBy : sorterFunc track by $index">
                        <td style="border:1px solid #cccccc; padding: 2px; font-weight: bold;">{{ParLevel3.Name}}</td>
                        <td style="max-width: 80px; border:1px solid #cccccc; padding: 1px; text-align: center;"
                            ng-repeat="NumberOfPoints in range(seletedLinha.TipoDeLata.NumberOfPoints) track by $index"
                            ng-show="((ParLevel3.IsPointLess == true) || (ParLevel3.IsPointLess == false && $index == 0))"
                            colspan="{{( ((ParLevel3.IsPointLess == false) && (ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '1'))  ? seletedLinha.TipoDeLata.NumberOfPoints : 1)}}">

                            @*1 Binário ok
                                2   Número de defeitos ok
                                3   Intervalos ok
                                4   Calculado
                                5   Texto
                                99  NOVO CALCULADO POR OUTRO*@

                            @*1 Binário*@
                            <span style="text-align: left;"
                                  class="label "
                                  ng-if="(ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '1')"
                                  ng-class="{bgWhite: (!(item.ResultValue[ParLevel3.Id][($index +1)] === true) && !(item.ResultValue[ParLevel3.Id][($index +1)] === false)), bgGreen: (item.ResultValue[ParLevel3.Id][($index +1)] === true), bgRed: (item.ResultValue[ParLevel3.Id][($index +1)] === false)}">
                                <span>
                                    <span class="validate" ng-if="item.ResultValue[ParLevel3.Id][($index +1)] === true">
                                        {{ParLevel3.ParLevel3Value[0].ParLevel3BoolTrue.Name}}
                                    </span>
                                    <span class="validate" ng-if="item.ResultValue[ParLevel3.Id][($index +1)] === false">
                                        {{ParLevel3.ParLevel3Value[0].ParLevel3BoolFalse.Name}}
                                    </span>
                                </span>
                            </span>
                            @*2 Número de defeitos*@
                            <span class="label validate" ng-if="(ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '2')">
                                <span>{{item.ResultValue[ParLevel3.Id][($index +1)] || "0"}}</span>
                            </span>
                            @*3 Intervalos*@
                            <span class="label validate"
                                  ng-if="(ParLevel3.ParLevel3Value[0]  && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '3') && (ParLevel3.Id != idEC && ParLevel3.Id != idET)"
                                  ng-class="{bgWhite:  (item.ResultValue[ParLevel3.Id][($index +1)].length == 0), bgYellow: (item.ResultValue[ParLevel3.Id][($index +1)] == 'NA'), bgGreen: (item.ResultValue[ParLevel3.Id][($index +1)] != null) && (ParLevel3.ParLevel3Value[0].IntervalMin <= item.ResultValue[ParLevel3.Id][($index +1)] && item.ResultValue[ParLevel3.Id][($index +1)] <= ParLevel3.ParLevel3Value[0].IntervalMax) , bgRed: (item.ResultValue[ParLevel3.Id][($index +1)] != null) && !(ParLevel3.ParLevel3Value[0].IntervalMin <= item.ResultValue[ParLevel3.Id][($index +1)] && item.ResultValue[ParLevel3.Id][($index +1)] <= ParLevel3.ParLevel3Value[0].IntervalMax) }">
                                <span>{{item.ResultValue[ParLevel3.Id][($index +1)]}}</span>
                            </span>
                            <span class="label validate"
                                  ng-if="(ParLevel3.ParLevel3Value[0]  && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '3') && (ParLevel3.Id == idEC || ParLevel3.Id == idET)"
                                  ng-class="{bgWhite:  (item.ResultValue[ParLevel3.Id][($index +1)].length == 0), bgYellow: (item.ResultValue[ParLevel3.Id][($index +1)] == 'NA') }">
                                <span>{{item.ResultValue[ParLevel3.Id][($index +1)]}}</span>
                            </span>
                            @*4 Calculado*@
                            @*<span class="label " ng-if="(ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '4')">
                                    <span>
                                        <span class="validate">
                                            {{ParLevel3.ResultValue['PontoCalc1' + ($index +1)]}}
                                        </span>
                                        <span ng-if="ParLevel3.ResultValue[('Ponto' + ($index +1)] > 0">
                                            x10^
                                        </span>
                                        <span class="validate">
                                            {{ParLevel3.ResultValue['PontoCalc2' + ($index +1)]}}
                                        </span>
                                    </span>
                                </span>*@
                            @*5 Texto*@
                            <label style="word-wrap: break-word;" class="" ng-if="(ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '5')">
                                @*<span>{{item.ResultValue[ParLevel3.Id][($index +1)]}}</span>*@
                                {{item.ResultValue[ParLevel3.Id][($index +1)]}}
                            </label>
                            @*99 NOVO CALCULADO POR OUTRO*@
                            <span class="label validate"
                                  ng-class="{bgWhite:  (item.ResultValue[ParLevel3.Id][($index +1)].length == 0), bgYellow: (item.ResultValue[ParLevel3.Id][($index +1)] == 'NA'), bgGreen: (item.ResultValue[ParLevel3.Id][($index +1)] != null) && (ParLevel3.ParLevel3Value_OuterList[0].LimInferior <= item.ResultValue[ParLevel3.Id][($index +1)] && item.ResultValue[ParLevel3.Id][($index +1)] <= ParLevel3.ParLevel3Value_OuterList[0].LimSuperior) , bgRed: (item.ResultValue[ParLevel3.Id][($index +1)] != null) && !(ParLevel3.ParLevel3Value_OuterList[0].LimInferior <= item.ResultValue[ParLevel3.Id][($index +1)] && item.ResultValue[ParLevel3.Id][($index +1)] <= ParLevel3.ParLevel3Value_OuterList[0].LimSuperior)}"
                                  ng-if="(ParLevel3.ParLevel3Value_OuterList[0] && ParLevel3.ParLevel3Value_OuterList[0].ParLevel3InputType_Id == '99')">
                                <span>{{item.ResultValue[ParLevel3.Id][($index + 1)]}}</span>
                            </span>
                        </td>
                    </tr>

                </tbody>
            </table>

            <div style="text-align: left; padding-top: 5px; height:40px;">
                <div style="float:left;">
                    <span class="glyphicon glyphicon-user" aria-hidden="true"></span> {{item.userValidacao.Name}}
                </div>
                <div style="float:right;">
                    <span class="glyphicon glyphicon-time" aria-hidden="true"></span> {{item.dataUserValidacao}}
                </div>
            </div>

        </div>

        <br />

        <button ng-show="seletedLinha.Id > 0 && !seletedLinha.finalizado" ng-click="newLata(seletedLinha); executeDocReady(true)" title="Adicionar Lata" class="btn btn-lg btn-warning btnFloatCircleAdd">
            <i id="saveIcon" class="fa fa-plus"></i>
            <i id="loadIcon" class="fa fa-circle-o-notch fa-spin" style="display:none;"></i>
        </button>
        <button ng-show="seletedLinha.Id > 0" ng-click="updateParamsNewLine(activeInLine, true, true, true)" title="Atualizar Parametrização / Nova Coleta" class="btn btn-lg btn-info btnFloatCircleRenew">
            <i id="saveIcon" class="fa fa-undo"></i>
        </button>
        <button ng-show="seletedLinha.Id > 0" ng-click="print()" title="Imprimir" class="btn btn-lg btn-info btnFloatCirclePrint">
            <i id="saveIcon" class="fa fa-print"></i>
        </button>

        @*<button ng-show="seletedLinha.Id > 0" ng-click="getParansLinha(activeInLine, true, true, true)" style="margin: 35px;" class="btn btn-primary btn-sm">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>Adicionar Lata
            </button>
            <button type="button" ng-show="seletedLinha.Id > 0" ng-click="getParansLinha(activeInLine, true, true, true)" class="btn btn-info" style="margin-left: 30px;">
                Atualizar Parametrização / Nova Coleta
            </button>*@
    </div>
    @*<button type="button" ng-click="saveState()" class="btn btn-sucsdfcess btn-lg">
            <span class="glyphicon glyphicon-save-file" aria-hidden="true"></span>POST LINHA
        </button> *@
    @*<button type="button" ng-click="getState()" class="btn btn-sucsdfcess btn-lg">
            <span class="glyphicon glyphicon-save-file" aria-hidden="true"></span>GET TODAS AS LINHAS
        </button>*@
    @*<button type="button" ng-click="getParametrizacaoZeraColeta()" class="btn btn-sucsdfcess btn-lg">
            <span class="glyphicon glyphicon-save-file" aria-hidden="true"></span>Atualizar Parametrização
        </button>*@
    <hr />

    <!-- Modal Edit-->
    <div class="modal fade bd-example-modal-lg" id="editModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Editar Lata</h5>
                    <button ng-click="executeDocReady(true, true)" type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body" style="overflow-x:auto">
                    <span>Horário em que a lata foi retirada da linha</span>
                    <input type="text"
                           class="time form-control"
                           placeholder=""
                           ng-model="selectedLata.HoraDaRetiradaDaLata">
                    <br />
                    <table style="width: 100%">
                        <tbody>

                            <tr>
                                <td style="border:0px solid #cccccc; padding: 2px; text-align: right; font-weight: bold; width:15%">Ponto <span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></td>
                                <td style="border:1px solid #cccccc; padding: 2px; max-width:65px; text-align: center; font-weight: bold; background-color:#dddddd;" ng-repeat="NumberOfPoints in range(seletedLinha.TipoDeLata.NumberOfPoints) track by $index">{{$index + 1}}</td>
                            </tr>
                            @*MOCK*@
                            <tr ng-repeat="ParLevel3 in seletedLinha.ListParlevel3 | orderBy : sorterFunc track by $index" ng-init="parLevel3IndexME = $index" ng-class="{level3NameDestacado: (ParLevel3.Id ==  idOVERLAP)}">


                                <td style="border:1px solid #cccccc; padding: 2px; font-weight: bold;">{{ParLevel3.Name}}</td>
                                <td style="border:1px solid #cccccc; padding: 2px; max-width:65px;"
                                    ng-repeat="NumberOfPoints in range(seletedLinha.TipoDeLata.NumberOfPoints) track by $index"
                                    ng-init="pontoIndexME = $index"
                                    ng-show="((ParLevel3.IsPointLess == true) || (ParLevel3.IsPointLess == false && $index == 0))"
                                    colspan="{{( ((ParLevel3.IsPointLess == false) && (ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '1'))  ? seletedLinha.TipoDeLata.NumberOfPoints : 1)}}">

                                    @*1 Binário ok
                                        2   Número de defeitos ok
                                        3   Intervalos ok
                                        4   Calculado
                                        5   Texto
                                        99  NOVO CALCULADO POR OUTRO*@

                                    @*3 Intervalos NAO EC ET Espessura*@
                                    <span ng-if="((ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '3') && (ParLevel3.Id != idEC && ParLevel3.Id != idET && ParLevel3.Id != idEspessura))">
                                        @*{{ParLevel3}}*@
                                        <span ng-if="((ParLevel3.IsPointLess == true) || (ParLevel3.IsPointLess == false && $index == 0))">
                                            <input style="width:100%;"
                                                   type="text"
                                                   title="Valores aceitáveis entre {{ParLevel3.ParLevel3Value[0].IntervalMin}} e {{ParLevel3.ParLevel3Value[0].IntervalMax}} {{ParLevel3.ParLevel3Value[0].ParMeasurementUnit.Name}}"
                                                   ng-model="selectedLata.ResultValue[ParLevel3.Id][($index +1)]"
                                                   ng-class="{decimal: (ParLevel3.ParLevel3Value[0].ParMeasurementUnit.Id != 10), percentage: (ParLevel3.ParLevel3Value[0].ParMeasurementUnit.Id == 10), bgWhite:  (selectedLata.ResultValue[ParLevel3.Id][($index +1)].length == 0), bgYellow: (selectedLata.ResultValue[ParLevel3.Id][($index +1)] == 'NA'), bgGreen: (selectedLata.ResultValue[ParLevel3.Id][($index +1)] != null) && (ParLevel3.ParLevel3Value[0].IntervalMin <= selectedLata.ResultValue[ParLevel3.Id][($index +1)] && selectedLata.ResultValue[ParLevel3.Id][($index +1)] <= ParLevel3.ParLevel3Value[0].IntervalMax) , bgRed: (selectedLata.ResultValue[ParLevel3.Id][($index +1)] != null) && !(ParLevel3.ParLevel3Value[0].IntervalMin <= selectedLata.ResultValue[ParLevel3.Id][($index +1)] && selectedLata.ResultValue[ParLevel3.Id][($index +1)] <= ParLevel3.ParLevel3Value[0].IntervalMax)}"
                                                   ng-disabled="selectedLata.ResultValue[ParLevel3.Id][($index +1)] == 'NA'"
                                                   id='{{generateIdParaOutroCalculado(ParLevel3, $index)}}' />

                                            <span ng-if="ParLevel3.AllowNA"><input type="checkbox" ng-true-value="'NA'" ng-false-value="" ng-model="selectedLata.ResultValue[ParLevel3.Id][($index +1)]" /> NA </span>
                                        </span>

                                        <input type="text"
                                               style="width:100%; max-width: 65px; display:none"
                                               ng-if="(ParLevel3.IsPointLess == false && $index > 0)"
                                               id='{{generateIdParaOutroCalculado(ParLevel3, $index)}}'
                                               ng-model="selectedLata.ResultValue[ParLevel3.Id][1]" />
                                    </span>

                                    @*3 Intervalos SIM EC ET NAO ESPESSURA MOCK*@
                                    <span ng-if="((ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '3') && (ParLevel3.Id == idEC || ParLevel3.Id == idET) && ParLevel3.Id != idEspessura)">
                                        @*{{ParLevel3}}*@
                                        <span ng-if="((ParLevel3.IsPointLess == true) || (ParLevel3.IsPointLess == false && $index == 0))">
                                            <input style="width:100%;"
                                                   type="text"
                                                   ng-model="selectedLata.ResultValue[ParLevel3.Id][($index +1)]"
                                                   ng-class="{decimal: (ParLevel3.ParLevel3Value[0].ParMeasurementUnit.Id != 10), percentage: (ParLevel3.ParLevel3Value[0].ParMeasurementUnit.Id == 10), bgWhite:  (selectedLata.ResultValue[ParLevel3.Id][($index +1)].length == 0)}"
                                                   ng-disabled="selectedLata.ResultValue[ParLevel3.Id][($index +1)] == 'NA'"
                                                   id='{{generateIdParaOutroCalculado(ParLevel3, $index)}}'
                                                   ng-change="calcularEspessura(selectedLata)"
                                                   legal="{{ParLevel3.Id == idEC ? 'EC' : 'ET'}}" />

                                            <span ng-if="ParLevel3.AllowNA"><input type="checkbox" ng-true-value="'NA'" ng-false-value="" ng-model="selectedLata.ResultValue[ParLevel3.Id][($index +1)]" /> NA </span>
                                        </span>

                                        <input type="text"
                                               style="width:100%; max-width: 65px; display:none"
                                               ng-if="(ParLevel3.IsPointLess == false && $index > 0)"
                                               id='{{generateIdParaOutroCalculado(ParLevel3, $index)}}'
                                               ng-model="selectedLata.ResultValue[ParLevel3.Id][1]" />
                                    </span>

                                    @*3 Intervalos ESPESSURA MOCK*@
                                    <span ng-if="((ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '3') && ParLevel3.Id == idEspessura)">
                                        @*{{ParLevel3}}*@
                                        <span ng-if="((ParLevel3.IsPointLess == true) || (ParLevel3.IsPointLess == false && $index == 0))">
                                            <input style="width:100%;"
                                                   type="text"
                                                   ng-model="selectedLata.ResultValue[ParLevel3.Id][($index +1)]"
                                                   ng-class="{decimal: (ParLevel3.ParLevel3Value[0].ParMeasurementUnit.Id != 10), percentage: (ParLevel3.ParLevel3Value[0].ParMeasurementUnit.Id == 10), bgWhite:  (selectedLata.ResultValue[ParLevel3.Id][($index +1)].length == 0), bgYellow: (selectedLata.ResultValue[ParLevel3.Id][($index +1)] == 'NA'), bgGreen: bgGreenEspessura() , bgRed: bgRedEspessura()}"
                                                   ng-disabled="selectedLata.ResultValue[ParLevel3.Id][($index +1)] == 'NA'"
                                                   id='{{generateIdParaOutroCalculado(ParLevel3, $index)}}'
                                                   ng-change="calcularEspessura(selectedLata)"
                                                   legal="{{ParLevel3.Id == idEC ? 'EC' : 'ET'}}" />

                                            <span ng-if="ParLevel3.AllowNA"><input type="checkbox" ng-true-value="'NA'" ng-false-value="" ng-model="selectedLata.ResultValue[ParLevel3.Id][($index +1)]" /> NA </span>
                                        </span>

                                        <input type="text"
                                               style="width:100%; max-width: 65px; display:none"
                                               ng-if="(ParLevel3.IsPointLess == false && $index > 0)"
                                               id='{{generateIdParaOutroCalculado(ParLevel3, $index)}}'
                                               ng-model="selectedLata.ResultValue[ParLevel3.Id][1]" />
                                    </span>

                                    @*1 Binário*@
                                    <span style="display: block; text-align: left;"
                                          ng-if="(ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '1')"
                                          ng-class="{bgWhite: (!(selectedLata.ResultValue[ParLevel3.Id][($index +1)] === true) && !(selectedLata.ResultValue[ParLevel3.Id][($index +1)] === false)), bgGreen: (selectedLata.ResultValue[ParLevel3.Id][($index +1)] === true), bgRed: (selectedLata.ResultValue[ParLevel3.Id][($index +1)] === false)}">
                                        <span ng-if="((ParLevel3.IsPointLess == true) || (ParLevel3.IsPointLess == false && $index == 0))">
                                            <input type="radio"
                                                   style="width:100%; max-width: 65px;"
                                                   ng-value="true"
                                                   ng-disabled="selectedLata.ResultValue[ParLevel3.Id][($index +1)] == 'NA'"
                                                   ng-model="selectedLata.ResultValue[ParLevel3.Id][($index +1)]"
                                                   @*ng-change="selectedLata.ResultValue[ParLevel3.Id][($index +1)] = 0"*@ />
                                            {{ParLevel3.ParLevel3Value[0].ParLevel3BoolTrue.Name}}
                                            <input type="radio"
                                                   style="width:100%; max-width: 65px;"
                                                   ng-value="false"
                                                   ng-disabled="selectedLata.ResultValue[ParLevel3.Id][($index +1)] == 'NA'"
                                                   ng-model="selectedLata.ResultValue[ParLevel3.Id][($index +1)]"
                                                   @*ng-change="selectedLata.ResultValue[ParLevel3.Id][($index +1)] = 1"*@ />
                                            {{ParLevel3.ParLevel3Value[0].ParLevel3BoolFalse.Name}}
                                            <span ng-if="ParLevel3.AllowNA"><input type="checkbox" ng-true-value="'NA'" ng-false-value="" ng-model="selectedLata.ResultValue[ParLevel3.Id][($index +1)]" /> NA </span>
                                        </span>
                                    </span>

                                    @*4 Calculado*@
                                    @*<span ng-if="(ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '4')">
                                            <span ng-if="((ParLevel3.IsPointLess == true) || (ParLevel3.IsPointLess == false && $index == 0))">
                                                <input title="Valores aceitáveis entre {{ParLevel3.ParLevel3Value[0].IntervalMin}} e {{ParLevel3.ParLevel3Value[0].IntervalMax}}"
                                                       style="width:45%"
                                                       type="text"
                                                       class="decimal"
                                                       ng-model="selectedLata.campoCalc1[ParLevel3.Name][($index +1)]"
                                                       ng-disabled="selectedLata.ResultValue[ParLevel3.Id][('Na' + ($index +1)]"
                                                       ng-class="{bgWhite:  (selectedLata.campoCalc1[ParLevel3.Name][($index +1)].length == 0), bgGreen: (selectedLata.campoCalc1[ParLevel3.Name][($index +1)] != null) && (ParLevel3.ParLevel3Value[0].IntervalMin <= selectedLata.campoCalc1[ParLevel3.Name][($index +1)] && selectedLata.campoCalc1[ParLevel3.Name][($index +1)] <= ParLevel3.ParLevel3Value[0].IntervalMax) , bgRed: (selectedLata.campoCalc1[ParLevel3.Name][($index +1)] != null) && !(ParLevel3.ParLevel3Value[0].IntervalMin <= selectedLata.campoCalc1[ParLevel3.Name][($index +1)] && selectedLata.campoCalc1[ParLevel3.Name][($index +1)] <= ParLevel3.ParLevel3Value[0].IntervalMax)}"
                                                       ng-change="selectedLata.ResultValue[ParLevel3.Id][($index +1)] = (selectedLata.campoCalc1[ParLevel3.Name][($index +1)] * (number|mathPow:selectedLata.campoCalc2[ParLevel3.Name][($index +1)]))" />
                                                <span style="font-size:10px;">x10^</span>
                                                <input title="Valores aceitáveis entre {{ParLevel3.ParLevel3Value[0].IntervalMin}} e {{ParLevel3.ParLevel3Value[0].IntervalMax}}"
                                                       style="width:45%"
                                                       type="text"
                                                       class="decimal"
                                                       ng-model="selectedLata.campoCalc2[ParLevel3.Name][($index +1)]"
                                                       ng-disabled="selectedLata.ResultValue[ParLevel3.Id][('Na' + ($index +1)]"
                                                       ng-class="{bgWhite:  (selectedLata.campoCalc1[ParLevel3.Name][($index +1)].length == 0),  bgGreen: (selectedLata.campoCalc1[ParLevel3.Name][($index +1)] != null) && (ParLevel3.ParLevel3Value[0].IntervalMin <= selectedLata.campoCalc1[ParLevel3.Name][($index +1)] && selectedLata.campoCalc1[ParLevel3.Name][($index +1)] <= ParLevel3.ParLevel3Value[0].IntervalMax) , bgRed: (selectedLata.campoCalc1[ParLevel3.Name][($index +1)] != null) && !(ParLevel3.ParLevel3Value[0].IntervalMin <= selectedLata.campoCalc1[ParLevel3.Name][($index +1)] && selectedLata.campoCalc1[ParLevel3.Name][($index +1)] <= ParLevel3.ParLevel3Value[0].IntervalMax)}"
                                                       ng-change="selectedLata.ResultValue[ParLevel3.Id][($index +1)] = (selectedLata.campoCalc1[ParLevel3.Name][($index +1)] * (number|mathPow:selectedLata.campoCalc2[ParLevel3.Name][($index +1)]))" />

                                                <span ng-if="ParLevel3.AllowNA"><input type="checkbox" ng-model="selectedLata.ResultValue[ParLevel3.Id][('Na' + ($index +1)]" /> NA </span>
                                            </span>
                                        </span>*@

                                    @*2 Número de defeitos*@
                                    <span ng-if="(ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '2')">
                                        <input title="Valores aceitáveis entre {{ParLevel3.ParLevel3Value[0].IntervalMin}} e {{ParLevel3.ParLevel3Value[0].IntervalMax}}"
                                               style="width:100%; max-width: 65px;"
                                               ng-disabled="selectedLata.ResultValue[ParLevel3.Id][($index +1)] == 'NA'"
                                               ng-model="selectedLata.ResultValue[ParLevel3.Id][($index +1)]"
                                               ng-class="{bgWhite:  (selectedLata.campoCalc1[ParLevel3.Name][($index +1)].length == 0), bgGreen: (selectedLata.campoCalc1[ParLevel3.Name][($index +1)] != null) && (ParLevel3.ParLevel3Value[0].IntervalMin <= selectedLata.campoCalc1[ParLevel3.Name][($index +1)] && selectedLata.campoCalc1[ParLevel3.Name][($index +1)] <= ParLevel3.ParLevel3Value[0].IntervalMax) , bgRed: (selectedLata.campoCalc1[ParLevel3.Name][($index +1)] != null) && !(ParLevel3.ParLevel3Value[0].IntervalMin <= selectedLata.campoCalc1[ParLevel3.Name][($index +1)] && selectedLata.campoCalc1[ParLevel3.Name][($index +1)] <= ParLevel3.ParLevel3Value[0].IntervalMax)}"
                                               type="number" />

                                        @*<span ng-if="ParLevel3.AllowNA"><input type="checkbox" ng-true-value="'NA'" ng-false-value="" ng-model="selectedLata.ResultValue[ParLevel3.Id][($index +1)]" /> NA </span>*@
                                    </span>

                                    @*5 Texto*@
                                    <span ng-if="(ParLevel3.ParLevel3Value[0] && ParLevel3.ParLevel3Value[0].ParLevel3InputType_Id == '5')">
                                        <textarea class="form-control input-sm"
                                                  style="width:100%; max-width: 65px;"
                                                  cols="15"
                                                  id="Observacao"
                                                  rows="5"
                                                  ng-model="selectedLata.ResultValue[ParLevel3.Id][($index +1)]"></textarea>
                                    </span>

                                    @*99 NOVO CALCULADO POR OUTRO*@
                                    <span style="width:100%; display: block; text-align: right;"
                                          title="{{ParLevel3.ParLevel3Value_OuterList[0].AceitavelEntreText}}"
                                          ng-show="(ParLevel3.ParLevel3Value_OuterList[0] && ParLevel3.ParLevel3Value_OuterList[0].ParLevel3InputType_Id == '99')"
                                          ng-class="{bgWhite:  (selectedLata.ResultValue[ParLevel3.Id][($index +1)].length == 0), bgYellow: (selectedLata.ResultValue[ParLevel3.Id][($index +1)] == 'NA'), bgGreen: (selectedLata.ResultValue[ParLevel3.Id][($index +1)] != null) && (ParLevel3.ParLevel3Value_OuterList[0].LimInferior <= selectedLata.ResultValue[ParLevel3.Id][($index +1)] && selectedLata.ResultValue[ParLevel3.Id][($index +1)] <= ParLevel3.ParLevel3Value_OuterList[0].LimSuperior) , bgRed: (selectedLata.ResultValue[ParLevel3.Id][($index +1)] != null) && !(ParLevel3.ParLevel3Value_OuterList[0].LimInferior <= selectedLata.ResultValue[ParLevel3.Id][($index +1)] && selectedLata.ResultValue[ParLevel3.Id][($index +1)] <= ParLevel3.ParLevel3Value_OuterList[0].LimSuperior)}">
                                        {{geraIdCalc($index, ParLevel3.ParLevel3Value_OuterList, seletedLinha.latas.indexOf(selectedLata), ParLevel3.Id)}}
                                    </span>
                                </td>

                            </tr>

                        </tbody>
                    </table>
                </div>

                <div class="modal-footer">
                    @*<button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>*@
                    <button type="button" class="btn btn-primary" data-dismiss="modal" ng-click="executeDocReady(true, true)">Fechar</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal Finalizar Lata-->
    <div class="modal fade" id="modalAssinaturaFinalizaLata" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Assinatura</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body" style="overflow-x:auto">

                    <form role="form" class="ng-pristine ng-valid">
                        <div class="form-group float-label-control col-lg-6 col-md-6 col-sm-6">
                            <input type="text" class="form-control" ng-model="user.Name" placeholder="Nome de Usuário" />
                        </div>
                        <div class="form-group float-label-control col-lg-6 col-md-6 col-sm-6">
                            <input type="password" class="form-control" ng-model="user.Password" placeholder="Senha" />
                        </div>
                    </form>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" ng-click="validateUserLata(user)">Validar Assinatura</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Finalizar Linha-->
    <div class="modal fade" id="modalAssinatura" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Assinatura</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body" style="overflow-x:auto">

                    <form role="form" class="ng-pristine ng-valid">
                        <div class="form-group float-label-control col-lg-6 col-md-6 col-sm-6">
                            <input type="text" class="form-control" ng-model="user.Name" placeholder="Nome de Usuário" />
                        </div>
                        <div class="form-group float-label-control col-lg-6 col-md-6 col-sm-6">
                            <input type="password" class="form-control" ng-model="user.Password" placeholder="Senha" />
                        </div>
                    </form>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" ng-click="finsihLine(user)">Validar Assinatura</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ValidarLinha-->
    <div class="modal fade" id="modalAssinaturaValidarLinha" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Assinatura</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body" style="overflow-x:auto">
                    <form role="form" class="ng-pristine ng-valid">
                        <div class="form-group float-label-control col-lg-6 col-md-6 col-sm-6">
                            <input class="form-control input-sm" type="text" ng-model="user.Name" placeholder="Nome de Usuário" />
                        </div>
                        <div class="form-group float-label-control col-lg-6 col-md-6 col-sm-6">
                            <input class="form-control input-sm" type="password" ng-model="user.Password" placeholder="Senha" />
                        </div>
                        <div class="form-group float-label-control col-lg-6 col-md-6 col-sm-6">
                            <textarea class="form-control input-sm" cols="30" id="" rows="5" ng-model="user.Obs" placeholder="Observações e Ações preventivas"></textarea>
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" ng-click="validateLine(user)">Validar Assinatura</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal PrventiveAction-->
    <div class="modal fade" id="modalPreventiveAction" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="preventiveAction">Ação Preventiva</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body" style="overflow-x:auto">
                    <form role="form" class="ng-pristine ng-valid">
                        <span>Ações anteriores para esta Lata:</span>
                        <br />
                        <br />
                        <div class="form-group float-label-control col-lg-12 col-md-12 col-sm-12" ng-repeat="item in selectedLata.listPreventiveAction track by $index">
                            <span style="word-wrap: break-word; max-width:150px;">{{item.AddDate}}: {{item.Content}}</span>
                            <br />
                        </div>
                        <div class="form-group float-label-control col-lg-12 col-md-12 col-sm-12">
                            <textarea class="form-control input-sm" cols="30" id="" rows="5" ng-model="selectedLata.preventiveAction" placeholder="Observações e Ações preventivas"></textarea>
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" ng-click="insertPreventiveAction(); executeDocReady(true, true)" data-dismiss="modal">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    @*modalCorrectiveAction*@
    <div class="modal fade" id="modalCorrectiveAction" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="preventiveAction">Ação Corretiva</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body" style="overflow-x:auto">
                    <form role="form" name="formCA" class="ng-pristine ng-valid">

                        <div class="{{formDefault12}}">
                            <label>Horário de parada da linha</label>
                            <input type="text" class="time form-control" title="Horário de parada da linha" ng-model="seletedLinha.correctiveAction.HorarioDeParada" />
                        </div>

                        <div class="clearfix"></div>

                        <div class="alert alert-warning">
                            <h3>Ação Corretiva</h3>
                            <div class="{{formDefault12}}">
                                <span ng-if="!formCA.DescriptionFailure.$valid" class="redDot">* Campo Obrigatório</span>
                                <br />
                                <label>Descrição da Falha:</label>
                                <textarea ng-disabled="selectedLata.correctiveAction.IsAssinada"
                                          ng-model="selectedLata.correctiveAction.DescriptionFailure"
                                          ng-required="true"
                                          class="form-control custom-control"
                                          name="DescriptionFailure"
                                          rows="3"
                                          style="resize:none"></textarea>
                            </div>
                            <div class="{{formDefault12}}">
                                <span ng-if="!formCA.ImmediateCorrectiveAction.$valid" class="redDot">* Campo Obrigatório</span>
                                <br />
                                <label>Ação Corretiva Imediata:</label>
                                <label ng-show="seletedLinha.correctiveAction.HorarioDeParada"> Ás {{seletedLinha.correctiveAction.HorarioDeParada}} a linha {{seletedLinha.Name}} foi paralizada:</label>
                                <textarea ng-disabled="selectedLata.correctiveAction.IsAssinada"
                                          ng-model="selectedLata.correctiveAction.ImmediateCorrectiveAction"
                                          ng-required="true"
                                          name="ImmediateCorrectiveAction"
                                          class="form-control custom-control"
                                          rows="3"
                                          style="resize:none"></textarea>
                            </div>

                            <div class="{{formDefault12}}">
                                <div ng-show="selectedLata.correctiveAction.IsAssinada">
                                    <button type="button"
                                            class="btn btn-primary"
                                            ng-click="selectedLata.correctiveAction.IsAssinada = false">
                                        Editar Ação Corretiva
                                    </button>
                                </div>
                                <div ng-hide="selectedLata.correctiveAction.IsAssinada">
                                    <input type="text" class="form-control" ng-model="selectedLata.correctiveAction.Assinatura.Name" placeholder="Nome de Usuário" />
                                    <input type="password" class="form-control" ng-model="selectedLata.correctiveAction.Assinatura.Password" placeholder="Senha" />
                                    <button type="button"
                                            class="btn btn-primary"
                                            ng-disabled="(!(selectedLata.correctiveAction.DescriptionFailure) || !(selectedLata.correctiveAction.ImmediateCorrectiveAction))"
                                            ng-click="AssinaCorrectiveAction1()">
                                        Assinar Ação Corretiva
                                    </button>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                        </div>

                        <div class="alert alert-success">
                            <h3>Ação Preventiva</h3>
                            <div class="{{formDefault12}}">
                                <label>Acão Preventiva:</label>
                                <textarea ng-disabled="selectedLata.PreventiveAction.IsAssinada"
                                          ng-model="selectedLata.PreventiveAction.PreventativeMeasure"
                                          class="form-control custom-control"
                                          rows="3"
                                          style="resize:none">
                                </textarea>
                            </div>
                            <div class="{{formDefault12}}">
                                <div ng-show="selectedLata.PreventiveAction.IsAssinada">
                                    <button type="button"
                                            class="btn btn-primary"
                                            ng-click="selectedLata.PreventiveAction.IsAssinada = false">
                                        Editar Ação Preventiva
                                    </button>
                                </div>
                                <div ng-hide="(selectedLata.PreventiveAction.IsAssinada || !selectedLata.PreventiveAction.PreventativeMeasure)">
                                    <input type="text" class="form-control" ng-model="selectedLata.PreventiveAction.Assinatura.Name" placeholder="Nome de Usuário" />
                                    <input type="password" class="form-control" ng-model="selectedLata.PreventiveAction.Assinatura.Password" placeholder="Senha" />
                                    <button type="button"
                                            class="btn btn-primary"
                                            ng-click="AssinaPreventiveAction()">
                                        Assinar Ação Preventiva
                                    </button>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                        </div>


                        <div class="{{formDefault12}}">
                            <label>Horário de liberação da linha</label>
                            <input type="text"
                                   class="time form-control"
                                   title="Horário de liberação da linha"
                                   ng-model="seletedLinha.correctiveAction.HorarioDeLiberacao" />
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" ng-click="saveState(true, true)">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ParadaDeLinha-->
    <div class="modal fade" id="modalParadaDeLinha" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="preventiveAction">Parada na linha: {{seletedLinha.Name}}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body" style="overflow-x:auto">
                    <form role="form" class="ng-pristine ng-valid col-lg-12 col-md-12 col-sm-12">

                        <div class="col-lg-12 col-md-12 col-sm-12">
                            <div class="col-lg-6 col-md-6 col-sm-12">

                                <div class="form-group float-label-control">
                                    <label>Observações</label>
                                    <br />
                                    <textarea placeholder="Observação 1"
                                              type="text"
                                              class="form-control custom-control"
                                              rows="3"
                                              style="resize:none"
                                              ng-model="seletedLinha.RegistroParada.MotivoParada1"></textarea>
                                    <textarea placeholder="Observação 2"
                                              type="text"
                                              class="form-control custom-control"
                                              rows="3"
                                              style="resize:none"
                                              ng-model="seletedLinha.RegistroParada.MotivoParada2"></textarea>
                                    <textarea placeholder="Observação 3"
                                              type="text"
                                              class="form-control custom-control"
                                              rows="3"
                                              style="resize:none"
                                              ng-model="seletedLinha.RegistroParada.MotivoParada3"></textarea>
                                </div>
                            </div>
                        </div>

                        <br />

                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    @*<button type="button" class="btn btn-primary" ng-hide="seletedLinha.IsStoped" ng-click="seletedLinha.IsStoped =  !seletedLinha.IsStoped; saveState();" data-dismiss="modal">Parar Linha</button>*@
                    <button type="button" class="btn btn-primary" ng-show="(seletedLinha.IsStoped)" ng-click="seletedLinha.IsStoped =  false; saveState();" data-dismiss="modal">Retomar ativide da Linha</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    (function () {
        'use strict';

        app.factory('timestampMarker', [function (vm) {
            var timestampMarker = {
                request: function (config) {
                    config.requestTimestamp = new Date().getTime();
                    return config;
                },
                response: function (response) {
                    response.config.responseTimestamp = new Date().getTime();
                    console.log('The request took ' + ((response.config.responseTimestamp - response.config.requestTimestamp) / 1000) + ' seconds.');
                    return response;
                }
            };
            return timestampMarker;
        }]);

        app.factory('loadingOverlay', [function () {
            var loadingOverlay = {
                request: function (config) {
                    //console.log(config)
                    if (config.showLoader)
                        $.LoadingOverlay("show", { zIndex: 9999 });
                    if (config.showLoader == undefined)
                        $.LoadingOverlay("show", { zIndex: 9999 });
                    return config;
                },
                response: function (response) {
                    $.LoadingOverlay("hide");
                    return response;
                }
            }
            return loadingOverlay;
        }]);

        app.config(['$httpProvider', function ($httpProvider) {
            $httpProvider.interceptors.push('timestampMarker');
            $httpProvider.interceptors.push('loadingOverlay');
        }]);

        /*
        START ANGULAR MODULE
        */
        app.controller('reencravationCtrl', ['$scope', '$http', '$timeout',
            function ($scope, $http, $timeout) {
                let vm = $scope



                //TUDO MOCK MOCK
                //vm.idEC = 1263
                //vm.idET =
                //vm.idEC = 1263
                //vm.idET = 1264
                //vm.idOVERLAP = 1262
                //vm.mercado = 1

                vm.idEC = 1263
                vm.idET = 1264
                vm.idEspessura = 1254
                vm.idOVERLAP = 1262
                vm.mercado = 1
                vm.limInferiorEspessura
                vm.limSuperiorEspessura
                vm.valorEt
                vm.valorEc
                vm.calcularEspessura = function (lata) {
                    if (lata.ResultValue[vm.idEC.toString()] && lata.ResultValue[vm.idET.toString()]) {
                        let valorEc = lata.ResultValue[vm.idEC.toString()]
                        let valorEt = lata.ResultValue[vm.idET.toString()]
                        lata["limInferiorEspessura"] = math.eval(`((2*${valorEt["1"]})+(3*${valorEc["1"]}))+0.05`)
                        lata["limSuperiorEspessura"] = math.eval(`((2*${valorEt["1"]})+(3*${valorEc["1"]}))+0.23`)
                    }
                    //console.log(vm.limInferiorEspessura)
                    //console.log(vm.limSuperiorEspessura)
                }
                vm.bgGreenEspessura = function () {
                    return false
                }
                vm.bgRedEspessura = function () {
                    return false
                }
                //FIM TUDO MOCK MOCK

                vm.formDefault = 'form-group float-label-control col-lg-6 col-md-12 col-sm-12'
                vm.formDefault12 = 'form-group float-label-control col-lg-12 col-md-12 col-sm-12'
           
                vm.linhas = [{}]
                vm.produtos = [{}]
                vm.fornecedorLata = [{}]
                vm.fornecedorTampaLata = [{}]
                vm.seletedLinha = { Id: 0 }
                vm.selectedLata = {}
                vm.activeInLine = 0
                vm.getUser = function () {
                    return {
                        Id: GetUsuarioId(),
                        Name: $.grep(getCookie('webControlCookie'), function (a, b) {
                            return a.indexOf('userName') != -1;
                        })[0].split('=')[1],
                        LoadPageTime: moment().format("DD/MM/YYYY HH:mm")

                    }
                }
                vm.userAuditor = vm.getUser()
                vm.getParametrizacaoUrl = '@Url.Action("RecravacaoLinhaApi", "api")'//'http://localhost:57506/api/RecravacaoLinhaApi'

                $scope.sorterFunc = function (item) {
                    //return parseInt(item['Description']);
                    return item['OrderColumn']
                };

                vm.company = GetUnidadeUsuario()

                vm.findWithAttr = function (array, attr, value) {
                    for (var i = 0; i < array.length; i += 1) {
                        if (array[i][attr] === value) {
                            return i
                        }
                    }
                    return -1
                }

                vm.carregaIndicadores = function (showMensagem) {
                    $http({ method: 'GET', url: vm.getParametrizacaoUrl + "?Company=" + vm.company + "&level1Id=0" })
                          .then(function (r) {
                              if (r.data.errors) {
                                  r.data.errors.forEach(function (o) {
                                      toastr.error(o)
                                  })
                              } else {
                                  if (showMensagem)
                                      toastr.success('Indicadores carregados')
                                  vm.indicadores = r.data.model
                              }
                          });
                }


                vm.selectIndicador = function (item) {
                    vm.indicadorSelecionado = item
                    vm.seletedLinha = {}
                    vm.getParametrizacaoLinhas(item.Id)
                }

                //vm.company = GetUnidadeUsuario()
                vm.getAllLinha = function (index, needFindIndex, showMensagem) {
                    //vm.seletedLinha = vm.linhas[index]
                    //vm.activeInLine = vm.seletedLinha.Id
                    //if (needFindIndex)
                    //    index = vm.findWithAttr(vm.linhas, 'Id', vm.activeInLine);
                    vm.linhas.forEach(function (o, c) {
                        $http({ method: 'POST', url: vm.getParametrizacaoUrl, data: o })
                           .then(function (r) {
                               if (r.data.errors) {
                                   r.data.errors.forEach(function (o) {
                                       toastr.error(o)
                                   })
                               } else {
                                   //toastr.success(r.data.resposta)
                                   //console.log(jQuery.parseJSON(r.data.model.ObjectRecravacaoJson))
                                   if (showMensagem)
                                       toastr.success('Recuperadas linhas parametrizadas \n da base de dados')
                                   vm.linhas[c] = r.data.model[0]
                                   vm.linhas[c]["latas"] = []
                                   vm.activeInLine = vm.linhas[c].Id
                                   //vm.executeDocReady(true)
                                   //vm.seletedLinha = { Id: 0 }
                                   //vm.getState()
                               }
                           });
                    })

                    //vm.executeDocReady(true)
                    //vm.$apply()
                }

                vm.insertPreventiveAction = function () {
                    let lata = vm.selectedLata
                    if (lata["listPreventiveAction"] == undefined) {
                        lata["listPreventiveAction"] = []
                    }
                    if (lata.preventiveAction.length) {
                        lata["listPreventiveAction"].push({ AddDate: moment().format("DD/MM/YYYY HH:mm"), Content: lata.preventiveAction })
                        lata.preventiveAction = ''
                        vm.selectedLata = lata
                        vm.saveState()
                    }
                }

                vm.updateParamsNewLine = function (index, needFindIndex, showMensagem, novaLinha) {
                    if (novaLinha)
                        bootbox.confirm({
                            message: "Esta ação atualizará a parametrização e disponibilizará uma nova coleta, a coleta atual será salva e considerada inativa caso não concluída",
                            buttons: {
                                confirm: {
                                    label: 'Sim',
                                    className: 'btn-success'
                                },
                                cancel: {
                                    label: 'Não',
                                    className: 'btn-danger'
                                }
                            },
                            callback: function (result) {
                                if (result)
                                    vm.getParansLinha(index, needFindIndex, showMensagem, novaLinha)
                            }
                        });
                }

                vm.getParansLinha = function (index, needFindIndex, showMensagem, novaLinha) {
                    //vm.seletedLinha = vm.linhas[index]
                    //vm.activeInLine = vm.seletedLinha.Id
                    //if (needFindIndex)

                    index = vm.findWithAttr(vm.linhas, 'Id', vm.seletedLinha.Id);
                    $http({ method: 'POST', url: vm.getParametrizacaoUrl, data: vm.seletedLinha })
                        .then(function (r) {
                            if (r.data.errors) {
                                r.data.errors.forEach(function (o) {
                                    toastr.error(o)
                                })
                            } else {
                                //toastr.success(r.data.resposta)
                                //console.log(jQuery.parseJSON(r.data.model.ObjectRecravacaoJson))
                                if (showMensagem)
                                    toastr.success('Recuperada linha parametrizada \n da base de dados')
                                vm.linhas[index] = r.data.model[0]
                                vm.linhas[index]["latas"] = []
                                vm.seletedLinha = vm.linhas[index]
                                vm.activeInLine = vm.seletedLinha.Id
                                vm.saveState(undefined, undefined, novaLinha)
                                //vm.executeDocReady(true)
                                //vm.seletedLinha = { Id: 0 }
                                //vm.getState()
                            }
                        });

                    //vm.$apply()
                }

                vm.getLinha = function (index, needFindIndex, showMensagem) {
                    //$.LoadingOverlay("show");
                    if (needFindIndex)
                        index = vm.findWithAttr(vm.linhas, 'Id', vm.activeInLine);

                    vm.seletedLinha = vm.linhas[index]
                    if (vm.seletedLinha['StartAuditTime'])
                        vm.seletedLinha['StartAuditTime'] = moment().format("DD/MM/YYYY HH:mm")
                    vm.activeInLine = vm.seletedLinha.Id

                    //vm.executeDocReady(true)
                    vm.getState()

                    //vm.$apply()
                }

                vm.selectLata = function (index, haveErr) {
                    vm.selectedLata = vm.seletedLinha.latas[index]
                    if (haveErr)
                        vm.selectedLata.haveErrors = haveErr
                    else
                        vm.selectedLata.haveErrors = false
                }

                vm.range = function (n) {
                    if (n)
                        return new Array(parseInt(n)) //return new Array(parseInt(n) + 1)
                    else
                        return new Array()
                }

                vm.newLata = function (linha) {
                    for (let i = 0; i < linha.NumberOfHeads; i++) {
                        if (linha["counterDeLatas"] == undefined)
                            linha["counterDeLatas"] = 1
                        linha.latas.push({
                            Name: 'Lata - ' + (linha["counterDeLatas"]),
                            finalizado: false,
                            haveErrors: false,
                            ListParlevel3: JSON.parse(JSON.stringify(linha.ListParlevel3)),
                            StartAuditTime: moment().format("DD/MM/YYYY HH:mm"),
                        })
                        linha.counterDeLatas++
                    }
                }
                vm.cloneLataALot = function (linha, index, repeat) {

                    $.LoadingOverlay("show");
                    for (let i = 0; i < repeat; i++) {
                        vm.cloneLata(linha, index)
                    }
                    $.LoadingOverlay("hide", true);

                }
                vm.cloneLata = function (linha, index) {
                    let cloned = JSON.parse(JSON.stringify(linha.latas[index]))
                    cloned.Name = 'Lata - ' + (linha["counterDeLatas"])
                    linha.latas.push(cloned)
                    linha.counterDeLatas++
                }
                vm.deleteLata = function (linha, index, trashBin) {
                    //if (trashBin)
                    //    linha.latasBin.push(linha.latas[index])
                    linha.latas.splice(index, 1)
                }

                vm.saveStateUrl = '@Url.Action("RecravacaoApi", "api")'//'http://localhost:57506/api/RecravacaoApi'
                vm.saveState = function (notShowLabel, notShowLoader, salvoParaInserirNovaLinha) {
                    let model = vm.linhas.filter(function (s) {
                        return s.Id == vm.activeInLine
                    })[0]
                    if (salvoParaInserirNovaLinha)
                        model['SalvoParaInserirColeta'] = true
                    else
                        model['SalvoParaInserirColeta'] = false


                    model['User'] = vm.userAuditor
                    model['ParLevel1_Id'] = vm.indicadorSelecionado.Id.toString()

                    $http({ method: 'POST', url: vm.saveStateUrl, data: model, showLoader: notShowLoader ? false : true })
                        .then(function (r) {
                            if (r.data.errors) {
                                r.data.errors.forEach(function (o) {
                                    toastr.error(o)
                                })
                            } else {
                                if (!notShowLabel)
                                    toastr.success(r.data.resposta)
                            }
                        });
                }

                //*Carrega DDLs

                vm.getProdutos = function () {
                    //MOCK
                    vm.produtos = []
                    vm.produtos.push({
                        Name: 'Picanha',
                        Id: 1
                    })
                    vm.produtos.push({
                        Name: 'Contra-filé',
                        Id: 2
                    })
                    vm.produtos.push({
                        Name: 'Filé Mignon',
                        Id: 3
                    })
                }
                vm.getFornecedorLata = function () {
                    //MOCK
                    vm.fornecedorLata = []
                    vm.fornecedorLata.push({
                        Name: 'JBS Lins',
                        Id: 1
                    })
                    vm.fornecedorLata.push({
                        Name: 'Outros',
                        Id: 2
                    })
                }
                vm.tipoLata = function () {
                    //MOCK
                    vm.tipoLataLista = []
                    vm.tipoLataLista.push({
                        Name: 'Litografada',
                        Id: 1
                    })
                    vm.tipoLataLista.push({
                        Name: 'Lata Branca',
                        Id: 2
                    })
                }
                vm.getFornecedorTampaLata = function () {
                    //MOCK
                    vm.fornecedorTampaLata = []
                    vm.fornecedorTampaLata.push({
                        Name: 'JBS Lins',
                        Id: 1
                    })
                    vm.fornecedorTampaLata.push({
                        Name: 'Outros',
                        Id: 2
                    })
                }
                //vm.padroesAcaoCorretiva = function () {
                //    //MOCK
                //    vm.padroesAcaoCorretivaList = []
                //    vm.padroesAcaoCorretivaList.push({
                //        Name: 'JBS Lins',
                //        Id: 1
                //    })
                //    vm.padroesAcaoCorretivaList.push({
                //        Name: 'Outros',
                //        Id: 2
                //    })
                //}

                vm.getFornecedorLata()
                vm.getFornecedorTampaLata()
                vm.getProdutos()
                vm.tipoLata()
                //vm.padroesAcaoCorretiva()

                /*GET Todas as linhas cadastradas*/

                vm.getParametrizacaoLinhas = function (idLevel1) {
                    $http({ method: 'GET', url: vm.getParametrizacaoUrl + "?Company=" + vm.company + "&level1Id=" + idLevel1, showLoader: true })
                        .then(function (r) {
                            if (r.data.errors) {
                                r.data.errors.forEach(function (o) {
                                    toastr.error(o)
                                })
                            } else {
                                toastr.success(r.data.resposta)
                                //toastr.success('Recuperada coleta persistida \n na Base de Dados')
                                //console.log(jQuery.parseJSON(r.data.model.ObjectRecravacaoJson))
                                vm.linhas = r.data.model
                                vm.linhas.forEach(function (o, c) {
                                    o["latas"] = []
                                })
                                //vm.executeDocReady(true)
                                vm.getAllLinha()
                                //vm.getState()
                            }
                        });
                }

                /*GET os Dados das linhas cadastradas*/
                vm.getState = function () {
                    $http({ method: 'GET', url: `${vm.saveStateUrl}?Company=${vm.company}&level1Id=${vm.indicadorSelecionado.Id}` })
                        .then(function (r) {
                            if (r.data.errors) {
                                r.data.errors.forEach(function (o) {
                                    toastr.error(o)
                                })
                            } else {
                                toastr.success(r.data.resposta)
                                //console.log(jQuery.parseJSON(r.data.model.ObjectRecravacaoJson))
                                let linhasSalvas = r.data.model//jQuery.parseJSON(r.data.model.ObjectRecravacaoJson)
                                let novaLinha = []
                                //vm.linhas.forEach(function (o, c) {
                                let o = vm.seletedLinha

                                /*Recebe objeto salvo no banco de dados compara se é ativo na parametrização e subistiu caso seja ativo.*/
                                var objetoSalvo = linhasSalvas.filter(function (objArr) {
                                    let s = jQuery.parseJSON(objArr.ObjectRecravacaoJson)
                                    if (s.Id == o.Id && (o.IsActive == "True" || o.IsActive == true) && (s.IsActive == "False" || s.IsActive == false))
                                        s.IsActive = "True"
                                    else if (s.Id == o.Id && (o.IsActive == "False" || o.IsActive == false) && (s.IsActive == "True" || s.IsActive == true))
                                        s.IsActive = "False"

                                    return s.Id == o.Id
                                });
                                if (objetoSalvo.length)
                                    novaLinha.push(JSON.parse(JSON.stringify(jQuery.parseJSON(objetoSalvo[0].ObjectRecravacaoJson))))
                                else
                                    novaLinha.push(JSON.parse(JSON.stringify(o)))
                                //})

                                /**/

                                vm.seletedLinha = JSON.parse(JSON.stringify(novaLinha))[0]

                                if (vm.seletedLinha.form) {
                                    if (vm.seletedLinha.form.HoraInicioProducao)
                                        vm.seletedLinha.form.HoraInicioProducao = new Date(vm.seletedLinha.form.HoraInicioProducao)

                                    if (vm.seletedLinha.form.HoraFimProducao)
                                        vm.seletedLinha.form.HoraFimProducao = new Date(vm.seletedLinha.form.HoraFimProducao)

                                    if (vm.seletedLinha.form.DataRecebimentoLatas)
                                        vm.seletedLinha.form.DataRecebimentoLatas = new Date(vm.seletedLinha.form.DataRecebimentoLatas)

                                    if (vm.seletedLinha.form.DataRecebimentoTampasFundosLatas)
                                        vm.seletedLinha.form.DataRecebimentoTampasFundosLatas = new Date(vm.seletedLinha.form.DataRecebimentoTampasFundosLatas)
                                }

                                let index = vm.findWithAttr(vm.linhas, 'Id', vm.seletedLinha.Id);
                                vm.linhas[index] = vm.seletedLinha

                                vm.seletedLinha = vm.linhas[index]
                                vm.activeInLine = vm.seletedLinha.Id

                                $.LoadingOverlay("hide", true);
                                vm.executeDocReady()
                            }
                        });
                }

                //Não utilizado ainda
                vm.getFormula = function (expressaoArr) {
                    let expressaoFinal = ''
                    //expressaoArr.forEach(function(o, c){
                    for (var i = 0; i < expressaoArr.length; i++) {
                        let o = expressaoArr[i]
                        if (o.Operator == "dados") {
                            expressaoFinal += `(${o.OuterLevel3_Text}) `
                        } else {
                            expressaoFinal += `${o.Operator} `
                        }
                    }
                    //})
                    return expressaoFinal
                }

                //REAL TIME NA INSERÇÃO DE DADOS

                //OTIMIZAR
                vm.geraIdCalc = function (ind, expressaoArr, lataIndex, parlevel3Name) {
                    let expressaoFinal = ''
                    let expressaoCompleta = ''
                    var teste = []
                    let indexMaisUm = ind + 1
                    if (expressaoArr.length == 0)
                        return;

                    for (var i = 0; i < expressaoArr.length; i++) {
                        let o = expressaoArr[i]
                        if (o.Operator == "dados") {
                            let id = `#${o.OuterLevel3_Text}${indexMaisUm}`.replace(/ /g, '').replace('.', '')
                            let valor = parseFloat($(id).val())
                            if (isNaN(parseFloat(valor))) {
                                return ""
                            }
                            expressaoFinal += valor
                        } else {
                            //expressaoCompleta += `${o.Operator}`
                            expressaoFinal += `${o.Operator}`
                        }
                    }

                    let result = math.eval(expressaoFinal.replace(/\s/g, '').replace('=', ''))

                    if (isNaN(result)) {
                        return ""
                    } else {
                        let floatValue = parseFloat(result.toFixed(2))

                        if (vm.selectedLata.ResultValue[parlevel3Name] == undefined)
                            vm.selectedLata.ResultValue[parlevel3Name] = {}

                        vm.selectedLata.ResultValue[parlevel3Name][(indexMaisUm)] = floatValue

                        return floatValue
                    }
                }
                //FIM REAL TIME NA INSERÇÃO DE DADOS

                vm.resultObj = {}
                vm.SetResult = function (result, data, index) {
                    let key = "ParLevel3_Id" + data.ParLevel3_Id.toString() + "ParLevel3Value_Id" + data.Id.toString() + "PontoIndex" + (index + 1)
                    vm.resultObj[key] = { valor: result, ParLEvel3_Id: data.ParLevel3_Id, ParLevel3Value_Id: data.Id }
                }

                //OTIMIZAR
                vm.checkTableBgRed = function ($event) {
                    //console.log($event)
                    vm.selectedLata.haveErrors = $($event.currentTarget).parents('.modal').find('table').find('.bgRed').length ? true : false
                    console.log(vm.selectedLata)
                    console.log(vm.selectedLata.haveErrors)
                }

                //DEPRECIADO
                vm.saveAndClose = function (item, remove) {
                    //console.log(item)
                    //item["liberaAssinaturaLata"] = false
                    let vmItem = item
                    let index = vm.seletedLinha.latas.indexOf(item)
                    let numeroDePontos = vm.seletedLinha.TipoDeLata.NumberOfPoints

                    vm.saveState()
                    return true

                    item = vmItem
                    vm.saveState()
                    return true
                }

                vm.validateUserUrl = '@Url.Action("AuthenticationLogin", "api/User")'//"http://localhost:57506/api/User/AuthenticationLogin"
                //vm.user = { Name: "camilaprata-mtz", Password: "sgq345", Obs: "" }
                vm.user = { Name: "", Password: "" }
                vm.validateUserLata = function () {
                    $http({ method: 'POST', url: vm.validateUserUrl, data: vm.user })
                        .then(function (r) {
                            if (r.data.Retorno) {
                                vm.user = { Name: "", Password: "" }
                                toastr.success("Usuário validado com sucesso!")
                                r.data.Retorno.ParCompanyXUserSgq = []
                                vm.selectedLata.userValidacao = r.data.Retorno
                                vm.selectedLata.dataUserValidacao = moment().format("DD/MM/YYYY HH:mm")
                                vm.selectedLata.finalizado = !vm.selectedLata.finalizado
                                $('.modal').modal('hide')
                                vm.saveState()
                            }
                            else {
                                toastr.error("Usuário ou Senha Inválidos")
                                console.log(r.Mensagem)
                                console.log(r.MensagemExcecao)
                            }
                        });
                }

                vm.validateLine = function () {
                    $http({ method: 'POST', url: vm.validateUserUrl, data: vm.user })
                        .then(function (r) {
                            if (r.data.Retorno) {
                                vm.user = { Name: "", Password: "" }
                                toastr.success("Usuário validado com sucesso!")
                                r.data.Retorno.ParCompanyXUserSgq = []
                                vm.seletedLinha.userValidacao = r.data.Retorno
                                vm.seletedLinha.dataUserValidacao = moment().format("DD/MM/YYYY HH:mm")
                                vm.seletedLinha.isValidated = true
                                vm.seletedLinha.obs = vm.user.Obs
                                $('.modal').modal('hide')
                                let naoFinalizados = vm.seletedLinha.latas.filter(r=> { return !r.finalizado })
                                naoFinalizados.forEach(function (o, c) {
                                    vm.deleteLata(vm.seletedLinha, vm.seletedLinha.latas.indexOf(o))
                                })
                                vm.saveState()
                            }
                            else {
                                toastr.error("Usuário ou Senha Inválidos")
                                console.log(r.Mensagem)
                                console.log(r.MensagemExcecao)
                            }
                        });
                }

                vm.finsihLine = function () {
                    $http({ method: 'POST', url: vm.validateUserUrl, data: vm.user })
                        .then(function (r) {
                            if (r.data.Retorno) {
                                vm.user = { Name: "", Password: "" }
                                toastr.success("Usuário validado com sucesso!")
                                r.data.Retorno.ParCompanyXUserSgq = []
                                vm.seletedLinha.userFinish = r.data.Retorno
                                vm.seletedLinha.dataUserFinish = moment().format("DD/MM/YYYY HH:mm")
                                vm.seletedLinha.finalizado = true
                                vm.seletedLinha.obs = vm.user.Obs
                                $('.modal').modal('hide')
                                vm.saveState()
                            }
                            else {
                                toastr.error("Usuário ou Senha Inválidos")
                                console.log(r.Mensagem)
                                console.log(r.MensagemExcecao)
                            }

                        });
                }

                //vm.getParametrizacaoLinhas()
                vm.carregaIndicadores(true)

                vm.executeDocReady = function (executaVerificacaoParaAcao, save, notShowLabel, notShowLoader) {
                    setTimeout(function () { vm.docReady(executaVerificacaoParaAcao, save, notShowLabel, notShowLoader) }, 325)
                }

                vm.docReady = function (executaVerificacaoParaAcao, save, notShowLabel, notShowLoader) {
                    $('select').select2({ allowClear: true })
                    $('.decimal').each(function (index) {
                        $(this).inputmask("decimal", {
                            rightAlign: true, radixPoint: ',', greedy: false, mask: "9[.99]", digits: 2, allowMinus: false, digitsOptional: false,
                            oncomplete: function (e) {
                                var currVal = $(e.currentTarget).inputmask('unmaskedvalue');
                                if (currVal.length == 4) {
                                    //$(this).next('.inputs').focus().select();
                                    $(this).closest('td').next().find('input').focus().select();
                                }
                            }
                        });
                    })

                    $('.percentage').each(function (index) {
                        $(this).val($(this).val().replace(',', '.'));
                        $(this).inputmask('Regex', {
                            regex: "^[1-9][0-9]?$|^100$", rightAlign: true,
                            oncomplete: function (e) {
                                //var currVal = $(e.currentTarget).inputmask('unmaskedvalue');
                                //if (currVal <= 100currVal.length == 2) {
                                //    //$(this).next('.inputs').focus().select();
                                //    $(this).closest('td').next().find('input').focus().select();
                                //}else if (currVal.length == 3)
                                //    $(this).closest('td').next().find('input').focus().select();
                            }
                        });
                    })

                    $(".time").inputmask({
                        alias: 'hh:mm t',
                        showMaskOnHover: false,
                        showMaskOnFocus: false,
                        //oncomplete: function(){  },
                    })

                    if (executaVerificacaoParaAcao) {
                        vm.seletedLinha.HaveCorrectiveAction = false
                        /*PELO AMOR DE TUDO QUE É MAIS SAGRADO!!!! REMOVER ESTA FUNCIONALIDADE DAQUI E FAZER DE FORMA DESCENTE! CELSO GEA, OBS FUI EU QUE FIZ ISTO.....*/
                        for (let i = 0; i < $('[name=visualizacao]').length; i++) {
                            let table = $('[name=visualizacao]')[i]

                            if ($(table).find('.bgRed:not(.bgWhite, .bgYellow)').length) {
                                vm.seletedLinha.latas[i].showCorrectiveAction = true
                                vm.seletedLinha.HaveCorrectiveAction = true
                            }
                            else
                                vm.seletedLinha.latas[i].showCorrectiveAction = false //$(table).parent().find('#correctiveActionBtn').addClass('ng-hide')

                            vm.seletedLinha.latas[i].liberaAssinaturaLata = ($.grep($(table).find('.validate:visible'), function (o, c) {
                                return $(o).text().trim().length == 0
                            }).length == 0)
                        }
                    }

                    var keyCodes = {
                        'up': 38,
                        'down': 40,
                        'left': 37,
                        'rigth': 39
                    };

                    $(document).ready(function () {
                        $('input').off('keyup').on('keyup', function (e) {
                            if (e.which == keyCodes.rigth) {
                                if ($(this).closest('td').next().find('input').length)
                                    $(this).closest('td').next().find('input').focus().select()
                                else
                                    $(this).closest('tr').find('input:first').focus().select()
                            }
                            else if (e.which == keyCodes.left) {
                                if ($(this).closest('td').prev().find('input').length)
                                    $(this).closest('td').prev().find('input').focus().select()
                                else
                                    $(this).closest('tr').find('input:last').focus().select()
                            }
                            else if (e.which == keyCodes.down) {

                                let inputFound = false
                                let nextTr = $(this).closest('tr').next()

                                do {
                                    if (nextTr.find('input:visible').length == 1) {
                                        nextTr.find('input:visible').focus().select()
                                        inputFound = !inputFound
                                    }
                                    else if (nextTr.find('input:visible').length > 1) {
                                        nextTr.find('td:eq(' + $(this).closest('td').index() + ')').find('input:visible').focus().select()
                                        inputFound = !inputFound
                                    } else if (nextTr.length != 0) {
                                        nextTr = $(nextTr).closest('tr').next()
                                    }
                                    else {
                                        nextTr = $(this).closest('tr').parent().find('tr:first')
                                    }
                                }
                                while (inputFound == false)

                            }
                            else if (e.which == keyCodes.up) {

                                let inputFound = false
                                let nextTr = $(this).closest('tr').prev()

                                do {
                                    if (nextTr.find('input:visible').length == 1) {
                                        nextTr.find('input:visible').focus().select()
                                        inputFound = !inputFound
                                    }
                                    else if (nextTr.find('input:visible').length > 1) {
                                        nextTr.find('td:eq(' + $(this).closest('td').index() + ')').find('input:visible').focus().select()
                                        inputFound = !inputFound
                                    } else if (nextTr.length != 0) {
                                        nextTr = $(nextTr).closest('tr').prev()
                                    }
                                    else {
                                        nextTr = $(this).closest('tr').parent().find('tr:last')
                                    }
                                }
                                while (inputFound == false)

                            }
                        });
                    });

                    if (save)
                        vm.saveState(notShowLabel, notShowLoader)
                }

                vm.newCorrectiveAction = function () {
                    if (vm.selectedLata.correctiveAction == undefined)
                        vm.selectedLata.correctiveAction = {
                            AddDate: moment().format("DD/MM/YYYY HH:mm"),
                            userAuditor: vm.getUser()
                        }
                }

                vm.AssinaCorrectiveAction1 = function (item) {
                    //vm.selectedLata.correctiveAction.Assinatura1.IsAssinada
                    $http({ method: 'POST', url: vm.validateUserUrl, data: vm.selectedLata.correctiveAction.Assinatura })
                       .then(function (r) {
                           if (r.data.Retorno) {
                               vm.user = { Name: "", Password: "" }
                               toastr.success("Usuário validado com sucesso!")
                               r.data.Retorno.ParCompanyXUserSgq = []
                               vm.selectedLata.correctiveAction.IsAssinada = true
                               vm.saveState()
                               //$('.modal').modal('hide')
                               vm.seletedLinha.IsStoped = true;
                               vm.TimerOn(false, vm.saveState(true, true))
                               vm.selectedLata.correctiveAction.Assinatura = { Name: null, Password: null }
                           }
                           else {
                               vm.selectedLata.correctiveAction.IsAssinada = false
                               toastr.error("Usuário ou Senha Inválidos")
                               console.log(r.Mensagem)
                               console.log(r.MensagemExcecao)
                               vm.saveState(true, true)
                           }
                       });
                }

                vm.AssinaPreventiveAction = function (item) {
                    //vm.selectedLata.correctiveAction.Assinatura1.IsAssinada
                    $http({ method: 'POST', url: vm.validateUserUrl, data: vm.selectedLata.PreventiveAction.Assinatura })
                       .then(function (r) {
                           if (r.data.Retorno) {
                               vm.user = { Name: "", Password: "" }
                               toastr.success("Usuário validado com sucesso!")
                               r.data.Retorno.ParCompanyXUserSgq = []
                               vm.selectedLata.PreventiveAction.IsAssinada = true
                               vm.saveState()
                               //$('.modal').modal('hide')
                               vm.seletedLinha.IsStoped = true;
                               vm.TimerOn(false, vm.saveState(true, true))
                               vm.selectedLata.PreventiveAction.Assinatura = { Name: null, Password: null }
                           }
                           else {
                               vm.selectedLata.PreventiveAction.IsAssinada = false
                               toastr.error("Usuário ou Senha Inválidos")
                               console.log(r.Mensagem)
                               console.log(r.MensagemExcecao)
                               vm.saveState(true, true)
                           }
                       });
                }


                vm.fechaCorrectiveAction = function (item) {
                    if (!vm.selectedLata.correctiveAction.IsAssinada) {
                        //vm.selectedLata.correctiveAction.ImmediateCorrectiveAction = ""
                        //vm.selectedLata.correctiveAction.DescriptionFailure = ""
                    }
                }

                vm.TimerOn = function (isLoadData, cb) {
                    if (isLoadData) {
                        vm.seletedLinha.TimeoutParadaLinha = $timeout($scope.onTimeout, 1000);
                    } else if (vm.seletedLinha.IsStoped) {
                        vm.seletedLinha.ExcedidoTempoLimite = false
                        vm.seletedLinha.StartParadaDeLinha = moment();
                        vm.seletedLinha.TimeoutParadaLinha = $timeout($scope.onTimeout, 1000);
                    }
                    if (cb)
                        cb()
                }

                vm.TimerOff = function () {
                    let diffTime = moment().diff(vm.seletedLinha.StartParadaDeLinha)
                    let duration = moment.duration(diffTime);
                    let //years = duration.years(),
                        days = duration.days(),
                        hrs = duration.hours(),
                      mins = duration.minutes(),
                      secs = duration.seconds();
                    vm.seletedLinha.TempoDeLinhaParada = (/*years + ' years ' + */days + ' days ' + hrs + ' hrs ' + mins + ' mins ' + secs + ' sec');
                    $timeout.cancel(vm.seletedLinha.mytimeout);
                }

                $scope.onTimeout = function () {
                    let diffTime = moment().diff(vm.seletedLinha.StartParadaDeLinha)
                    let duration = moment.duration(diffTime);
                    let //years = duration.years(),
                        days = duration.days(),
                        hrs = duration.hours(),
                      mins = duration.minutes(),
                      secs = duration.seconds();

                    //if (hrs > 1)
                    //    vm.seletedLinha.ExcedidoTempoLimite = true

                    //SEM MOCK
                    if (hrs > 1 || days > 0)
                        vm.seletedLinha.ExcedidoTempoLimite = true
                    else
                        vm.seletedLinha.ExcedidoTempoLimite = false

                    //MOCK PARA Testes
                    if (secs > 10)
                        vm.seletedLinha.ExcedidoTempoLimite = true
                    else
                        vm.seletedLinha.ExcedidoTempoLimite = false

                    vm.seletedLinha.LinhaParadaTimer = (/*years + ' years ' + */days + ' Dias ' + hrs + ' Horas ' + mins + ' Minutos ' + secs + ' Segundos');
                    vm.seletedLinha.mytimeout = $timeout($scope.onTimeout, 1000);
                }

                vm.generateIdParaOutroCalculado = function (ParLevel3, index) {
                    return ((ParLevel3.Id + " - " + ParLevel3.Name + (index + 1)).replace(/ /g, '').replace('.', ''))
                }

                vm.saveLogParada = function () {
                    if (vm.seletedLinha.logParada == undefined)
                        vm.seletedLinha.logParada = []

                    vm.seletedLinha.logParada.push(vm.copyObj(vm.seletedLinha.RegistroParada))
                    vm.seletedLinha.RegistroParada = {}
                    vm.TimerOff()
                    vm.saveState()
                }

                vm.copyObj = function (obj) {
                    return JSON.parse(JSON.stringify(obj))
                }

                vm.parseDate = function (date) {
                    return new Date(date);
                }

                vm.parseDateV2 = function (date) {
                    date = new Date(date);
                }

                vm.print = function () {
                    if (vm.indicadorSelecionado && vm.indicadorSelecionado.Id > 0 && vm.seletedLinha && vm.seletedLinha.Id > 0) {
                        let preUrl = '@Url.Action("print", "Recravacao")';
                        let urlPrint = `${preUrl}?indicadorId=${vm.indicadorSelecionado.Id}&linhaId=${vm.seletedLinha.Id}`
                        openInNewTab(urlPrint)
                    }
                }
                function init() {
                    $(document).on('keydown', function (e) {
                        if (e.ctrlKey && (e.key == "p" || e.charCode == 16 || e.charCode == 112 || e.keyCode == 80)) {
                            console.log("Please use the Print PDF button below for a better rendering on the document");
                            e.cancelBubble = true;
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            vm.print()
                        }
                    });
                }
                init();

                /*Não utilizado*/
                vm.$on('$viewContentLoaded', function () {
                    //Here your view content is fully loaded !!
                    //vm.executeDocReady()
                });

                vm.$watch('$viewContentLoaded',
                    function () {
                        setTimeout(function () {
                            //do something
                            //vm.executeDocReady()
                        }, 0);
                    });

                //vm.getParametrizacaoZeraColeta = function () {
                //    $http({ method: 'GET', url: vm.getParametrizacaoUrl + "?Company=" + vm.company })
                //        .then(function (r) {
                //            if (r.data.errors) {
                //                r.data.errors.forEach(function (o) {
                //                    toastr.error(o)
                //                })
                //            } else {
                //                //toastr.success(r.data.resposta)
                //                //console.log(jQuery.parseJSON(r.data.model.ObjectRecravacaoJson))
                //                toastr.success('Recuperadas linhas parametrizadas \n da base de dados')
                //                vm.linhas = r.data.model
                //                vm.linhas.forEach(function (o, c) {
                //                    o["latas"] = []
                //                })
                //                setTimeout(function () { $('select').select2() }, 200)
                //                vm.seletedLinha = { Id: 0 }
                //                //vm.getState()
                //            }
                //        });
                //}

                /*Não utilizado FIM*/

            }])
            .filter('mathPow', function () {
                return function (base, exponent) {
                    return Math.pow(10, exponent);
                }
            })
            .filter('mathPowRev', function () { // Implementar!!!
                return function (base, exponent) {
                    return Math.pow(10, exponent);
                }
            })
            .filter('calculadoPorOutro', function () { // Implementar!!!
                return function (expressaoArr, index, lataIndex, resultNaLata) {
                    let expressaoFinal = ''
                    var teste = []
                    let indexMaisUm = index + 1
                    //expressaoArr.forEach(function (o, c) {
                    for (var i = 0; i < expressaoArr.length; i++) {
                        let o = expressaoArr[i]
                        if (o.Operator == "dados") {
                            let id = `#ParLevel3_Id${o.OuterLevel3_Id}ParLevel3Value_Id${o.OuterLevel3Value_Id}PontoIndex${indexMaisUm}LataIndex${lataIndex}`
                            let valor = parseFloat($(id).val())
                            if (isNaN(parseFloat(valor))) {
                                return ""
                            }
                            expressaoFinal += valor
                        } else {
                            expressaoFinal += `${o.Operator}`
                        }
                    }
                    //})

                    let result = math.eval(expressaoFinal.replace(/\s/g, '').replace('=', ''))
                    return isNaN(result) ? "" : parseFloat(result.toFixed(2))
                    //return vm.addbits(expressaoFinal.replace(/\s/g, ''))
                }
            })
            .filter('reverseAnything', function () {
                return function (items) {
                    if (typeof items === 'undefined') { return; }
                    return angular.isArray(items) ?
                      items.slice().reverse() : // If it is an array, split and reverse it
                      (items + '').split('').reverse().join(''); // else make it a string (if it isn't already), and reverse it
                };
            })
            .directive('tables', ['$timeout', function ($timeout) {
                return function (scope, element, attrs) {
                    if (scope.$last) {
                        //window.alert("im the last!");
                        //$timeout(scope.$emit(scope.executeDocReady(true)), 200);
                    }
                };
            }])

    })();

</script>