@model SgqSystem.ViewModels.FormularioParaRelatorioViewModel
@{
    ViewBag.Title = "Scorecard";
    var url = Url.Action("Index", "Home");
    var urlScorecard = Url.Action("GetScorecard", "api/Scorecard");
    var urlScorecardMock = Url.Action("GetScorecardMock", "api/Scorecard");
}

<style>
    .dataTables_scroll {
        font-size: small;
    }

    table.dataTable {
        margin: 0px !important;
    }

        table.dataTable thead th, table.dataTable thead td {
            padding: 2px 12px !important;
        }


        table.dataTable tbody th, table.dataTable tbody td {
            padding: 2px !important;
        }

    .dataTables_scrollBody {
        border-bottom: 0px !important;
    }
</style>


<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Impressão Relatório Scorecard</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                A impressão deve ser realizada em formato paisagem. Deseja continuar com a impressão?
            </div>
            <div class="modal-footer">
                <button id="fechar" type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                <button id="continuarImpressao" type="button" class="btn btn-primary">Continuar</button>
            </div>
        </div>
    </div>
</div>


<div class="page-content-wrapper">
    <div class="page-content">

        @Html.Partial("~/Views/Shared/_FormToQueryFullScreen.cshtml")

        <div id="formBodyContent">

            @Html.Partial("~/Views/Shared/_mensagemObrigatorio.cshtml")

            <div id="load"></div>

            <div id="divTable"> 

                <table id="results" class="display" cellspacing="0" style="width:100% !important;"></table>

            </div>
        </div>
    </div>
</div>

@section Scripts {

    <script type="text/javascript">

        $('button').button({ loadingText: '@Resources.Resource.loading...' });

        var url1 = '@Html.Raw(@urlScorecard)';
        var $btn = $('#btnSend');
        $('#simpleCallendar').hide().attr('disabled', true);

        $(document).ready(function () {
            $("#btnSend").click(function (e) {
                Send(true);
            });
        });

        function Send(toggle) {

            $btn.button('loading');
            $('#results').empty();
            $('#results').empty();
            $('#divTable').hide();
            $('#SemDados').show();

            if (!ValidaDadosParaEnvio()) {
                $btn.button('reset');
                return;
            }

            $('#divTable').hide();

            enviar["auditorId"] = GetUsuarioId();

            EasyAjax(url1, enviar, GerarTabela, "load", toggle);
        };

        var limitesMid = @Html.Raw(Json.Encode(ViewBag.PercentValueMid));
        var limitesHigh = @Html.Raw(Json.Encode(ViewBag.PercentValueHigh));

        var arrSintShow = [5, 6, 7, 8, 11, 12, 13];
        var arrSintHide = [0, 1, 2, 3, 4, 9, 10];
        var visibilidadeDefault = [];

        arrSintShow.forEach(function (o, c) {
            visibilidadeDefault.push({
                targets: o,
                visible: true
            })
        })

        arrSintHide.forEach(function (o, c) {
            visibilidadeDefault.push({
                targets: o,
                visible: false
            })
        })

        function GerarTabela(retornoArray) {
            debugger
            $('#divTable').show();

            var table = $('#results').empty().DataTable({
                data: retornoArray,
                columns: [{ title: "@Resources.Resource.cluster", mData: "ClusterName" },
                    { title: "@Resources.Resource.structure", mData: "RegionalName" },
                    { title: "@Resources.Resource.company", mData: "ParCompanyName" },
                    { title: "@Resources.Resource.scorecard_type", mData: "TipoScore" },
                    { title: "@Resources.Resource.audit_type", mData: "TipoIndicadorName" },
                    { title: "@Resources.Resource.audit", mData: "Level1Name" },
                    { title: "@Resources.Resource.smp", mData: "AV" },
                    { title: "@Resources.Resource.ncc", mData: "NC" },
                    { title: "@Resources.Resource.group2", mData: "CriterioName" },
                    { title: "@Resources.Resource.points2", mData: "Pontos" },
                    { title: "@Resources.Resource.points_possible", mData: "PontosIndicador" },
                    { title: "@Resources.Resource.goal %", mData: "Meta" },
                    { title: "@Resources.Resource.real %", mData: "Real" },
                    { title: "@Resources.Resource.points_achieved", mData: "PontosAtingidos" },
                    { title: "@Resources.Resource.scorecard", mData: "Scorecard" },
                ],
                destroy: true,
                scrollX: true,
                paginate: false,
                paging: false,
                bSort: false,
                loadingRecords: false,
                destroy: true,
                info: false,
                responsive: true,
                initComplete: function () {
                    $('#loading').hide();
                    setTimeout(function (e) {
                        var oTable = $('#results').dataTable();
                        if (oTable.length > 0) {
                            oTable.fnAdjustColumnSizing();
                        }
                    }, 100);
                },
                createdRow: function (row, data, index) {

                    if (data["Scorecard"] > 99 || (data["CriterioName"] == 'Maior' && (data["AV"] == 0 && data["NC"] == 0))) {
                        // green
                        $('td', row).eq(14).css("background-color", '#33FF33');
                    } else if (data["Scorecard"] < parseInt(limitesMid)) {
                        // red
                        $('td', row).eq(14).css("background-color", '#FF6666');
                    }
                    else if (data["Scorecard"] < parseInt(limitesHigh)) {
                        $('td', row).eq(14).css("background-color", 'yellow');
                    }

                }
            });
            
            new $.fn.dataTable.Buttons(table, {
                buttons: [
                    {
                        extend: 'colvisGroup',
                        text: '@Resources.Resource.synthetic',
                        show: arrSintShow,
                        hide: arrSintHide
                    },
                    {
                        extend: 'colvisGroup',
                        text: '@Resources.Resource.analytical',
                        show: ':hidden'
                    },
                    {
                        extend: 'excelHtml5',
                        exportOptions: {
                            columns: ':visible'
                        }
                    },
                    {
                        extend: 'print',
                        text: '@Resources.Resource.print',
                        action: function (e, dt, button, config) {
                            alert("A impressão deve ser realizada no formato Paisagem! Por favor alterar no momento da impressão.");

                            $.fn.dataTable.ext.buttons.print.action(e, dt, button, config);
                        },
                        exportOptions: {
                            columns: ':visible'
                        },
                        orientation: 'landscape',
                        title: '@Resources.Resource.filtered_report_between_dates' + $("#reportrange").text(),
                        customize: function (win) {
                            $(win.document.body).css('font-size', '45pt'); 
                            $(win.document.body).find('h1').css('text-align', 'left');
                            $(win.document.body).find('h1').text("");
                            $(win.document.body).find('h1').css('margin-bottom', '35px');
                        },
                    }
                ]
            });

            table.buttons(0, null).container().prependTo(
                table.table().container()
            );

            //Filtros por coluna
            $('.dataTable thead th').each(function (i) {
                var title = $('.dataTable thead th').eq($(this).index()).text();
                $(this).html(title + '<br><input type="text" style="font-size:xx-small; color: #555; text-align:center; width:50px" placeholder=" ' + title + '" data-index="' + i + '" />');
            });

            // DataTable
            var table = $('.dataTable').DataTable();

            // Filter event handler
            $(table.table().container()).on('keyup', 'thead input', function () {
                table
                    .column($(this).data('index'))
                    .search(this.value)
                    .draw();
            });

            $('.dt-button.buttons-colvisGroup')[0].click();

        }

        function ValidaDadosParaEnvio() {

            GuardJs.resetForValidation();
            GuardJs.CheckRangeDateTime(enviar.endDate, enviar.startDate, "Initial date", "End date");

            if (!($('#unitId :selected').val() > 0)) {
                GuardJs.exibirMensagemAlerta("@Resources.Resource.select_the_unit_first");
                return false;
            }

            if (!enviar.moduloId > 0) {
                GuardJs.exibirMensagemAlerta("Selecione o Módulo");
                return false;
            }

            if (!GuardJs.isValid)
                return !GuardJs.isValid;

            GuardJs.esconderMensagem();

            return true;
        }

        $(document).ready(function () {
            formControl.showFullCallendar();
            formControl.showUnit();
            formControl.showShift();
            formControl.showModulo();
            closeLeftSidebar();

            $("#unitId").find("option").eq(0).remove();
            //$("#ModuloId").find("option").eq(0).remove();
            $(".sidebar-toggler").removeClass("hide");
            $(".page-sidebar-wrapper").removeClass("hide");
            $('button.refresh-btn-right-top').removeClass("hide");           
            $('#ModuloId').change();
        });
    </script>

}
