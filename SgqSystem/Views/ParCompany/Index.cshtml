@using SgqSystem.Helpers

@{

    ViewBag.Title = @Resources.Resource.company;

    var urlCompany = Url.Action("AddUpdateParCompany", "api/Company"); //URL relativa
    var urlStructure = Url.Action("AddUpdateParStructure", "api/Company"); //URL relativa
    var urlStructureGroup = Url.Action("AddUpdateParStructureGroup", "api/Company"); //URL relativa
    var urlHome = Url.Action("Index", "Home");
    var urlGetListClusterVinculadoClusterGroup = Url.Action("GetListClusterVinculadoClusterGroup", "api/CompanyForm");

}

<div class="page-content-wrapper">
    <!-- BEGIN CONTENT BODY -->
    <div class="page-content" style="min-height: 650px;">
        <!-- BEGIN PAGE HEADER-->
        <!-- BEGIN PAGE TITLE-->
        <h1 class="page-title">
            @Resources.Resource.company_list
        </h1>
        <!-- END PAGE TITLE-->
        <!-- BEGIN PAGE BAR -->
        <div class="page-bar">
            <ul class="page-breadcrumb">
                <li>
                    <a href="@urlHome">Home</a>
                    <i class="fa fa-angle-right"></i>
                </li>
                <li>
                    <span> @Resources.Resource.company </span>
                </li>
            </ul>
            <div class="page-toolbar">
                <!--<div id="dashboard-report-range" class="pull-right tooltips btn btn-fit-height green" data-placement="top" data-original-title="Change dashboard date range">-->
                @*<div id="dashboard-report-range" class="pull-right tooltips btn btn-fit-height green">
                        <i class="fa fa-calendar"></i>&nbsp;
                        <span class="thin uppercase" id="currentDate"></span>&nbsp;
                    </div>*@
            </div>
        </div>

        <div class="row">
            <div class="col-xs-12">
                <div class="portlet light bordered">
                    <div class="portlet-title tabbable-line">
                        <div class="caption">
                            <i class="icon-share font-dark"></i>
                            <span class="caption-subject font-dark bold uppercase">@Resources.Resource.company_list</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="tab-content">
                            <div class="tab-pane active" id="setup_tab">

                                @Html.Partial("~/Views/ParCompany/ParCompany.cshtml")

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

</div>


<div class="modal fade modalCompany" id="modalCompany" role="dialog" style="display: none; background-color: rgba(173, 173, 173, 0.35);">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header modal-header-gray">
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="hide" id="modalCompanyObj">
                        <form>
                            <div class="col-xs-6">

                                <table class="table-erp">
                                    <tbody>
                                        <tr class="row hide">
                                            @Table.GerarColuna(@Html.Editor("parCompanyDTO.Id", new { @id = "parCompanyDTO_Id", @class = "form-control input-sm" }), @Html.Label(Resources.Resource.id), Table.PosicaoLabel.top, null, null)
                                        </tr>
                                        <tr class="row">
                                            @Table.GerarColuna(@Html.Editor("parCompanyDTO.Name", new { htmlAttributes = new { @id = "parCompanyDTO_Name", @class = "form-control input-sm" } }), @Html.Label(Resources.Resource.name), Table.PosicaoLabel.top)
                                        </tr>
                                        <tr class="row">
                                            @Table.GerarColuna(@Html.Editor("parCompanyDTO.Description", new { htmlAttributes = new { @id = "parCompanyDTO_Description", @class = "form-control input-sm" } }), @Html.Label(Resources.Resource.description), Table.PosicaoLabel.top, colspan: 2)
                                        </tr>
                                        <tr class="row">
                                            @Table.GerarColuna(@Html.Editor("parCompanyDTO.Initials", new { htmlAttributes = new { @id = "parCompanyDTO_Initials", @class = "form-control input-sm" } }), @Html.Label(Resources.Resource.initials), Table.PosicaoLabel.top)
                                        </tr>
                                        <tr class="row">
                                            @Table.GerarColuna(@Html.Editor("parCompanyDTO.SIF", new { htmlAttributes = new { @id = "parCompanyDTO_SIF", @class = "form-control input-sm" } }), @Html.Label(Resources.Resource.sif), Table.PosicaoLabel.top)
                                        </tr>
                                        <tr class="row">
                                            @Table.GerarColuna(@Html.Editor("parCompanyDTO.CompanyNumber", new { htmlAttributes = new { @id = "parCompanyDTO_CompanyNumber", @class = "form-control input-sm" } }), @Html.Label(Resources.Resource.company_number), Table.PosicaoLabel.top)
                                        </tr>
                                        <tr class="row">
                                            @Table.GerarColuna(@Html.Editor("parCompanyDTO.IPServer", new { htmlAttributes = new { @id = "parCompanyDTO_IPServer", @class = "form-control input-sm" } }), @Html.Label(Resources.Resource.ip_server), Table.PosicaoLabel.top)
                                        </tr>
                                        <tr class="row">
                                            @Table.GerarColuna(@Html.Editor("parCompanyDTO.DBServer", new { htmlAttributes = new { @id = "parCompanyDTO_DBServer", @class = "form-control input-sm" } }), @Html.Label(Resources.Resource.db_server), Table.PosicaoLabel.top)
                                        </tr>
                                        <tr></tr>
                                    </tbody>
                                </table>

                            </div>
                            <div class="col-xs-6">
                                @*<table class="table-erp">
                                        <tbody>
                                            <tr class="row">
                                                @Table.GerarColuna(@Html.DropDownList("clusterGroupListId", new SelectList(ViewBag.listaParClusterGroup, "Id", "Name"), Resources.Resource.select + "...", new { @id = "clusterGroupListId", @class = "form-control input-sm" }), @Html.Label(Resources.Resource.cluster_group), Table.PosicaoLabel.top)
                                            </tr>

                                            <tr class="row">
                                                @Table.GerarColunaButton(@Html.DropDownList("clusterListId", new SelectList(ViewBag.listaParCluster, "Id", "Name"), Resources.Resource.select + "...", new { @id = "clusterListId", @class = "form-control input-sm" }), @Html.Label(Resources.Resource.cluster), Table.PosicaoLabel.top, button: "<button type='button' data-loading-text='" + Resources.Resource.saving + "' id='' onclick='modalClusterListAdd()' class='btn btn-primary btn-sm margin'><i class='fa fa-plus'></i></button>")
                                            </tr>
                                        </tbody>
                                    </table>*@


                                <table class="table-erp" ng-controller="ClusterGroupCluster">
                                    <tbody>
                                        <tr class="row">
                                            <td class="td-erp" colspan="0">
                                                <label>@Resources.Resource.cluster_group</label>
                                                <div>
                                                    <select id="clusterGroupListId" class="form-control input-sm"
                                                            ng-model="clusterGroupValue" ng-options="c.Id as c.Name for c in clusterGroup | orderBy:'Name' track by c.Id"
                                                            ng-change="GetListClusterVinculadoClusterGroup()">
                                                        <option value="">@Resources.Resource.select</option>
                                                    </select>
                                                </div>
                                            </td>
                                            @*@Table.GerarColuna( , @Html.Label(Resources.Resource.cluster_group), Table.PosicaoLabel.top)*@
                                        </tr>

                                        <tr class="row">
                                            @*@Table.GerarColunaButton(@Html.DropDownList("clusterListId", new SelectList(ViewBag.listaParCluster, "Id", "Name"), Resources.Resource.select + "...", new { @id = "clusterListId", @class = "form-control input-sm" }), @Html.Label(Resources.Resource.cluster), Table.PosicaoLabel.top, button: "<button type='button' data-loading-text='" + Resources.Resource.saving + "' id='' onclick='modalClusterListAdd()' class='btn btn-primary btn-sm margin'><i class='fa fa-plus'></i></button>")*@

                                            <td class="td-erp">
                                                <label>@Resources.Resource.cluster</label>
                                                <div class="input-group">
                                                    <select id="clusterListId" name="clusterListId" class="form-control input-sm"
                                                            ng-model="clusterValue"
                                                            ng-options="cl.Id as cl.Name for cl in cluster | orderBy:'Name' track by cl.Id">
                                                        <option value="">@Resources.Resource.select</option>
                                                    </select>
                                                    <span class="input-group-btn">
                                                        <button type="button" data-loading-text="Salvando" id="" onclick="modalClusterListAdd()" class="btn btn-primary btn-sm margin">
                                                            <i class="fa fa-plus"></i>
                                                        </button>
                                                    </span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>

                                <table class="table-erp table table-condensed table-bordered table-margin" id="clusterList">
                                    <tbody></tbody>
                                </table>

                                <br />

                                <table class="table-erp">
                                    <tbody>
                                        <tr class="row">
                                            @Table.GerarColunaButton(@Html.DropDownList("structureGroupListId", new SelectList(ViewBag.listaParStructureXCompany, "Id", "Name"), Resources.Resource.select + "...", new { @id = "structureGroupListId", @class = "form-control input-sm" }), @Html.Label(Resources.Resource.structure_group), Table.PosicaoLabel.top, button: "<button type='button' data-loading-text='" + Resources.Resource.saving + "' id='btnSaveCompany' onclick='modalStructureGroupListAdd()' class='btn btn-primary btn-sm margin'><i class='fa fa-plus'></i></button>")
                                        </tr>
                                    </tbody>
                                </table>

                                <table class="table-erp table table-condensed table-bordered table-margin" id="structureGroupList">
                                    <tbody></tbody>
                                </table>

                            </div>
                        </form>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default pull-left" onclick="closeCompanyModal()">@Resources.Resource.close</button>
                <button type="button" id="modalCompanySave" class="btn btn-primary pull-right">@Resources.Resource.save</button>
            </div>
        </div>

    </div>
</div>

<script src="~/Angular/ClusterGroupCluster.js"></script>

<script>

    var urlCompany = '@Html.Raw(@urlCompany)';
    var urlStructure = '@Html.Raw(@urlStructure)';
    var urlStructureGroup = '@Html.Raw(@urlStructureGroup)';

    var listaClusterGroup = @Html.Raw(Json.Encode(ViewBag.listaParClusterGroup));
    var listaCluster = @Html.Raw(Json.Encode(ViewBag.listaParCluster));
    var urlGetListClusterVinculadoClusterGroup = '@Html.Raw(@urlGetListClusterVinculadoClusterGroup)';

    $(".sidebar-toggler").removeClass("hide");
    $(".page-sidebar-wrapper").removeClass("hide");

    navbarSelect("navbar2");

    var monthNames = [
        '@Resources.Resource.january',
        '@Resources.Resource.february',
        '@Resources.Resource.march',
        '@Resources.Resource.april',
        '@Resources.Resource.may',
        '@Resources.Resource.june',
        '@Resources.Resource.july',
        '@Resources.Resource.august',
        '@Resources.Resource.september',
        '@Resources.Resource.october',
        '@Resources.Resource.november',
        '@Resources.Resource.december'];

    function twoDigits(str) {
        str = ("000" + str).slice(-2);
        return str;
    }

    function watcher() {

        var date = new Date();
        var day = date.getDate();
        var monthIndex = date.getMonth();
        var year = date.getFullYear();
        var hour = date.getHours();
        var minute = date.getMinutes();
        var second = date.getSeconds();

        $("#currentDate").text(twoDigits(day) + ' @Resources.Resource.of ' + monthNames[monthIndex] + ' @Resources.Resource.of ' + year + ' ' + twoDigits(hour) + ':' + twoDigits(minute) + ':' + twoDigits(second));

        setTimeout(watcher, 1000);
    }

    watcher();



    var urlCompany = '@Html.Raw(@urlCompany)';

    var indexParCompany = {
        enviarDadosParaApi: function (result) {

            var dados = $('#formParCompany').serializeObject();
            if (result)
                dados = result;

            dados['parCompanyDTO.ListParCompanyXStructure'] = [];
            dados['parCompanyDTO.ListParCompanyCluster'] = [];

            var structureGroupList = $('#structureGroupList').children('tbody').children('tr');

            for (var i = 0; i < structureGroupList.length; i++) {
                var ParCompanyXStructureDTO = { 'ParStructure_Id': $(structureGroupList[i]).attr('value'), 'ParCompany_Id': $('#parCompanyDTO_Id').val() };
                dados['parCompanyDTO.ListParCompanyXStructure'].push(ParCompanyXStructureDTO);
            }

            var companyClusterList = $('#clusterList').children('tbody').children('tr');

            for (var i = 0; i < companyClusterList.length; i++) {
                var ParCompanyClusterDTO = { 'ParCompany_Id': $('#parCompanyDTO_Id').val(), 'ParCluster_Id': $(companyClusterList[i]).attr('value') };
                dados['parCompanyDTO.ListParCompanyCluster'].push(ParCompanyClusterDTO);
            }

            $.post(urlCompany, dados, function (objetoReturn, statusmessage, respostaCompleta) {
                console.log(objetoReturn);
                console.log(statusmessage);
                console.log(respostaCompleta);

                if (objetoReturn["errors"] == undefined) {
                    openMessageModal("@Resources.Resource.saved_successfully","");
                    location.reload();
                }else{
                    openMessageModal("@Resources.Resource.error", objetoReturn.errors);
                    location.reload();
                }

                $.get("GetParCompany", function (data) {
                    $('#formParCompany').replaceWith(data);                    
                });

            }).fail(function (e, h, x) {
                console.log(e);
            });
        },
        editar: function (object) {
            $('#modalCompany .modal-dialog').addClass('modal-xl');
            $('#modalCompany').modal();
            $('#modalCompanyObj').removeClass('hide');
            $('#clusterGroupListId option[value=""]').attr("selected",true);
            $('#clusterListId option[value=""]').attr("selected",true);

            $('#modalCompany .modal-header').text('@Resources.Resource.company');

            for (var key in object) {
                var obj = object[key];
                $('#modalCompanyObj #parCompanyDTO_' + key).val(obj);
            }

            $('#modalCompany #structureGroupList').children('tbody').empty();
            if (object.ListParCompanyXStructure.length > 0) {
                object.ListParCompanyXStructure.forEach(function (value) {
                    $('#modalCompany #structureGroupList').children('tbody').append('<tr value=' + value.ParStructure_Id + '><td>' + value.ParStructure.Name + '<i class="fa fa-close pull-right text-danger" onclick="removeStructureGroupList(' + value.ParStructure_Id + ')" style="margin: 4px;"></i></td></tr>');
                });
            }

            $('#modalCompany #clusterList').children('tbody').empty();
            if (object.ListParCompanyCluster.length > 0) {
                object.ListParCompanyCluster.forEach(function (value) {
                    $('#modalCompany #clusterList').children('tbody').append('<tr value=' + value.ParCluster_Id + '><td>' + value.ParCluster.Name + '<i class="fa fa-close pull-right text-danger" onclick="removeClusterList(' + value.ParCluster_Id + ')" style="margin: 4px;"></i></td></tr>');
                });
            }
        },
        novo: function () {
            $('#modalCompany .modal-dialog').addClass('modal-xl');
            $('#modalCompany').modal();
            $('#modalCompanyObj').removeClass('hide');
            $('#modalCompany #structureGroupList').children('tbody').empty();
            $('#modalCompany #clusterList').children('tbody').empty();
            $('#modalCompany .modal-header').text('@Resources.Resource.new_company');

            $('#modalCompanyObj input, #modalCompanyObj select').val("");
        }
    }

    var indexParStructure = {
        enviarDadosParaApi: function (result) {

            var dados = $('#formParStructure').serializeObject();
            if (result)
                dados = result;

            $.post(urlStructure, dados, function (objetoReturn, statusmessage, respostaCompleta) {
                console.log(objetoReturn);
                console.log(statusmessage);
                console.log(respostaCompleta);

                $.get("GetParStructure", function (data) {
                    $('#formParStructure').replaceWith(data);
                });
            }).fail(function (e, h, x) {
                console.log(e);
            });
        },
        editar: function (object) {
            $('#modalCompany .modal-dialog').removeClass('modal-xl');
            $('#modalCompany').modal();
            $('#modalStructureObj').removeClass('hide');

            $('#modalCompany .modal-header').text('@Resources.Resource.company_structure');

            for (var key in object) {
                var obj = object[key];
                $('#modalStructureObj #parStructureDTO_' + key).val(obj);
            }


        }
    }

    var indexParStructureGroup = {
        enviarDadosParaApi: function (result) {

            var dados = $('#formParStructureGroup').serializeObject();
            if (result)
                dados = result;

            $.post(urlStructureGroup, dados, function (objetoReturn, statusmessage, respostaCompleta) {
                console.log(objetoReturn);
                console.log(statusmessage);
                console.log(respostaCompleta);

                $.get("GetParStructureGroup", function (data) {
                    $('#formParStructureGroup').replaceWith(data);
                });
            }).fail(function (e, h, x) {
                console.log(e);
            });
        },
        editar: function (object) {
            $('#modalCompany .modal-dialog').removeClass('modal-xl');
            $('#modalCompany').modal();
            $('#modalStructureGroupObj').removeClass('hide');

            $('#modalCompany .modal-header').text('@Resources.Resource.structure_group');

            for (var key in object) {
                var obj = object[key];
                $('#modalStructureGroupObj #parStructureGroupDTO_' + key).val(obj);
            }
        }
    }

    $('#modalCompanySave').click(function () {

        if (!$('#modalCompanyObj').hasClass('hide')) {
            indexParCompany.enviarDadosParaApi($('#modalCompanyObj form').serializeObject());
        }
        else if (!$('#modalStructureObj').hasClass('hide')) {
            indexParStructure.enviarDadosParaApi($('#modalStructureObj form').serializeObject());
        }
        else if (!$('#modalStructureGroupObj').hasClass('hide')) {
            indexParStructureGroup.enviarDadosParaApi($('#modalStructureGroupObj form').serializeObject());
        }

        closeCompanyModal();
        //location.reload();
    });

    //Controles dentro do modal
    function closeCompanyModal() {
        $('#modalCompanyObj').addClass('hide');
        $('#modalStructureObj').addClass('hide');
        $('#modalStructureGroupObj').addClass('hide');

        $('#modalCompany').modal('hide');
    }

    function modalClusterListAdd() {
        if ($('#modalCompany #clusterListId :selected').val() != "") {
            if ($('#modalCompany #clusterList').children('tbody').children('tr[value=' + $('#modalCompany #clusterListId :selected').val() + ']').length == 0)
                $('#modalCompany #clusterList').children('tbody').append('<tr value=' + $('#modalCompany #clusterListId :selected').val() + '><td>' + $('#modalCompany #clusterListId :selected').text() + '<i class="fa fa-close pull-right text-danger" onclick="removeClusterList(' + $('#modalCompany #clusterListId :selected').val() + ')" style="margin: 4px;"></i></td></tr>');

            if ($('#modalCompany #clusterList').children('tbody').children('tr[value=' + $('#modalCompany #clusterListId :selected').val() + ']').length == 1)
                $("#modalCompany #btnAddCluster").addClass("disabled");
        }
    }

    function modalStructureGroupListAdd() {
        if ($('#modalCompany #structureGroupListId :selected').val() != "") {
            if ($('#modalCompany #structureGroupList').children('tbody').children('tr[value=' + $('#modalCompany #structureGroupListId :selected').val() + ']').length == 0)
                $('#modalCompany #structureGroupList').children('tbody').append('<tr value=' + $('#modalCompany #structureGroupListId :selected').val() + '><td>' + $('#modalCompany #structureGroupListId :selected').text() + '<i class="fa fa-close pull-right text-danger" onclick="removeStructureGroupList(' + $('#modalCompany #structureGroupListId :selected').val() + ')" style="margin: 4px;"></i></td></tr>');
        }
    }

    function modalRemoveClusterList(value) {
        $('#modalCompany #clusterList').children('tbody').children('tr[value=' + value + ']').remove();
        $("#modalCompany #btnAddCluster").removeClass("disabled");
    }

    function modalRemoveStructureGroupList(value, modal) {
        $('#modalCompany #structureGroupList').children('tbody').children('tr[value=' + value + ']').remove();
    }

</script>

<script>
    $(document).ready(function () {
        closeLeftSidebar();
    });
</script>
