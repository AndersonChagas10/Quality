<h3 class="titulo2">Ajuda</h3>

<form id="ParL3Ajuda">

    <br />
    <div class="row" data-form>

        <div class="col-sm-12">

            <input type="hidden" name="ParLevel3_Id" data-id />
            <input type="hidden" name="IsActive" value="true" data-notnull />

            <div class="form-group">
                <label for="ParCompany_Id">Titulo:</label>
                <input id="txtTituloAjuda" class="input input-lg col-sm-12 required" name="Titulo">
            </div>

        </div>

        <div class="col-sm-12">

            <div class="form-group">
                <label for="ParLevel1_Id">Imagem:</label>
                <input type="file" id="fileAjuda" class="input">
            </div>

        </div>

        <div class="col-sm-12">
            <div class="form-group">
                <label for="ParCompany_Id">Corpo:</label>
                <div contentEditable="true" id="divAjuda" class="input input-lg col-sm-12" name="Corpo"></div>
            </div>
        </div>

        <div class="col-sm-2">
            <div class="form-group" data-action>
                <label></label>
                <button class="form-control btn btn-primary" data-add>Salvar</button>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="col-sm-12">
            <table id="tableParL3Ajuda" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th class="col-sm-10">
                            Título
                        </th>
                        <th class="col-sm-2">

                        </th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</form>

<script>

    var ParL3Help = {

        //paramtros
        id: 'ParL3Ajuda',
        urlSave: '@Url.Action("PostParLevel3XHelp", "api/ParLevel3Api")',

        load: function (list) {

            let id = this.id;

            apagaCampos(id);
            setInputsInputTypeHidden();

            $('table#table' + id + ' tbody').html('');

            $(list).each(function (i, o) {

                var html = '<tr>';
                html += '<td>' + o.Titulo + '</td>';
                html += '<td><button class="btn btn-sm btn-success" data-table-edit><i class="fa fa-pencil" alt="Editar"></i></button><button class="btn btn-sm btn-danger" data-table-delete alt="Excluir"><i class="fa fa-trash-o"></i></button></td>';
                html += '</tr>';

                $('table#table' + id + ' tbody').append(html);
                $('table#table' + id + ' tbody tr:last').data('sgq', o);

            });
        },
    };

    function Save(obj) {
        openLoader(Resources("please_wait"));
        $.ajax({

            url: ParL3Help.urlSave,
            type: 'POST',
            dataType: "json",
            data: JSON.stringify(obj),
            contentType: "application/json",
            success: function (data) {
                openMessageModal("Feito", "Dados Salvos");
                $('#selectL3').trigger('change');
                closeLoader();

            },
            error: function (request, error) {
                closeLoader();
                openMessageModal("Ocorreu um erro", JSON.stringify(request));
                console.log(error)
            }
        });
    }

    function encodeImageFileAsURL(element, callback) {

        var file = $(element).prop('files')[0];
        var reader = new FileReader();

        reader.onloadend = function () {

            callback(reader.result);

        }

        reader.readAsDataURL(file);
    }

    function setImgBase64ToHtml(imagemBase64) {

        return '<img src="' + imagemBase64 + '"/></div> ';

    }

    //Adicionar os dados no data-form
    $('#' + ParL3Help.id).on('click', '[data-table-edit]', function (e) {
        scrollToForm();
        var obj = $(this).parents('tr').data('sgq');

        apagaCampos(ParL3Help.id);
        preencheCampos(ParL3Help.id + ' [data-form]', '', obj);

        $('#' + ParL3Help.id + ' [data-form]').data('sgq', obj);
        $('#' + ParL3Help.id + ' [data-form]').addClass('alert alert-success');
        $('#' + ParL3Help.id + ' [data-form] [data-action] [data-add]').addClass('hide');

        $('#' + ParL3Help.id + ' [data-form] [data-action]').append('<button class="form-control btn btn-success" data-edit>Salvar</button>');
        $('#' + ParL3Help.id + ' [data-form] [data-action]').append('<button class="form-control btn btn-danger" data-cancel>Cancelar</button>');

    });

    //Adicionar os dados no data-form
    $('#' + ParL3Help.id).on('click', '[data-table-delete]', function (e) {
        e.preventDefault();
        var item = $(this).parents('tr').data('sgq');
        $("#modalExclusao").show();

        $("#excluirItem").off().on('click', function () {
            item.IsActive = false;
            Save(item);
            $("#modalExclusao").hide();
            item = "";
        });
    });

    $(".fecharModal").on('click', function () {
        $("#modalExclusao").hide();
        item = "";
    });

    $('#' + ParL3Help.id).on('click', '[data-cancel]', function (e) {
        apagaCampos(ParL3Help.id);
    });

    //Salvar o campo editado ou cria um novo
    $('#' + ParL3Help.id).on('click', '[data-edit],[data-add]', function (e) {

        if (!formIsValid(ParL3Help.id)) {
            return false
        }

        var obj = $('#' + ParL3Help.id + ' [data-form]').data('sgq');
        var formdata = $('#' + ParL3Help.id + ' [data-form]').serializeFormToObjetc();

        if (!(typeof (obj) == 'undefined')) {
            obj = atualizaValoresDoObjeto(obj, formdata);

        } else {
            obj = null;
            obj = atualizaValoresDoObjeto(obj, formdata);

        }

        Save(obj);
    });

    $('#' + ParL3Help.id + " #fileAjuda").change(function (ev) {

        //TODO: converter a imagem para base64 e inputar na div onde o cursor estiver posicionado
        encodeImageFileAsURL($(this), function (imagemBase64) {

            let divTxt = $("#divAjuda").html();

            $("#divAjuda").html(divTxt + " " + setImgBase64ToHtml(imagemBase64));

        });
    });

</script>