<h3 class="titulo2">Rotina Integração</h3>

<form id="ParDCRotina">

    <br />
    <div class="row" data-form>

        <div class="col-sm-7">

            <input type="hidden" name="IsActive" value="true" data-notnull />

            <input type="hidden" name="ParDepartment_Id" data-id />

            <input type="hidden" name="Id" />

            <div class="col-sm-6">
                <div class="form-group">
                    <label for="Rotina">Rotinas:</label>
                    <select class="form-control required" id="selectRotina" name="RotinaIntegracao_Id"></select>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label for="RotinaName">Nome:</label>
                    <input type="text" class="form-control required" id="RotinaName" name="NameRotina">
                </div>
            </div>

        </div>

        <div id="allObjRotina" class="col-sm-12">
            <div class="row">
                <div class="td-erp">
                    <div id="divBtnSalvar" class="col-sm-6" data-action>
                        <button class="form-control btn btn-primary" data-add>Salvar</button>
                    </div>         
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <table id="tableParDCRotina" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th class="col-sm-2">
                            Nome rotina Integração
                        </th>
                        <th class="col-sm-2">
                            Nome Vinculo
                        </th>
                        <th class="col-sm-2">
                            Ação
                        </th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</form>

<script>

    var lastIdL1 = 0;
    var parDCRotina = {

        //paramtros
        id: 'ParDCRotina',
        urlSave: '@Url.Action("PostRotinaIntegracao", "api/DepartmentXRotinaApi")',

        set: function (obj) {
            $('#' + this.id + ' [data-form]').data('sgq', obj);
        },

        afterCreate: function (data) {
            setSelectLevel1(data);
            $('#selectDCDepartment').val(lastIdL1);
            $('#selectDCDepartment').trigger('change');
        },

        load: function (parDepartmentXRotinaIntegracao) {
            let id = this.id;
            let urlSave = this.urlSave;

            apagaCampos(id);

            $('table#table' + id + ' tbody').html('');
            $('#tableParDCRotina [data-table-edit]').prop('disabled', false);
            $('#tableParDCRotina [data-table-delete]').prop('disabled', false);
            $('#' + id + ' #divBtnCancelar').hide();

            $(parDepartmentXRotinaIntegracao).each(function (i, o) {

                var html = '<tr>';
                html += '<td>' + o.RotinaIntegracao.Name + '</td>';
                html += '<td>' + o.NameRotina + '</td>';
                html += '<td><button class="btn btn-sm btn-success" data-table-edit><i class="fa fa-pencil" alt="Editar"></i></button><button class="btn btn-sm btn-danger" data-table-delete alt="Excluir"><i class="fa fa-trash-o"></i></button></td>';
                html += '</tr>';

                $('table#table' + id + ' tbody').append(html);
                $('table#table' + id + ' tbody tr:last').data('sgq', o);

            });

            function Save(obj) {
                var hasId = obj.Id;
                
                $.ajax({
                    url: urlSave,
                    type: 'POST',
                    dataType: "json",
                    data: JSON.stringify(obj),
                    contentType: "application/json",
                    success: function (data) {
                        lastIdL1 = parseInt(data);
                        $('#selectDCDepartment').trigger('change');
                        openMessageModal("Feito", "Dados Salvos");
                        closeLoader();

                    },
                    error: function (request, error) {
                        closeLoader();
                        openMessageModal("Ocorreu um erro", JSON.stringify(request));
                        console.log(error)
                    }
                });
            }

            $('#' + id).off('click');

            //Salvar o campo editado ou cria um novo
            $('#' + id).on('click', '[data-edit],[data-add]', function (e) {

                if (!formIsValid(id)) {
                    return false
                }

                if (formIsDuplicate()) {
                    return false;
                }

                var obj = $('#' + id + ' [data-form]').data('sgq');
                var formdata = $('#' + id + ' [data-form]').serializeFormToObjetc();

                if (!(typeof (obj) == 'undefined')) {
                    obj = atualizaValoresDoObjeto(obj, formdata);
                } else {
                    obj = null;
                    obj = atualizaValoresDoObjeto(obj, formdata);
                }

                Save(obj);
            });

            //Adicionar os dados no data-form
            $('#' + id).on('click', '[data-table-edit]', function (e) {

                var obj = $(this).parents('tr').data('sgq');

                apagaCampos(id);
                preencheCampos(id + ' [data-form]', '', obj);

                $('#' + id + ' [data-form]').data('sgq', obj);
                $('#' + id + ' [data-form]').addClass('alert alert-success');
                $('#' + id + ' [data-form] [data-action] [data-add]').addClass('hide');

                $('#' + id + ' [data-form] [data-action]').append('<button class="form-control btn btn-success" data-edit>Salvar</button>');
                $('#' + id + ' [data-form] [data-action]').append('<button class="form-control btn btn-danger" data-cancel>Cancelar</button>');

            });

            //Adicionar os dados no data-form
            $('#' + id).on('click', '[data-table-delete]', function (e) {

                var r = confirm("Deseja Excluir?");

                if (r == false) {
                    return false;
                }
                
                var obj = $(this).parents('tr').data('sgq');
                obj.IsActive = false;
                Save(obj);
            });

            $('#' + id).on('click', '[data-cancel]', function (e) {
                apagaCampos(id);
            });

            let formIsDuplicate = function () {
    
                var obj = $('#ParDCRotina [data-form]').data('sgq');
                var formdata = $('#ParDCRotina [data-form]').serializeFormToObjetc();

                if (!(typeof (obj) == 'undefined')) {
                    obj = atualizaValoresDoObjeto(obj, formdata);
                } else {
                    obj = null;
                    obj = atualizaValoresDoObjeto(obj, formdata);
                }

                let arrDepXRotinas = [];

                $('#ParDCRotina tbody tr').each(function () {
                    arrDepXRotinas.push($(this).data('sgq'));
                });
                
                let isDuplicate = arrDepXRotinas.filter((item) => {

                    return (item.Id != obj.Id &&
                        (item.NameRotina == obj.NameRotina ||
                        item.RotinaIntegracao.Id == obj.RotinaIntegracao_Id)) 
                }).length > 0;

                if (isDuplicate) {
                    openMessageModal("Alerta", "Já existe uma Rotina com essas informações cadastrada!")
                }

                return isDuplicate;

            }
        },
    };


</script>
